<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Rilke: Das Karussell - Atmospheric V2</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        body { margin: 0; background-color: #050510; overflow: hidden; font-family: sans-serif; }
        
        /* UI Overlay */
        #ui-layer {
            position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 15, 20, 0.98);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #fff; transition: opacity 1s ease-out; text-align: center;
        }
        h1 { font-weight: 100; letter-spacing: 8px; font-size: 2.5rem; text-transform: uppercase; margin-bottom: 0.5rem; }
        p { font-weight: 300; letter-spacing: 2px; color: #aab; max-width: 600px; line-height: 1.5; margin-bottom: 30px; }
        
        button {
            padding: 15px 40px; background: transparent;
            border: 1px solid #7df; color: #7df; font-size: 1.2rem;
            cursor: pointer; transition: all 0.3s; letter-spacing: 3px; text-transform: uppercase;
            border-radius: 4px;
        }
        button:hover { background: #7df; color: #000; box-shadow: 0 0 25px rgba(119, 221, 255, 0.6); }
        
        .hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h1>Das Karussell</h1>
        <p>A Spatial Poem by R.M. Rilke</p>
        <p style="font-size: 0.9rem; font-style: italic;">
            (Audio generated procedurally: Wind, Ambience, and Voice)
        </p>
        <button id="start-btn">Eintreten (Start)</button>
    </div>

    <script>
        let audioCtx;
        let isAudioInit = false;

        // --- 1. ATMOSPHERIC SOUND ENGINE (Wind & Music) ---
        function initAudioEngine() {
            if(isAudioInit) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();

            // A. WIND/PARK AMBIENCE (Pink Noise Generator)
            // Creates a gentle "shushing" sound like leaves or wind
            const bufferSize = 2 * audioCtx.sampleRate;
            const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                let white = Math.random() * 2 - 1;
                output[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = output[i];
                output[i] *= 3.5; 
            }
            let lastOut = 0;

            const windSource = audioCtx.createBufferSource();
            windSource.buffer = noiseBuffer;
            windSource.loop = true;
            
            // Filter the noise to sound like low wind
            const windFilter = audioCtx.createBiquadFilter();
            windFilter.type = 'lowpass';
            windFilter.frequency.value = 400; 

            const windGain = audioCtx.createGain();
            windGain.gain.value = 0.15; // Volume of wind

            windSource.connect(windFilter);
            windFilter.connect(windGain);
            windGain.connect(audioCtx.destination);
            windSource.start();

            // Animate wind filter (gentle breeze effect)
            setInterval(() => {
                if(audioCtx.state === 'running'){
                    const time = audioCtx.currentTime;
                    // Vary the filter frequency to simulate gusts
                    windFilter.frequency.setValueAtTime(300 + Math.sin(time * 0.5) * 100, time);
                }
            }, 100);


            // B. MUSICAL CHORDS (The "Gentle" Music)
            const tones = [130.81, 196.00, 261.63]; // C3, G3, C4 (C Major chord)
            tones.forEach(freq => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.value = freq;
                gain.gain.value = 0.03; // Very quiet background hum
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
            });

            isAudioInit = true;
        }

        // --- 2. GERMAN NARRATION ---
        function speakPoem() {
            if (!window.speechSynthesis) return;
            
            // Cancel any previous speaking to start fresh
            window.speechSynthesis.cancel();

            const poemLines = [
                "Mit einem Dach und seinem Schatten dreht sich eine kleine Weile der Bestand",
                "von bunten Pferden, alle aus dem Land, das lange zögert, eh es untergeht.",
                "Zwar manche sind an Wagen angespannt, doch alle haben Mut in ihren Mienen;",
                "ein böser roter Löwe geht mit ihnen und dann ein ganz weißer Elefant.",
                "Sogar ein Hirsch ist da, ganz wie im Wald, nur daß er einen Sattel trägt und drüber ein kleines blaues Mädchen aufgeschnallt.",
                "Und dann ein böser roter Löwe. Und dann ein ganz weißer Elefant.",
                "Und das geht hin und eilt sich, daß es endet, und kreist und dreht sich nur und hat kein Ziel.",
                "Ein Rot, ein Grün, ein Grau vorbeigesendet, ein kleines kaum begonnenes Profil.",
                "Und manchesmal ein Lächeln, hergewendet, ein seliges, das blendet und verschwendet an dieses atemlose blinde Spiel."
            ];

            let index = 0;
            function speakNext() {
                if(index >= poemLines.length) return;
                
                const utter = new SpeechSynthesisUtterance(poemLines[index]);
                utter.lang = 'de-DE'; // German
                utter.rate = 0.85;    // Slightly slow
                utter.pitch = 1.0;
                
                utter.onend = () => {
                    index++;
                    setTimeout(speakNext, 2000); // 2 second pause between stanzas
                };
                
                window.speechSynthesis.speak(utter);
            }
            speakNext();
        }

        // --- 3. FIREFLIES COMPONENT ---
        AFRAME.registerComponent('fireflies', {
            init: function() {
                for (let i = 0; i < 60; i++) {
                    let fly = document.createElement('a-entity');
                    let theta = Math.random() * Math.PI * 2;
                    let r = 6 + Math.random() * 12;
                    let x = r * Math.cos(theta);
                    let z = r * Math.sin(theta);
                    let y = 0.5 + Math.random() * 3;
                    
                    fly.setAttribute('geometry', {primitive: 'sphere', radius: 0.04});
                    fly.setAttribute('material', {color: '#ffffaa', shader: 'flat', opacity: 0.6});
                    fly.setAttribute('position', {x: x, y: y, z: z});
                    
                    let dur = 3000 + Math.random() * 2000;
                    fly.setAttribute('animation', {
                        property: 'position', to: `${x} ${y+1} ${z}`, 
                        dir: 'alternate', loop: true, dur: dur, easing: 'easeInOutSine'
                    });
                    this.el.appendChild(fly);
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('start-btn');
            const overlay = document.getElementById('ui-layer');
            
            btn.addEventListener('click', () => {
                overlay.classList.add('hidden');
                initAudioEngine();
                // Short delay before reading starts
                setTimeout(speakPoem, 1000);
                if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            });
        });
    </script>

    <a-scene background="color: #050510"
             fog="type: linear; color: #050510; near: 5; far: 40"
             shadow="type: basic">

        <a-assets>
            <a-mixin id="bounce" animation="property: position; dir: alternate; loop: true; easing: easeInOutSine"></a-mixin>
            <a-mixin id="text-style" text="font: kelsonsans; align: center; width: 6; color: #fff; opacity: 0.9"></a-mixin>
            <a-mixin id="panel-bg" geometry="primitive: plane; width: 6.5; height: 3" material="color: #000; opacity: 0.4; transparent: true"></a-mixin>
        </a-assets>

        <a-sky color="#050510"></a-sky>

        <a-entity light="type: ambient; color: #404050; intensity: 0.6"></a-entity>
        <a-entity position="0 3 0" light="type: point; color: #ffcc77; intensity: 0.8; distance: 20; castShadow: true"></a-entity>

        <a-plane rotation="-90 0 0" width="100" height="100" color="#111" shadow="receive: true"></a-plane>

        <a-entity fireflies></a-entity>

        <a-entity position="0 3 10" rotation="0 0 0">
            <a-entity mixin="panel-bg"></a-entity>
            <a-entity mixin="text-style" text="value: Mit einem Dach und seinem Schatten dreht\nsich eine kleine Weile der Bestand\nvon bunten Pferden, alle aus dem Land,\ndas lange zögert, eh es untergeht."></a-entity>
        </a-entity>

        <a-entity position="8.6 3 5" rotation="0 -60 0">
            <a-entity mixin="panel-bg"></a-entity>
            <a-entity mixin="text-style" text="value: Zwar manche sind an Wagen angespannt,\ndoch alle haben Mut in ihren Mienen;\nein böser roter Löwe geht mit ihnen\nund dann ein ganz weißer Elefant."></a-entity>
        </a-entity>

        <a-entity position="8.6 3 -5" rotation="0 -120 0">
            <a-entity mixin="panel-bg"></a-entity>
            <a-entity mixin="text-style" text="value: Sogar ein Hirsch ist da, ganz wie im Wald,\nnur daß er einen Sattel trägt und drüber\nein kleines blaues Mädchen aufgeschnallt."></a-entity>
        </a-entity>

        <a-entity position="0 3 -10" rotation="0 180 0">
            <a-entity mixin="panel-bg"></a-entity>
            <a-entity mixin="text-style" text="value: Und dann ein böser roter Löwe.\n\nUnd dann ein ganz weißer Elefant."></a-entity>
        </a-entity>

        <a-entity position="-8.6 3 -5" rotation="0 120 0">
            <a-entity mixin="panel-bg"></a-entity>
            <a-entity mixin="text-style" text="value: Und das geht hin und eilt sich, daß es endet,\nund kreist und dreht sich nur und hat kein Ziel.\nEin Rot, ein Grün, ein Grau vorbeigesendet,\nein kleines kaum begonnenes Profil."></a-entity>
        </a-entity>

        <a-entity position="-8.6 3 5" rotation="0 60 0">
            <a-entity mixin="panel-bg"></a-entity>
            <a-entity mixin="text-style" text="value: Und manchesmal ein Lächeln, hergewendet,\nein seliges, das blendet und verschwendet\nan dieses atemlose blinde Spiel."></a-entity>
        </a-entity>


        <a-entity position="0 0 0" animation="property: rotation; to: 0 -360 0; loop: true; dur: 25000; easing: linear">
            
            <a-cylinder height="5" radius="0.3" color="#444"></a-cylinder>
            <a-cone position="0 4.5 0" radius-bottom="6" radius-top="0" height="2.5" color="#223" shadow="cast: true"></a-cone>
            <a-cylinder position="0 0.2 0" radius="5.5" height="0.4" color="#111"></a-cylinder>

            <a-entity rotation="0 0 0">
                <a-entity position="3.5 1 0" mixin="bounce" animation="dur: 1500; from: 3.5 1 0; to: 3.5 1.3 0">
                    <a-box color="#800" width="1" height="1.2" depth="1.5" shadow="cast: true"></a-box>
                </a-entity>
            </a-entity>

            <a-entity rotation="0 72 0">
                <a-entity position="3.5 1 0" mixin="bounce" animation="dur: 2500">
                    <a-sphere radius="1.2" color="#eee" shadow="cast: true"></a-sphere>
                </a-entity>
            </a-entity>

            <a-entity rotation="0 144 0">
                <a-entity position="3.5 1 0" mixin="bounce" animation="dur: 1200">
                    <a-cylinder radius="0.3" height="1.5" color="#2e8b57"></a-cylinder>
                </a-entity>
            </a-entity>

            <a-entity rotation="0 216 0">
                <a-entity position="3.5 1 0" mixin="bounce" animation="dur: 1800">
                    <a-cylinder radius="0.35" height="1.2" color="#5d4037"></a-cylinder>
                    <a-sphere position="0 1.0 0" radius="0.5" color="#00bfff" emissive="#00bfff" emissive-intensity="0.3"></a-sphere>
                </a-entity>
            </a-entity>

            <a-entity rotation="0 288 0">
                <a-entity position="3.5 1 0" mixin="bounce" animation="dur: 1300">
                    <a-cylinder radius="0.3" height="1.5" color="#888"></a-cylinder>
                </a-entity>
            </a-entity>

        </a-entity>

        <a-entity position="0 1.6 15">
            <a-camera look-controls wasd-controls="acceleration: 100">
                <a-cursor color="#fff" scale="0.5 0.5 0.5" opacity="0.5"></a-cursor>
            </a-camera>
        </a-entity>

    </a-scene>
</body>
</html>
