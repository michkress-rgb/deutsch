<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Das R√§tsel der Winterkrone - Fixed Up/Down + Locks</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@500;700&display=swap');

    :root{
      --bg-sky: #0b2a52;
      --bg-sky2:#113b76;
      --bg-panel:#fff7ef;
      --bg-panel2:#fff;
      --text-main:#1b1b1b;

      --accent-red:#d42426;
      --accent-green:#2e8b57;
      --accent-gold:#caa100;
      --accent-blue:#1a66cc;

      --border:#d9c7b8;
      --shadow: rgba(0,0,0,0.15);
    }

    *{margin:0;padding:0;box-sizing:border-box;}
    html, body { height: 100%; }
    body{
      font-family:'Cormorant Garamond', serif;
      font-size: 18px;
      color: var(--text-main);
      background: linear-gradient(180deg, var(--bg-sky) 0%, var(--bg-sky2) 100%);
      overflow:auto;
    }

    .game-wrapper{
      display:grid;
      grid-template-columns: 360px 1fr 360px;
      gap: 16px;
      max-width: 1800px;
      margin: 12px auto;
      padding: 12px;
      align-items: start;
    }

    .panel{
      background: linear-gradient(180deg, var(--bg-panel2), var(--bg-panel));
      border: 2px solid var(--border);
      box-shadow: 0 10px 25px var(--shadow);
      border-radius: 14px;
      padding: 16px;
      display:flex;
      flex-direction:column;
      overflow: hidden;
    }

    .panel-scroll{
      overflow:auto;
      padding-right: 6px;
    }

    .panel-header{
      font-family:'Cinzel', serif;
      font-weight:700;
      color: var(--accent-red);
      border-bottom: 2px dashed var(--border);
      padding-bottom: 8px;
      margin-bottom: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size: 1.25em;
    }

    .help-btn{
      border: 2px solid var(--accent-blue);
      background: #eaf2ff;
      color: var(--accent-blue);
      width: 32px; height: 32px;
      border-radius: 10px;
      cursor:pointer;
      font-family:'Cinzel', serif;
      font-weight:700;
    }

    .map-wrapper{ margin-bottom: 12px; }
    .map-controls{ display:flex; gap:8px; justify-content:center; margin-bottom:8px; flex-wrap:wrap; }
    .lvl-btn{
      background: #f2efe9;
      border: 2px solid var(--border);
      color:#444;
      padding: 6px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-family:'Cinzel', serif;
      font-size: 0.95em;
    }
    .lvl-btn.active{
      background: #e6fff1;
      border-color: var(--accent-green);
      color: var(--accent-green);
    }

    .map-container{
      height: 240px;
      background: #ffffffcc;
      border: 2px solid var(--border);
      border-radius: 12px;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap: 6px;
      padding: 10px;
    }

    .map-node{
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 1.4em;
      border: 2px dashed transparent;
      user-select:none;
    }
    .map-node.fog{ opacity:0; pointer-events:none; }
    .map-node.seen{
      background: #fff;
      border-color: #e8dccf;
      color:#777;
      font-size: 1.0em;
    }
    .map-node.visited{
      background: #fff7d6;
      border-color: #f0d27c;
      cursor:pointer;
    }
    .map-node.active{
      background: #e6fff1;
      border-color: var(--accent-green);
      box-shadow: 0 0 0 3px #d9ffe9 inset;
    }

    .room-title{
      font-family:'Cinzel', serif;
      font-size: 2.2em;
      color: var(--accent-red);
      text-align:center;
      margin-bottom: 6px;
    }
    .room-coords{
      text-align:center;
      color:#666;
      font-family: system-ui, sans-serif;
      font-size: 0.95em;
      margin-bottom: 10px;
    }
    .room-visual{
      height: 180px;
      border-radius: 14px;
      border: 2px solid var(--border);
      background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f5fbff 45%, #e7f3ff 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 5.2em;
      margin-bottom: 12px;
      position:relative;
      overflow:hidden;
    }

    .room-desc{
      font-size: 1.15em;
      line-height: 1.55;
      margin-bottom: 10px;
    }
    .exits-line{
      background: #fff;
      border: 2px dashed #e8dccf;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 12px;
      color:#444;
      font-size: 1.0em;
    }

    button{
      font-family:'Cinzel', serif;
      border-radius: 14px;
      border: 2px solid var(--border);
      padding: 12px 12px;
      cursor:pointer;
      background: #fff;
      color:#222;
    }
    button:hover:not(:disabled){ filter: brightness(0.97); }
    button:disabled{ opacity:0.5; cursor:not-allowed; }

    .action-btn{
      width: 100%;
      text-align:left;
      border-color: #e8dccf;
      background: #ffffff;
      margin-bottom: 10px;
    }

    .manual-controls{
      display:flex;
      gap: 8px;
      align-items: center;
      margin: 10px 0 12px;
      flex-wrap: wrap;
    }
    select, input{
      border-radius: 12px;
      border: 2px solid var(--border);
      padding: 10px;
      font-size: 1em;
      background: #fff;
      color:#222;
      font-family: system-ui, sans-serif;
    }
    .go-btn{
      border-color: var(--accent-blue);
      background: #eaf2ff;
      color: var(--accent-blue);
      font-weight: 700;
    }

    .d-pad-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 6px;
    }
    .vert-controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .inventory-title{
      font-family:'Cinzel', serif;
      color: var(--accent-green);
      margin: 10px 0 6px;
      font-weight: 700;
    }
    .inventory-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .inv-item{
      border: 2px dashed #e8dccf;
      border-radius: 14px;
      min-height: 70px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      background:#fff;
      padding: 10px;
    }
    .inv-item.filled{
      border-style: solid;
      border-color: #f0d27c;
      background:#fff7d6;
    }
    .inv-item .icon{ font-size: 1.6em; }
    .inv-item span{ font-size: 0.9em; text-align:center; margin-top: 4px; }

    .inventory-list{
      margin-top: 10px;
      padding: 10px;
      background:#fff;
      border: 2px dashed #e8dccf;
      border-radius: 12px;
      font-family: system-ui, sans-serif;
      font-size: 0.95em;
    }
    .inventory-list ul{ padding-left: 18px; }
    .inventory-list li{ margin: 4px 0; }

    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 999;
    }
    .modal-box{
      background:#fff;
      border-radius: 16px;
      border: 3px solid #f0d27c;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      width: min(760px, 95vw);
      max-height: 90vh;
      overflow:auto;
      padding: 22px;
      position:relative;
    }
    .modal-close{
      position:absolute; right: 14px; top: 10px;
      font-size: 28px;
      cursor:pointer;
      color: var(--accent-red);
      font-family: system-ui, sans-serif;
    }

    .snowflake{
      position: fixed;
      top: -20px;
      color: rgba(255,255,255,0.9);
      pointer-events:none;
      animation: fall linear infinite;
      z-index: 1;
      text-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    @keyframes fall{
      to { transform: translateY(120vh); }
    }

    @media (max-width: 1100px){
      .game-wrapper{ grid-template-columns: 1fr; }
      .map-container{ height: 260px; }
    }
  </style>
</head>

<body>

  <div id="help-overlay" class="overlay" style="display:flex;">
    <div class="modal-box">
      <div class="modal-close" onclick="closeHelp()">√ó</div>
      <h2 style="font-family:'Cinzel'; color: var(--accent-red); text-align:center; margin-bottom: 6px;">
        Winterkrone ‚Äî Steuerung (Fix)
      </h2>
      <p style="text-align:center; font-family:system-ui,sans-serif; color:#333; margin-bottom:14px;">
        ‚¨Ü/‚¨á gehen nur dort, wo es wirklich eine Treppe gibt (z.B. Bibliothek ‚Üí Turmspitze).
        Der Keller ist von der K√ºche aus ‚¨á erreichbar (nach Aufschlie√üen).
      </p>
      <div style="font-family:system-ui,sans-serif; color:#333; line-height:1.5;">
        <b>Tasten:</b> WASD = N/S/W/O, Q = Hoch (‚¨Ü), E = Runter (‚¨á)
      </div>
      <button class="action-btn" onclick="closeHelp()" style="margin-top:14px; text-align:center; border-color: var(--accent-green);">
        Los geht‚Äôs
      </button>
    </div>
  </div>

  <div id="msg-modal" class="overlay">
    <div class="modal-box" onclick="event.stopPropagation()">
      <h3 id="msg-title" style="font-family:'Cinzel'; color: var(--accent-red); margin-bottom: 10px;"></h3>
      <p id="msg-text" style="font-family:system-ui,sans-serif; line-height:1.5;"></p>
      <button class="action-btn" onclick="closeMsg()" style="text-align:center; margin-top: 14px;">Weiter</button>
    </div>
  </div>

  <div id="puzzle-modal" class="overlay">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-close" onclick="closePuzzle()">√ó</div>
      <h2 style="font-family:'Cinzel'; color: var(--accent-blue);">R√§tsel</h2>
      <p id="puzzle-text" style="margin: 10px 0 12px; font-family:system-ui,sans-serif;"></p>
      <input id="puzzle-answer" type="text" placeholder="Antwort..." autocomplete="off" />
      <button class="action-btn" onclick="submitPuzzleAnswer()" style="text-align:center; margin-top: 12px; border-color: var(--accent-blue);">L√∂sen</button>
    </div>
  </div>

  <div class="game-wrapper">

    <div class="panel">
      <div class="panel-header">Karte</div>
      <div class="map-wrapper">
        <div class="map-controls">
          <button class="lvl-btn" id="lvl-btn-m1" onclick="player.mapLevel=-1; updateUI()">Keller</button>
          <button class="lvl-btn" id="lvl-btn-0"  onclick="player.mapLevel=0; updateUI()">Erdgeschoss</button>
          <button class="lvl-btn" id="lvl-btn-1"  onclick="player.mapLevel=1; updateUI()">Turm</button>
        </div>
        <div class="map-container" id="mini-map"></div>
        <div style="margin-top:8px; font-family:system-ui,sans-serif; color:#555; font-size:0.9em;">
          Klick auf besuchte R√§ume = Schnellreise
        </div>
      </div>

      <div class="inventory-title">Inventar</div>
      <div class="inventory-grid" id="inventory-grid"></div>

      <div class="inventory-list" id="inventory-list">
        <b>Du tr√§gst:</b>
        <ul id="inventory-list-ul"></ul>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        Umgebung
        <button class="help-btn" onclick="openHelp()">?</button>
      </div>

      <div class="panel-scroll">
        <h2 id="room-name" class="room-title">Schlosshof</h2>
        <div id="room-coords" class="room-coords">Ebene 0</div>
        <div id="room-visual" class="room-visual"><span id="room-icon">üè∞</span></div>
        <div id="room-desc" class="room-desc"></div>
        <div id="room-exits" class="exits-line"></div>

        <div id="interaction-area" style="margin-top: 8px;"></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">Steuerung</div>

      <div class="manual-controls">
        <label style="font-family:system-ui,sans-serif; color:#444;">Richtung:</label>
        <select id="dir-select" aria-label="Richtung w√§hlen">
          <option value="N">N (Norden)</option>
          <option value="S">S (S√ºden)</option>
          <option value="O">O (Osten)</option>
          <option value="W">W (Westen)</option>
          <option value="U">‚¨Ü Hoch</option>
          <option value="D">‚¨á Runter</option>
        </select>
        <button class="go-btn" onclick="manualMove()">Los</button>

        <input id="cmd-input" type="text" placeholder="Tippe: n/s/o/w/u/d" style="flex:1; min-width: 220px;">
        <button class="go-btn" onclick="runCommand()">OK</button>
      </div>

      <button class="action-btn" onclick="explore()" style="border-color: var(--accent-gold);">
        üîé Suchen / Untersuchen
      </button>

      <div class="d-pad-grid">
        <div></div>
        <button id="btn-n" onclick="move('N')">N</button>
        <div></div>

        <button id="btn-w" onclick="move('W')">W</button>
        <button onclick="explore()" title="Suchen" style="border-color: var(--accent-gold);">üîé</button>
        <button id="btn-o" onclick="move('O')">O</button>

        <div></div>
        <button id="btn-s" onclick="move('S')">S</button>
        <div></div>
      </div>

      <div class="vert-controls">
        <button id="btn-u" onclick="move('U')">‚¨Ü HOCH</button>
        <button id="btn-d" onclick="move('D')">‚¨á RUNTER</button>
      </div>

      <div style="margin-top: 14px; font-family:system-ui,sans-serif; color:#555; font-size:0.95em;">
        Q = Hoch, E = Runter (zus√§tzlich zu Buttons).
      </div>
    </div>

  </div>

  <div id="snow-container"></div>

  <script>
    const player = {
      room: 'courtyard',
      inventory: [],
      flags: {},
      visited: ['courtyard'],
      mapLevel: 0
    };

    const items = {
      rusty_key:  { name:'Rostiger Schl√ºssel', icon:'üóùÔ∏è', desc:'√ñffnet die Kellert√ºr.' },
      silver_key: { name:'Silberschl√ºssel', icon:'üóùÔ∏è', desc:'√ñffnet die Bibliothekst√ºr.' },
      crowbar:    { name:'Brecheisen', icon:'üîß', desc:'F√ºr Kisten und lose Steine.' },
      scroll:     { name:'Notiz', icon:'üìú', desc:'Rot13: "Vjre fbg nyyvrf orv anzra araara: Nyoerpug"' },
      ruby:       { name:'Rubin', icon:'üíé', desc:'Warm wie Feuer.', type:'gem' },
      sapphire:   { name:'Saphir', icon:'üíé', desc:'Kalt wie Eis.', type:'gem' },
      emerald:    { name:'Smaragd', icon:'üíé', desc:'Tiefgr√ºn und lebendig.', type:'gem' }
    };

    // IMPORTANT FIX: lockedExits now includes "to"
    const rooms = {
      courtyard: {
        name:'Schlosshof', visual:'üè∞', coords:{x:2,y:2,z:0},
        desc:'Lichterketten glitzern am Tor. Der Brunnen ist gefroren ‚Äì aber darunter schimmert etwas.',
        exits:{ N:'great_hall', O:'kitchen', W:'library_entrance' }
      },
      great_hall: {
        name:'Gro√üe Halle', visual:'üïØÔ∏è', coords:{x:2,y:1,z:0},
        desc:'Staub tanzt im Kerzenlicht. Unter einem Teller steckt etwas Metallisches.',
        exits:{ S:'courtyard', N:'throne_room' },
        search:{ give:'rusty_key', msg:'Du findest einen rostigen Schl√ºssel unter dem Teller.' }
      },
      kitchen: {
        name:'Alte K√ºche', visual:'üç≥', coords:{x:3,y:2,z:0},
        desc:'Es riecht nach Zimt und‚Ä¶ Abenteuer. Die Kellert√ºr ist direkt hier.',
        exits:{ W:'courtyard', D:'cellar' },
        lockedExits:{ D:{ key:'rusty_key', to:'cellar', msg:'Die Kellert√ºr ist abgeschlossen.' } },
        search:{ give:'crowbar', msg:'Im Ofen liegt ein Brecheisen. Praktisch!' }
      },
      cellar: {
        name:'Weinkeller', visual:'üç∑', coords:{x:3,y:2,z:-1},
        desc:'Hier unten ist es k√ºhl. Ein Fass klingt hohl. Eine Wand wirkt locker.',
        exits:{ U:'kitchen' },
        interact:[
          {label:'Hohles Fass √∂ffnen', req:'crowbar', result:'get_ruby', msg:'Du findest den Rubin im Fassboden!'},
          {label:'Lockere Wand pr√ºfen', req:'crowbar', action:'open_dungeon', msg:'Du √∂ffnest einen Gang ins Verlies!'}
        ]
      },
      throne_room: {
        name:'Thronsaal', visual:'üëë', coords:{x:2,y:0,z:0},
        desc:'Der Thron wartet. In der Krone fehlen drei Edelsteine.',
        exits:{ S:'great_hall' },
        interact:[{label:'Krone zusammensetzen', action:'win_check'}]
      },
      library_entrance: {
        name:'Turmeingang', visual:'üö™', coords:{x:1,y:2,z:0},
        desc:'Eine T√ºr mit Silberbeschl√§gen. Dahinter: B√ºcher und Geheimnisse.',
        exits:{ O:'courtyard', W:'library' },
        lockedExits:{ W:{ key:'silver_key', to:'library', msg:'Die T√ºr ist verschlossen. Silberschl√ºssel ben√∂tigt.' } }
      },
      library: {
        name:'Bibliothek', visual:'üìö', coords:{x:0,y:2,z:0},
        desc:'Zwischen den Regalen blinkt eine Vitrine. Eine Treppe f√ºhrt nach oben.',
        exits:{ O:'library_entrance', U:'tower_top' },
        puzzle:{ q:'Zahlenfolge: 2, 4, 8, 16 ‚Ä¶? (N√§chste Zahl)', a:'32', reward:'sapphire' }
      },
      tower_top: {
        name:'Turmspitze', visual:'üåü', coords:{x:0,y:2,z:1},
        desc:'Du siehst festliche Lichter √ºber dem Land. Ein Pergament liegt bereit.',
        exits:{ D:'library' },
        search:{ give:'scroll', msg:'Du findest eine verschl√ºsselte Notiz.' }
      },
      dungeon: {
        name:'Verlies', visual:'‚õìÔ∏è', coords:{x:3,y:1,z:-1},
        desc:'Ein alter Gang, aber du bist sicher. Weiter geht es zur Gruft.',
        exits:{ N:'crypt', S:'cellar' }
      },
      crypt: {
        name:'Familiengruft', visual:'‚ö∞Ô∏è', coords:{x:3,y:0,z:-1},
        desc:'Ein gr√ºnes Leuchten: der Smaragd! Eine Inschrift will eine Antwort.',
        exits:{ S:'dungeon' },
        puzzle:{ q:'Die Inschrift: "Wie hei√üt der K√∂nig?" (Tipp: Notiz + Rot13)', a:'ALBRECHT', reward:'emerald' }
      }
    };

    function init(){
      createSnow();
      updateUI();

      document.addEventListener('keydown', (e) => {
        if (isModalOpen()) return;
        const k = e.key.toLowerCase();

        if(k === 'w') move('N');
        if(k === 's') move('S');
        if(k === 'a') move('W');
        if(k === 'd') move('O');

        // Up/Down supported
        if(k === 'q') move('U');
        if(k === 'e') move('D');

        if(k === 'arrowup') move('N');
        if(k === 'arrowdown') move('S');
        if(k === 'arrowleft') move('W');
        if(k === 'arrowright') move('O');

        if(k === 'enter') {
          const inp = document.getElementById('cmd-input');
          if (document.activeElement === inp) runCommand();
        }
      });

      document.getElementById('puzzle-answer').addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') submitPuzzleAnswer();
      });

      document.getElementById('cmd-input').addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') runCommand();
      });
    }

    function isModalOpen(){
      const ids = ['help-overlay','msg-modal','puzzle-modal'];
      return ids.some(id => getComputedStyle(document.getElementById(id)).display === 'flex');
    }

    function createSnow(){
      const c = document.getElementById('snow-container');
      c.innerHTML = '';
      for(let i=0;i<40;i++){
        const s = document.createElement('div');
        s.className='snowflake';
        s.textContent = (Math.random() < 0.2) ? '‚ú¶' : '‚ùÑ';
        s.style.left = (Math.random()*100)+'vw';
        s.style.fontSize = (10 + Math.random()*16)+'px';
        s.style.animationDuration = (5 + Math.random()*6)+'s';
        s.style.opacity = (0.3 + Math.random()*0.6);
        c.appendChild(s);
      }
    }

    function updateUI(){
      const r = rooms[player.room];

      document.getElementById('room-name').innerText = r.name;
      document.getElementById('room-coords').innerText = `Ebene ${r.coords.z} | Sektor ${r.coords.x}-${r.coords.y}`;
      document.getElementById('room-icon').innerText = r.visual;
      document.getElementById('room-desc').innerText = r.desc;

      const labels = {N:'Norden', S:'S√ºden', O:'Osten', W:'Westen', U:'Hoch (‚¨Ü)', D:'Runter (‚¨á)'};
      const parts = [];
      ['N','S','O','W','U','D'].forEach(dir=>{
        if(r.exits && r.exits[dir]) parts.push(labels[dir]);
        else if(r.lockedExits && r.lockedExits[dir]) parts.push(labels[dir] + ' (üîí)');
      });
      document.getElementById('room-exits').innerText =
        parts.length ? ('Ausg√§nge: ' + parts.join(', ')) : 'Ausg√§nge: Keine sichtbaren.';

      const btnMap = {n:'N', s:'S', o:'O', w:'W', u:'U', d:'D'};
      Object.keys(btnMap).forEach(k=>{
        const el = document.getElementById('btn-'+k);
        if(!el) return;
        const dir = btnMap[k];
        const has = (r.exits && r.exits[dir]) || (r.lockedExits && r.lockedExits[dir]);
        el.disabled = !has;
      });

      const area = document.getElementById('interaction-area');
      area.innerHTML = '';

      if(r.puzzle && !player.flags[r.puzzle.reward + '_got']){
        const b = document.createElement('button');
        b.className = 'action-btn';
        b.textContent = 'üß© R√§tsel ansehen';
        b.onclick = ()=> openPuzzleModal(r.puzzle);
        area.appendChild(b);
      }

      if(r.search){
        const b = document.createElement('button');
        b.className = 'action-btn';
        b.textContent = 'üîé Gr√ºndlich suchen';
        b.onclick = ()=> explore();
        area.appendChild(b);
      }

      if(r.interact){
        r.interact.forEach(act=>{
          if(act.action === 'open_dungeon' && rooms.cellar.exits.N) return;
          if(act.result === 'get_ruby' && player.inventory.includes('ruby')) return;
          const b = document.createElement('button');
          b.className = 'action-btn';
          b.textContent = '‚öôÔ∏è ' + act.label;
          b.onclick = ()=> handleInteract(act);
          area.appendChild(b);
        });
      }

      renderMap(player.mapLevel);
      renderInventory();
    }

    function manualMove(){
      const dir = document.getElementById('dir-select').value;
      move(dir);
    }

    function runCommand(){
      const inp = document.getElementById('cmd-input');
      const raw = (inp.value || '').trim().toLowerCase();
      if(!raw) return;

      const map = {
        n:'N', nord:'N',
        s:'S', sued:'S', s√ºd:'S',
        o:'O', ost:'O',
        w:'W', west:'W',
        u:'U', up:'U', hoch:'U',
        d:'D', down:'D', runter:'D'
      };

      const dir = map[raw];
      inp.value = '';
      if(dir) move(dir);
      else showMsg('Befehl', 'Unbekannt. Nutze n/s/o/w/u/d (oder nord/sued/ost/west/hoch/runter).');
    }

    // KEY FIX: unlock uses lock.to, and converts lock into normal exit
    function move(dir){
      const r = rooms[player.room];

      if(r.lockedExits && r.lockedExits[dir]){
        const lock = r.lockedExits[dir];
        if(player.inventory.includes(lock.key)){
          const target = lock.to || (r.exits ? r.exits[dir] : null);
          if(!target || !rooms[target]){
            showMsg('Bug', 'Diese T√ºr hat kein g√ºltiges Ziel (to/exits).');
            return;
          }

          // convert locked exit -> normal exit
          r.exits = r.exits || {};
          r.exits[dir] = target;
          delete r.lockedExits[dir];

          showMsg('T√ºr ge√∂ffnet', 'Der Schl√ºssel passt! Du gehst hinunter/hin√ºber.');
          player.room = target;
          visitRoom();
        } else {
          showMsg('Verschlossen', lock.msg);
        }
        return;
      }

      if(r.exits && r.exits[dir]){
        const target = r.exits[dir];
        player.room = target;
        visitRoom();
        return;
      }

      if(dir === 'U' || dir === 'D'){
        showMsg('Keine Treppe', 'Hier gibt es keine Treppe nach oben/unten.');
        return;
      }

      showMsg('Kein Ausgang', 'Dort geht es nicht weiter.');
    }

    function fastTravel(targetRoom){
      if(targetRoom === player.room) return;
      player.room = targetRoom;
      visitRoom(false);
    }

    function visitRoom(countVisited = true){
      if(countVisited && !player.visited.includes(player.room)){
        player.visited.push(player.room);
      }
      // IMPORTANT: map level always tracks current room z
      player.mapLevel = rooms[player.room].coords.z;
      updateUI();
    }

    function explore(){
      const r = rooms[player.room];

      if(r.search && r.search.give){
        const id = r.search.give;
        if(!player.inventory.includes(id)){
          player.inventory.push(id);
          showMsg('Gefunden!', r.search.msg);
          updateUI();
          return;
        }
        showMsg('Schon erledigt', 'Hier hast du schon alles N√ºtzliche gefunden.');
        return;
      }

      // Courtyard silver key after visiting great hall
      if(player.room === 'courtyard' && player.visited.includes('great_hall') && !player.inventory.includes('silver_key')){
        player.inventory.push('silver_key');
        showMsg('Gefunden!', 'Im Schnee glitzert ein Silberschl√ºssel.');
        updateUI();
        return;
      }

      showMsg('Suchen', 'Du findest nichts Neues.');
    }

    function handleInteract(act){
      if(act.req && !player.inventory.includes(act.req)){
        showMsg('Fehlt', 'Du brauchst: ' + items[act.req].name);
        return;
      }

      if(act.action === 'open_dungeon'){
        rooms.cellar.exits.N = 'dungeon';
        showMsg('Gang frei!', act.msg || 'Ein neuer Gang ist offen.');
        updateUI();
        return;
      }

      if(act.result === 'get_ruby'){
        if(!player.inventory.includes('ruby')) player.inventory.push('ruby');
        showMsg('Edelstein!', act.msg || 'Du findest einen Rubin.');
        updateUI();
        return;
      }

      if(act.action === 'win_check'){
        const ok = ['ruby','sapphire','emerald'].every(i => player.inventory.includes(i));
        if(ok){
          document.body.innerHTML = `
            <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:30px;">
              <div style="background:#fff;border:3px solid #f0d27c;border-radius:18px;padding:28px;max-width:800px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.25);">
                <h1 style="font-family:Cinzel;color:#d42426;font-size:3.2em;margin-bottom:10px;">Krone vollendet</h1>
                <p style="font-family:system-ui,sans-serif;font-size:1.2em;color:#333;margin-bottom:16px;">
                  Das Schloss leuchtet festlich. Du hast die Winterkrone wiederhergestellt.
                </p>
                <button onclick="location.reload()" style="padding:14px 18px;border-radius:14px;border:2px solid #2e8b57;background:#e6fff1;font-family:Cinzel;font-weight:700;cursor:pointer;">
                  Nochmal spielen
                </button>
              </div>
            </div>
          `;
        } else {
          showMsg('Noch nicht', 'Dir fehlen noch Edelsteine.');
        }
      }
    }

    let activePuzzle = null;
    function openPuzzleModal(p){
      activePuzzle = p;
      document.getElementById('puzzle-text').innerText = p.q;
      document.getElementById('puzzle-answer').value = '';
      document.getElementById('puzzle-modal').style.display = 'flex';
      document.getElementById('puzzle-answer').focus();
    }
    function closePuzzle(){
      document.getElementById('puzzle-modal').style.display = 'none';
      activePuzzle = null;
    }
    function submitPuzzleAnswer(){
      if(!activePuzzle) return;
      const ans = document.getElementById('puzzle-answer').value.trim().toUpperCase();
      closePuzzle();

      if(ans === activePuzzle.a){
        const reward = activePuzzle.reward;
        if(!player.inventory.includes(reward)) player.inventory.push(reward);
        player.flags[reward + '_got'] = true;
        showMsg('Richtig!', 'Du erh√§ltst: ' + items[reward].name);
        updateUI();
      } else {
        showMsg('Fast!', 'Das war nicht richtig. Versuch es sp√§ter nochmal.');
      }
    }

    function renderMap(level){
      const map = document.getElementById('mini-map');

      const btnID = level === -1 ? 'lvl-btn-m1' : 'lvl-btn-' + level;
      document.querySelectorAll('.lvl-btn').forEach(b=> b.classList.remove('active'));
      const activeBtn = document.getElementById(btnID);
      if(activeBtn) activeBtn.classList.add('active');

      map.innerHTML = '';

      for(let y=0;y<5;y++){
        for(let x=0;x<5;x++){
          const node = document.createElement('div');
          node.className='map-node fog';

          const roomKey = Object.keys(rooms).find(k=>{
            const c = rooms[k].coords;
            return c.x===x && c.y===y && c.z===level;
          });

          if(roomKey){
            const rr = rooms[roomKey];
            const isVisited = player.visited.includes(roomKey);
            const isCurrent = player.room === roomKey;

            let neighborVisited = false;
            if(!isVisited){
              const neighbors = Object.keys(rooms).filter(k=>{
                const c = rooms[k].coords;
                if(c.z !== level) return false;
                return (Math.abs(c.x-x)+Math.abs(c.y-y))===1;
              });
              neighborVisited = neighbors.some(nk => player.visited.includes(nk));
            }

            if(isCurrent){
              node.className='map-node active';
              node.textContent = rr.visual;
            } else if(isVisited){
              node.className='map-node visited';
              node.textContent = rr.visual;
              node.title = rr.name + ' (Schnellreise)';
              node.onclick = ()=> fastTravel(roomKey);
            } else if(neighborVisited){
              node.className='map-node seen';
              node.textContent='?';
            }
          }

          map.appendChild(node);
        }
      }
    }

    function renderInventory(){
      const grid = document.getElementById('inventory-grid');
      const listUl = document.getElementById('inventory-list-ul');

      grid.innerHTML = '';
      listUl.innerHTML = '';

      const inv = player.inventory.slice();

      inv.forEach(id=>{
        const it = items[id];
        const d = document.createElement('div');
        d.className = 'inv-item filled';
        d.innerHTML = `<div class="icon">${it.icon}</div><span>${it.name}</span>`;
        d.onclick = ()=> showMsg(it.name, it.desc);
        grid.appendChild(d);

        const li = document.createElement('li');
        li.textContent = it.name;
        listUl.appendChild(li);
      });

      for(let i=inv.length;i<8;i++){
        const d = document.createElement('div');
        d.className = 'inv-item';
        d.innerHTML = `<div class="icon">üéÅ</div><span>Leer</span>`;
        grid.appendChild(d);
      }

      if(inv.length === 0){
        const li = document.createElement('li');
        li.textContent = 'Noch nichts‚Ä¶ (Tipp: In der Gro√üen Halle suchen.)';
        listUl.appendChild(li);
      }
    }

    function openHelp(){ document.getElementById('help-overlay').style.display = 'flex'; }
    function closeHelp(){ document.getElementById('help-overlay').style.display = 'none'; }
    function showMsg(t,m){
      document.getElementById('msg-title').innerText = t;
      document.getElementById('msg-text').innerText = m;
      document.getElementById('msg-modal').style.display = 'flex';
    }
    function closeMsg(){ document.getElementById('msg-modal').style.display = 'none'; }

    init();
  </script>
</body>
</html>
