<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Das R√§tsel der Winterkrone - Extended</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@500;700&display=swap');
        
        :root {
            /* Palette */
            --bg-dark: #0b1026; 
            --bg-panel: #1a0505; 
            --text-main: #f0f4f8; /* Brighter white */
            --accent-red: #ff3333; 
            --accent-green: #2d8a56; 
            --accent-gold: #ffd700; 
            --ghost-purple: #9d8cff; 
            --border-color: #5c1818; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            /* 1) BIGGER FONT */
            font-family: 'Cormorant Garamond', serif;
            font-size: 18px; 
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            background-image: linear-gradient(to bottom, #050a14 0%, #111936 100%);
            user-select: none;
        }

        /* --- LAYOUT --- */
        .game-wrapper {
            display: grid;
            grid-template-columns: 350px 1fr 350px; /* Wider side panels */
            grid-template-rows: 1fr auto; /* Added row for history */
            gap: 20px;
            max-width: 1800px;
            height: 98vh;
            margin: 1vh auto;
            padding: 10px 20px;
            position: relative;
            z-index: 2;
        }

        .panel {
            background: var(--bg-panel);
            border: 4px double var(--border-color);
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .panel-header {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.4em; /* Bigger */
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* --- MAP SYSTEM --- */
        .map-wrapper { position: relative; margin-bottom: 15px; }
        .map-controls { display: flex; gap: 5px; margin-bottom: 5px; justify-content: center; }
        .lvl-btn { 
            background: #2a1a1a; border: 1px solid var(--border-color); color: #aaa; 
            padding: 5px 10px; font-size: 1em; cursor: pointer; font-family: 'Cinzel';
        }
        .lvl-btn.active { background: var(--accent-green); color: white; border-color: var(--accent-gold); }

        .map-container {
            height: 220px; /* Bigger map */
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--border-color);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 4px;
            padding: 5px;
        }
        
        .map-node {
            background: transparent; border-radius: 4px; display: flex; align-items: center; justify-content: center;
            font-size: 1.4em; color: #555; position: relative; transition: all 0.3s;
        }
        .map-node.visited { background: #3d1e1e; border: 1px solid #5c2b2b; cursor: pointer; } 
        .map-node.visited:hover { background: #5c2b2b; border-color: var(--accent-gold); }
        .map-node.fog { opacity: 0; pointer-events: none; }
        .map-node.seen { background: rgba(255,255,255,0.05); color: #666; font-size: 1em; border: 1px dashed #444; }
        .map-node.active { background: var(--accent-gold); color: #000; box-shadow: 0 0 15px var(--accent-gold); z-index: 2; border-color: white; cursor: default;}

        .lock-icon {
            position: absolute; bottom: -4px; right: -4px; font-size: 0.7em; 
            background: #000; border-radius: 50%; padding: 3px; color: var(--accent-red); border: 1px solid var(--accent-red);
        }

        /* --- CONTROLS --- */
        .d-pad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .vert-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }

        button {
            background: #2a1a1a; border: 1px solid var(--border-color); color: var(--text-main);
            padding: 15px; font-family: 'Cinzel', serif; cursor: pointer; transition: all 0.2s; font-size: 1.1em; /* Bigger */
            box-shadow: 0 4px 0 rgba(0,0,0,0.5); border-radius: 6px;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button:hover:not(:disabled) {
            background: var(--accent-green); border-color: var(--accent-gold); color: white;
        }
        button:disabled { opacity: 0.4; cursor: not-allowed; border-color: #333; box-shadow: none; transform: none;}
        
        .action-btn { width: 100%; margin-bottom: 10px; border-color: var(--accent-gold); padding: 15px; background: linear-gradient(45deg, #2a1a1a, #3d1e1e); text-align: left; }

        /* 6) SPECIAL POWER BUTTON */
        #special-power-btn {
            background: linear-gradient(135deg, #ffd700, #b8860b); color: #000; font-weight: bold;
            border: 2px solid #fff; margin-bottom: 15px; width: 100%; display: flex; justify-content: space-between; align-items: center;
        }
        #special-power-btn:disabled { background: #333; color: #777; border-color: #555; }

        /* --- MAIN VIEW --- */
        .main-panel { grid-column: 2; display: flex; flex-direction: column; }
        
        .room-title { font-family: 'Cinzel', serif; font-size: 3em; color: var(--accent-red); text-align: center; margin-bottom: 5px; text-shadow: 0 0 15px rgba(255,0,0,0.3); }
        .room-coords { text-align: center; color: #888; font-size: 1em; margin-bottom: 15px; letter-spacing: 2px; }
        
        .room-visual {
            height: 220px; background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(20,69,47,0.3));
            border: 3px solid var(--accent-green); display: flex; align-items: center; justify-content: center;
            font-size: 6em; margin-bottom: 20px; box-shadow: inset 0 0 50px rgba(0,0,0,0.9);
            border-radius: 8px; position: relative; overflow: hidden;
        }
        
        /* 5) ANIMATIONS */
        .anim-layer { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; display: flex; justify-content: center; align-items: center; font-size: 4rem; opacity: 0; }
        @keyframes walkNorth { 0% { transform: translateY(50px) scale(0.5); opacity: 0;} 50% { opacity: 1; } 100% { transform: translateY(-50px) scale(1); opacity: 0; } }
        @keyframes walkStairs { 0% { transform: translateY(20px); opacity:0;} 50% { opacity:1; transform: translateY(0px);} 100% { transform: translateY(-20px); opacity:0;} }
        
        .room-desc { font-size: 1.3em; line-height: 1.6; margin-bottom: 20px; text-align: justify; color: #eee; padding: 0 10px; }
        .exits-line { font-size: 1.1em; color: var(--accent-gold); margin-bottom: 20px; border-left: 4px solid var(--accent-red); padding-left: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 0 8px 8px 0;}

        /* --- METERS & TRACKERS --- */
        .meter-container { margin: 15px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; border: 1px solid #444;}
        .meter-label { display: flex; justify-content: space-between; font-size: 1.1em; margin-bottom: 5px; font-weight: bold; }
        .meter-bar { height: 15px; background: #111; border-radius: 8px; overflow: hidden; border: 1px solid #555; }
        .meter-fill { height: 100%; transition: width 0.5s; }
        .ghost-fill { background: linear-gradient(90deg, #483d8b, #ff4444); width: 0%; }
        
        .objective-box {
            background: rgba(0,0,0,0.3); border: 2px solid var(--accent-gold); padding: 15px; margin-bottom: 15px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5); border-radius: 8px;
        }
        .obj-title { color: var(--accent-gold); font-weight: bold; font-family: 'Cinzel'; margin-bottom: 10px; font-size: 1.3em; text-align: center; border-bottom: 1px solid #555; padding-bottom: 5px;}
        .obj-list { list-style: none; font-size: 1.1em; }
        .obj-item { margin-bottom: 8px; padding-left: 5px;}
        .obj-item.done { color: #7ee787; text-decoration: line-through; opacity: 0.7; }
        .hint-text { font-style: italic; color: #aaa; font-size: 1em; margin-top: 10px; border-top: 1px dashed #444; padding-top: 8px; text-align: center;}

        /* --- INVENTORY --- */
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .inv-item {
            aspect-ratio: 1; border: 2px dashed var(--accent-green);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: help; background: rgba(0,0,0,0.2); transition: 0.3s; border-radius: 8px;
        }
        .inv-item.filled { border-style: solid; border-color: var(--accent-gold); background: radial-gradient(circle, #3d1e1e 0%, #1a0505 100%); }
        .inv-item.empty { opacity: 0.2; cursor: default; }
        .inv-item span { font-size: 0.85em; margin-top: 5px; text-align: center; color: #ddd; font-weight: bold;}

        /* --- 1) ADVENTURE HISTORY (BOTTOM) --- */
        .history-panel {
            grid-column: 1 / -1; /* Span all columns */
            height: 160px;
            background: #111;
            border-top: 4px solid var(--accent-gold);
            display: flex;
            align-items: center;
            padding: 10px 20px;
            overflow-x: auto;
            gap: 15px;
            border-radius: 8px;
        }
        
        .history-box {
            min-width: 200px;
            height: 120px;
            background: #222;
            border: 1px solid #444;
            padding: 10px;
            font-size: 0.9em;
            border-radius: 6px;
            color: #aaa;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            animation: popIn 0.3s ease;
        }
        .history-box.new { border-color: var(--accent-green); color: #fff; background: #2a3a2a; }
        .history-box.danger { border-color: var(--accent-red); background: #3a1a1a; }
        @keyframes popIn { from { transform: scale(0.8); opacity:0; } to { transform: scale(1); opacity:1;} }

        /* --- MODALS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #1a0505; border: 4px solid var(--accent-gold); padding: 40px;
            max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;
            position: relative; animation: slideIn 0.4s ease;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.3);
            text-align: center;
        }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-close { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 2em; color: var(--accent-red); }
        .input-dark { width: 80%; padding: 15px; background: #000; color: white; border: 2px solid var(--accent-gold); font-family: 'Cinzel'; text-align: center; font-size: 1.4em; margin: 20px auto; display:block; }

        .snowflake { position: absolute; color: white; animation: fall linear infinite; pointer-events: none; text-shadow: 0 0 5px white;}
        @keyframes fall { to { transform: translateY(100vh); } }
        
        /* Game Over Style */
        .game-over-text { font-family: 'Cinzel'; font-size: 4em; color: var(--accent-red); margin-bottom: 20px; text-shadow: 0 0 20px red; }

        @media (max-width: 1000px) {
            .game-wrapper { grid-template-columns: 1fr; height: auto; overflow-y: auto; display: block; }
            .panel { margin-bottom: 20px; height: auto; }
            .history-panel { height: auto; flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>

    <div id="help-overlay" class="overlay" style="display: flex;">
        <div class="modal-box">
            <div class="modal-close" onclick="closeHelp()">√ó</div>
            <h2 style="color: var(--accent-gold); font-family: 'Cinzel'; font-size: 2.5em; margin-bottom: 15px;">Die Legende der Winterkrone</h2>
            <p style="font-size: 1.2em; color: #ccc; margin-bottom: 30px;">
                Finde die 3 Edelsteine. Setze die Krone zusammen. √úberlebe den Geist.
            </p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border: 1px solid var(--accent-green);">
                    <h3 style="color: var(--accent-green);">‚ú® Neu: Magie</h3>
                    <p>Nutze die <strong>Laterne</strong>, um den Geist zu beruhigen. Sie l√§dt sich auf, wenn du R√§tsel l√∂st.</p>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border: 1px solid var(--accent-gold);">
                    <h3 style="color: var(--accent-gold);">üó£Ô∏è Neu: Gespr√§che</h3>
                    <p>Sprich mit den Geistern des Schlosses (Koch, Narr), um Hinweise zu erhalten.</p>
                </div>
            </div>
            <button class="action-btn" onclick="closeHelp()" style="margin-top: 30px; background: var(--accent-green); color: white; font-size: 1.3em; text-align: center;">Spiel Starten</button>
        </div>
    </div>

    <div id="msg-modal" class="overlay">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 id="msg-title" style="color: var(--accent-gold); margin-bottom: 20px; font-size: 2em; font-family: 'Cinzel';"></h3>
            <p id="msg-text" style="font-size: 1.4em; line-height: 1.6; margin-bottom: 30px;"></p>
            <button onclick="closeMsg()" class="action-btn" style="text-align: center;">Weiter</button>
        </div>
    </div>

    <div id="puzzle-modal" class="overlay">
        <div class="modal-box" style="border-color: #8b949e;">
            <div class="modal-close" onclick="closePuzzle()">√ó</div>
            <h2 style="color: #ccc; font-family: 'Cinzel';">R√ÑTSEL</h2>
            <p id="puzzle-text" style="font-size: 1.4em; margin: 20px 0; color: #fff;">...</p>
            <input type="text" id="puzzle-answer" class="input-dark" placeholder="Deine Antwort..." autocomplete="off">
            <button onclick="submitPuzzleAnswer()" class="action-btn" style="text-align: center;">L√∂sen</button>
        </div>
    </div>

    <div id="ghost-modal" class="overlay">
        <div class="modal-box" style="border-color: var(--ghost-purple); box-shadow: 0 0 50px var(--ghost-purple);">
            <h2 style="color: var(--ghost-purple); font-family: 'Cinzel'; font-size: 2.5em;">üëÅÔ∏è ALBRECHT ERSCHEINT</h2>
            <p style="color: #aaa;">Die K√§lte greift nach deinem Herzen...</p>
            <p id="ghost-riddle-text" style="font-size: 1.5em; margin: 30px 0; font-style: italic; color: #fff;">...</p>
            <input type="text" id="ghost-answer" class="input-dark" style="border-color: var(--ghost-purple);" placeholder="Antwort..." autocomplete="off">
            <button onclick="submitGhostAnswer()" class="action-btn" style="background: var(--ghost-purple); color: white; text-align: center;">Antworten</button>
        </div>
    </div>

    <div id="game-over-modal" class="overlay">
        <div class="modal-box" style="border-color: red; background: #000;">
            <h1 class="game-over-text">GAME OVER</h1>
            <p style="font-size: 1.5em; margin-bottom: 30px;">Der Geist hat dich in die ewige Dunkelheit gezogen.</p>
            <button onclick="location.reload()" class="action-btn" style="background: var(--accent-red); color: white; text-align: center;">Neustart</button>
        </div>
    </div>

    <div class="game-wrapper">
        <div class="panel">
            <div class="panel-header">Karte</div>
            <div class="map-wrapper">
                <div class="map-controls">
                    <button class="lvl-btn" id="lvl-btn-m1" onclick="player.mapLevel=-1; updateUI()">Keller</button>
                    <button class="lvl-btn" id="lvl-btn-0" onclick="player.mapLevel=0; updateUI()">Erdgeschoss</button>
                    <button class="lvl-btn" id="lvl-btn-1" onclick="player.mapLevel=1; updateUI()">Turm</button>
                </div>
                <div class="map-container" id="mini-map"></div>
                <div style="text-align: center; font-size: 0.9em; color: #888; margin-top: 10px;">Klick = Schnellreise</div>
            </div>
            
            <div class="panel-header" style="margin-top: 20px;">Rucksack</div>
            <div class="inventory-grid" id="inventory-grid"></div>
        </div>

        <div class="panel main-panel">
            <div class="panel-header">
                <span>Umgebung</span>
                <button class="help-btn" onclick="openHelp()">?</button>
            </div>
            
            <h2 id="room-name" class="room-title">Schlosshof</h2>
            <div id="room-coords" class="room-coords">Ebene 0</div>
            
            <div id="room-visual" class="room-visual">
                <span id="room-icon">üè∞</span>
                <div id="anim-layer" class="anim-layer"></div>
            </div>
            
            <div id="room-desc" class="room-desc">...</div>
            <div id="room-exits" class="exits-line">Ausg√§nge: ...</div>
            
            <div id="interaction-area" style="border-top: 2px solid var(--border-color); padding-top: 20px;"></div>
        </div>

        <div class="panel">
            <div class="objective-box">
                <div class="obj-title">Quest: Die Krone</div>
                <ul class="obj-list">
                    <li id="obj-ruby" class="obj-item">Blutrubin</li>
                    <li id="obj-sapphire" class="obj-item">Eissaphir</li>
                    <li id="obj-emerald" class="obj-item">Waldsmaragd</li>
                </ul>
                <div id="hint-display" class="hint-text">Tipp: ...</div>
            </div>

            <div class="meter-container">
                <div class="meter-label">
                    <span>Geister-Zorn</span>
                    <span id="ghost-status">Ruhig</span>
                </div>
                <div class="meter-bar">
                    <div id="ghost-meter" class="meter-fill ghost-fill"></div>
                </div>
                <div style="font-size: 0.8em; color: #888; text-align: right; margin-top: 3px;">Bei 100% ist das Spiel vorbei.</div>
            </div>

            <button id="special-power-btn" onclick="usePower()" disabled>
                <span>‚ú® Laterne</span>
                <span id="power-charge">0%</span>
            </button>

            <div class="d-pad-grid">
                <div></div>
                <button id="btn-n" onclick="move('N')">N</button>
                <div></div>
                <button id="btn-w" onclick="move('W')">W</button>
                <button onclick="explore()" title="Suchen" style="background: #3d1e1e; border-color: var(--accent-gold); font-size: 1.5em;">üëÅÔ∏è</button>
                <button id="btn-o" onclick="move('O')">O</button>
                <div></div>
                <button id="btn-s" onclick="move('S')">S</button>
                <div></div>
            </div>

            <div class="vert-controls">
                <button id="btn-u" onclick="move('U')">‚¨Ü TREPPE</button>
                <button id="btn-d" onclick="move('D')">‚¨á TREPPE</button>
            </div>
        </div>

        <div class="history-panel" id="history-container">
            <div class="history-box">Das Abenteuer beginnt...</div>
        </div>
    </div>

    <div id="snow-container"></div>

    <script>
        /* --- GAME DATA --- */
        const player = {
            room: 'courtyard',
            inventory: [],
            flags: {},
            ghostMeter: 0,
            ghostCooldown: 0,
            visited: ['courtyard'],
            mapLevel: 0,
            questStep: 0,
            powerCharge: 100 // Starts full
        };

        const items = {
            'rusty_key': { name: 'Rostiger Schl√ºssel', icon: 'üóùÔ∏è', desc: 'Riecht nach Moder.', type: 'key' },
            'silver_key': { name: 'Silberschl√ºssel', icon: 'üóùÔ∏è', desc: 'Turm-Symbol eingraviert.', type: 'key' },
            'crowbar': { name: 'Brecheisen', icon: 'üîß', desc: 'Massives Werkzeug.', type: 'tool' },
            'scroll': { name: 'Notiz', icon: 'üìú', desc: 'Rot13: "Vjre fbg nyyvrf orv anzra araara: Nyoerpug"', type: 'clue' },
            'ruby': { name: 'Rubin', icon: 'üíé', desc: 'Warm wie Feuer.', type: 'gem' },
            'sapphire': { name: 'Saphir', icon: 'üíé', desc: 'Kalt wie Eis.', type: 'gem' },
            'emerald': { name: 'Smaragd', icon: 'üíé', desc: 'Leuchtet lebendig.', type: 'gem' }
        };

        // 3) NPC DIALOGS ADDED TO ROOMS
        const rooms = {
            'courtyard': {
                name: 'Schlosshof', visual: 'üè∞', coords: {x:2, y:2, z:0},
                desc: 'Der Wind heult. Der Brunnen ist gefroren. Ein sicherer Ort.',
                exits: { N: 'great_hall', O: 'kitchen', W: 'library_entrance' },
                actions: [
                    { label: "Am Brunnen ausruhen", effect: () => {
                        addToHistory("Du ruhst dich aus.", "new");
                        changeGhostMeter(-15);
                        showMsg("Der Brunnen", "Das Pl√§tschern beruhigt dich. (-15 Zorn)");
                    }}
                ]
            },
            'kitchen': {
                name: 'Alte K√ºche', visual: 'üç≥', coords: {x:3, y:2, z:0},
                desc: 'Kalte Asche. Ein Geist-Koch schwebt traurig √ºber den T√∂pfen.',
                exits: { W: 'courtyard', D: 'cellar' },
                lockedExits: { D: {key: 'rusty_key', msg: 'Kellert√ºr ist verschlossen.'} },
                search: [{ give: 'crowbar', msg: 'Im Ofen liegt ein Brecheisen!' }],
                character: { name: "Geist-Koch", dialog: "Meine Ratten... sie haben den Schl√ºssel unter einen Teller in der Gro√üen Halle geschleppt!" }
            },
            'cellar': {
                name: 'Weinkeller', visual: 'üç∑', coords: {x:3, y:2, z:-1},
                desc: 'Dunkel und feucht. F√§sser stapeln sich.',
                exits: { U: 'kitchen' },
                interact: [
                    { label: 'Fass √∂ffnen', req: 'crowbar', result: 'get_ruby', msg: 'Rubin gefunden!' },
                    { label: 'Wand einrei√üen', req: 'crowbar', action: 'open_dungeon', msg: 'Weg zum Verlies frei!' }
                ]
            },
            'great_hall': {
                name: 'Gro√üe Halle', visual: 'üïØÔ∏è', coords: {x:2, y:1, z:0},
                desc: 'Eine riesige Tafel. Der Geist eines Hofnarren kichert in der Ecke.',
                exits: { S: 'courtyard', N: 'throne_room' },
                search: [{ give: 'rusty_key', msg: 'Schl√ºssel unter dem Teller gefunden!' }],
                character: { name: "Hofnarr", dialog: "Hihi! Der Name des K√∂nigs? Dreh die Buchstaben! A wird zu N... alles dreht sich!" }
            },
            'throne_room': {
                name: 'Thronsaal', visual: 'üëë', coords: {x:2, y:0, z:0},
                desc: 'Der leere Thron wartet auf die Krone.',
                exits: { S: 'great_hall' },
                interact: [{ label: 'Krone zusammensetzen', action: 'win_check' }]
            },
            'library_entrance': {
                name: 'Turmeingang', visual: 'üö™', coords: {x:1, y:2, z:0},
                desc: 'Eine verschlossene Silbert√ºr.',
                exits: { O: 'courtyard', W: 'library' },
                lockedExits: { W: {key: 'silver_key', msg: 'Braucht Silberschl√ºssel.'} }
            },
            'library': {
                name: 'Bibliothek', visual: 'üìö', coords: {x:0, y:2, z:0},
                desc: 'B√ºcher bis zur Decke. Ein alter Geist liest.',
                exits: { O: 'library_entrance', U: 'tower_top' },
                puzzle: { q: 'Zahlenfolge: 2, 4, 8, 16...?', a: '32', reward: 'sapphire' },
                character: { name: "Archivar", dialog: "Zahlen sind die Sprache des Universums. Verdopple dein Wissen." }
            },
            'tower_top': {
                name: 'Turmspitze', visual: 'üåô', coords: {x:0, y:2, z:1},
                desc: 'Eisiger Wind. Ein Skelett h√§lt eine Notiz.',
                exits: { D: 'library' },
                search: [{ give: 'scroll', msg: 'Notiz genommen.' }]
            },
            'dungeon': {
                name: 'Verlies', visual: '‚õìÔ∏è', coords: {x:3, y:1, z:-1},
                desc: 'Ketten und Dunkelheit.',
                exits: { N: 'crypt', S: 'cellar' }
            },
            'crypt': {
                name: 'Familiengruft', visual: '‚ö∞Ô∏è', coords: {x:3, y:0, z:-1},
                desc: 'Hier ruhen die Ahnen. Gr√ºnes Leuchten.',
                exits: { S: 'dungeon' },
                puzzle: { q: 'Nenne den Namen! (Hinweis: Notiz + Rot13)', a: 'ALBRECHT', reward: 'emerald' }
            }
        };

        const quest = [
            { text: "Suche Schl√ºssel in der Gro√üen Halle.", done: () => player.inventory.includes('rusty_key') },
            { text: "Suche Brecheisen in der K√ºche.", done: () => player.inventory.includes('crowbar') },
            { text: "Hole Rubin aus dem Keller.", done: () => player.inventory.includes('ruby') },
            { text: "Finde Silberschl√ºssel im Hof.", done: () => player.inventory.includes('silver_key') },
            { text: "L√∂se Bibliotheks-R√§tsel.", done: () => player.inventory.includes('sapphire') },
            { text: "Hole Notiz vom Turm.", done: () => player.inventory.includes('scroll') },
            { text: "L√∂se Gruft-R√§tsel (Smaragd).", done: () => player.inventory.includes('emerald') },
            { text: "Zum Thronsaal!", done: () => false }
        ];

        /* --- ENGINE --- */
        function init() {
            createSnow();
            updateUI();
            
            document.addEventListener('keydown', (e) => {
                if (isModalOpen()) return;
                const k = e.key.toLowerCase();
                if(k === 'w' || k === 'arrowup') move('N');
                if(k === 's' || k === 'arrowdown') move('S');
                if(k === 'a' || k === 'arrowleft') move('W');
                if(k === 'd' || k === 'arrowright') move('O');
                if(k === 'e') explore();
            });

            ['puzzle-answer', 'ghost-answer'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('keydown', (e) => { if(e.key==='Enter') (id==='puzzle-answer'?submitPuzzleAnswer():submitGhostAnswer()); });
            });
        }

        function isModalOpen() {
            return document.querySelectorAll('.overlay[style*="flex"]').length > 0;
        }

        // 5) ANIMATION FUNCTION
        function playAnimation(type) {
            const layer = document.getElementById('anim-layer');
            layer.innerHTML = '';
            
            if (type === 'walk') layer.innerHTML = 'üë£';
            else if (type === 'stairs') layer.innerHTML = 'ü™ú';
            
            // Trigger reflow
            void layer.offsetWidth;
            
            layer.style.animation = 'none';
            setTimeout(() => {
                layer.style.animation = type === 'walk' ? 'walkNorth 0.8s ease' : 'walkStairs 1s ease';
            }, 10);
        }

        function updateUI() {
            const r = rooms[player.room];
            document.getElementById('room-name').innerText = r.name;
            document.getElementById('room-coords').innerText = `Ebene ${r.coords.z}`;
            document.getElementById('room-visual').querySelector('#room-icon').innerText = r.visual;
            document.getElementById('room-desc').innerText = r.desc;
            
            let exitText = [];
            const labels = {N:'Norden', S:'S√ºden', O:'Osten', W:'Westen', U:'Oben', D:'Unten'};
            for(let d in labels) {
                if(r.exits[d]) exitText.push(labels[d]);
                else if(r.lockedExits && r.lockedExits[d]) exitText.push(labels[d] + " (üîí)");
            }
            document.getElementById('room-exits').innerText = "Ausg√§nge: " + exitText.join(', ');

            // Buttons
            ['n','s','o','w','u','d'].forEach(d => {
                const btn = document.getElementById(`btn-${d}`);
                const dir = d.toUpperCase();
                const hasExit = r.exits[dir] || (r.lockedExits && r.lockedExits[dir]);
                btn.disabled = !hasExit;
                btn.style.opacity = hasExit ? 1 : 0.3;
            });

            const area = document.getElementById('interaction-area');
            area.innerHTML = '';
            
            // NPC Button
            if(r.character) {
                let b = document.createElement('button');
                b.className = 'action-btn'; b.innerText = `üó£Ô∏è Mit ${r.character.name} reden`;
                b.onclick = () => {
                    addToHistory(`Gespr√§ch: ${r.character.name}`, "new");
                    showMsg(r.character.name, `"${r.character.dialog}"`);
                };
                area.appendChild(b);
            }

            if(r.puzzle && !player.flags[r.puzzle.reward + '_got']) {
                let b = document.createElement('button');
                b.className = 'action-btn'; b.innerText = 'üß© R√§tsel ansehen';
                b.onclick = () => openPuzzleModal(r.puzzle);
                area.appendChild(b);
            }

            if(r.interact) {
                r.interact.forEach(act => {
                    if(act.action === 'open_dungeon' && rooms['cellar'].exits['N']) return;
                    if(act.result === 'get_ruby' && player.inventory.includes('ruby')) return;
                    let b = document.createElement('button');
                    b.className = 'action-btn'; b.innerText = `‚öôÔ∏è ${act.label}`;
                    b.onclick = () => handleInteract(act);
                    area.appendChild(b);
                });
            }

            if(r.actions) {
                r.actions.forEach(a => {
                    let b = document.createElement('button');
                    b.className = 'action-btn'; b.innerText = `üìñ ${a.label}`;
                    b.onclick = () => { changeGhostMeter(-5); a.effect(); updateUI(); };
                    area.appendChild(b);
                });
            }

            // Power Button
            const pBtn = document.getElementById('special-power-btn');
            pBtn.disabled = player.powerCharge < 100;
            document.getElementById('power-charge').innerText = player.powerCharge + '%';

            renderMap(player.mapLevel);
            updateObjectives();
            renderInventory();
        }

        // 6) SPECIAL POWER
        function usePower() {
            if(player.powerCharge >= 100) {
                player.powerCharge = 0;
                changeGhostMeter(-30);
                addToHistory("Laterne benutzt (-30 Zorn)", "new");
                showMsg("Magisches Licht", "Die Laterne vertreibt die Schatten. Der Geist zieht sich zur√ºck.");
                updateUI();
            }
        }

        function rechargePower(amount) {
            player.powerCharge = Math.min(100, player.powerCharge + amount);
        }

        function renderMap(level) {
            const map = document.getElementById('mini-map');
            const btnID = level === -1 ? 'lvl-btn-m1' : 'lvl-btn-' + level;
            document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(btnID);
            if(activeBtn) activeBtn.classList.add('active');

            map.innerHTML = '';
            
            for(let y=0; y<5; y++) {
                for(let x=0; x<5; x++) {
                    let node = document.createElement('div');
                    node.className = 'map-node fog';
                    
                    let roomKey = Object.keys(rooms).find(k => 
                        rooms[k].coords.x === x && rooms[k].coords.y === y && rooms[k].coords.z === level
                    );

                    if(roomKey) {
                        const r = rooms[roomKey];
                        const isVisited = player.visited.includes(roomKey);
                        const isCurrent = player.room === roomKey;
                        
                        let neighborVisited = !isVisited && Object.keys(rooms).some(k => {
                             const nr = rooms[k];
                             return nr.coords.z === level && (Math.abs(nr.coords.x-x)+Math.abs(nr.coords.y-y))===1 && player.visited.includes(k);
                        });

                        if (isCurrent) { node.className = 'map-node active'; node.innerText = r.visual; } 
                        else if (isVisited) { 
                            node.className = 'map-node visited'; node.innerText = r.visual; 
                            node.onclick = () => fastTravel(roomKey);
                            if (r.lockedExits && Object.values(r.lockedExits).some(l => !player.inventory.includes(l.key))) {
                                node.innerHTML += '<span class="lock-icon">üîí</span>';
                            }
                        } 
                        else if (neighborVisited) { node.className = 'map-node seen'; node.innerText = '?'; }
                    }
                    map.appendChild(node);
                }
            }
        }

        function move(dir) {
            const r = rooms[player.room];
            if(r.lockedExits && r.lockedExits[dir]) {
                const lock = r.lockedExits[dir];
                if(player.inventory.includes(lock.key)) {
                    addToHistory("T√ºr aufgeschlossen", "new");
                    player.room = r.exits[dir];
                    visitRoom();
                } else {
                    addToHistory("T√ºr verschlossen!", "danger");
                }
                return;
            }

            if(r.exits[dir]) {
                player.room = r.exits[dir];
                
                // Animation
                if(dir === 'U' || dir === 'D') playAnimation('stairs');
                else playAnimation('walk');

                changeGhostMeter(5); 
                visitRoom();
            }
        }

        function fastTravel(targetRoom) {
            if (targetRoom === player.room) return;
            addToHistory("Schnellreise...", "new");
            changeGhostMeter(8);
            player.room = targetRoom;
            player.mapLevel = rooms[player.room].coords.z;
            checkGhost();
            updateUI();
        }

        function visitRoom() {
            if(!player.visited.includes(player.room)) {
                player.visited.push(player.room);
                rechargePower(20); // Reward for exploration
                changeGhostMeter(10);
            }
            player.mapLevel = rooms[player.room].coords.z;
            
            // 2) GHOST CALMS DOWN SOMETIMES
            if(player.room === 'courtyard') changeGhostMeter(-5); 
            
            addToHistory("Betrete: " + rooms[player.room].name);
            checkGhost();
            updateUI();
        }

        function explore() {
            const r = rooms[player.room];
            changeGhostMeter(10);

            if (r.search) {
                for (const entry of r.search) {
                    if (entry.give) {
                        if (player.inventory.includes(entry.give)) continue;
                        player.inventory.push(entry.give);
                        addToHistory("Gefunden: " + items[entry.give].name, "new");
                        rechargePower(30);
                        showMsg('Gefunden!', entry.msg);
                        updateUI();
                        return;
                    } else {
                        addToHistory("Untersucht...", "new");
                        showMsg('Untersucht', entry.msg);
                        checkGhost(true);
                        return;
                    }
                }
            }

            if(player.room === 'courtyard' && player.visited.includes('great_hall') && !player.inventory.includes('silver_key')) {
                player.inventory.push('silver_key');
                addToHistory("Gefunden: Silberschl√ºssel", "new");
                showMsg('Gefunden', 'Der Silberschl√ºssel lag im Schnee vergraben.');
                updateUI();
                return;
            }

            addToHistory("Nichts gefunden.");
            checkGhost(true);
        }

        // 1) ADVENTURE HISTORY BOXES
        function addToHistory(text, type="normal") {
            const container = document.getElementById('history-container');
            const box = document.createElement('div');
            box.className = 'history-box ' + type;
            box.innerText = text;
            container.prepend(box);
            if(container.children.length > 8) container.lastChild.remove();
        }

        function handleInteract(act) {
            if(act.req && !player.inventory.includes(act.req)) {
                addToHistory("Fehlt: " + items[act.req].name, "danger");
                return;
            }

            if(act.action === 'open_dungeon') {
                rooms['cellar'].exits['N'] = 'dungeon';
                addToHistory("Wand eingerissen!", "new");
                updateUI();
            } 
            else if(act.result === 'get_ruby') {
                player.inventory.push('ruby');
                addToHistory("Rubin erhalten!", "new");
                rechargePower(50);
                showMsg('Edelstein', 'Der Blutrubin geh√∂rt dir.');
                updateUI();
            }
            else if(act.action === 'win_check') {
                if(['ruby','sapphire','emerald'].every(i => player.inventory.includes(i))) {
                    document.body.innerHTML = '<div style="display:flex;height:100vh;justify-content:center;align-items:center;background:#050a14;color:gold;flex-direction:column;text-align:center;"><h1 style="font-family:Cinzel;font-size:5em;text-shadow:0 0 30px gold;">FLUCH GEBROCHEN</h1><p style="font-size:2em;margin:20px;">Das Schloss ist frei!</p><button onclick="location.reload()" style="padding:20px;font-size:1.5em;cursor:pointer;">Neustart</button></div>';
                } else {
                    addToHistory("Krone unvollst√§ndig!", "danger");
                }
            }
        }

        let activePuzzle = null;
        function openPuzzleModal(puzzle) {
            activePuzzle = puzzle;
            document.getElementById('puzzle-text').innerText = puzzle.q;
            document.getElementById('puzzle-modal').style.display = 'flex';
            document.getElementById('puzzle-answer').value = '';
            document.getElementById('puzzle-answer').focus();
        }
        function closePuzzle() { document.getElementById('puzzle-modal').style.display = 'none'; activePuzzle = null; }

        function submitPuzzleAnswer() {
            if(!activePuzzle) return;
            let ans = document.getElementById('puzzle-answer').value.toUpperCase().trim();
            closePuzzle();
            if(ans === activePuzzle.a) {
                player.inventory.push(activePuzzle.reward);
                player.flags[activePuzzle.reward + '_got'] = true;
                addToHistory("R√§tsel gel√∂st!", "new");
                rechargePower(100);
                showMsg('Gel√∂st!', 'Du erh√§ltst: ' + items[activePuzzle.reward].name);
                updateUI();
            } else {
                addToHistory("Falsche Antwort!", "danger");
                changeGhostMeter(20);
                checkGhost(true);
            }
        }

        // 7) LOSE CONDITION & METER LOGIC
        function changeGhostMeter(amount) {
            player.ghostMeter = Math.max(0, Math.min(100, player.ghostMeter + amount));
            const bar = document.getElementById('ghost-meter');
            const txt = document.getElementById('ghost-status');
            bar.style.width = player.ghostMeter + '%';
            
            if(player.ghostMeter < 30) { txt.innerText = "Ruhig"; txt.style.color="white"; }
            else if(player.ghostMeter < 70) { txt.innerText = "Unheimlich"; txt.style.color="orange"; }
            else { txt.innerText = "GEFAHR"; txt.style.color="#ff4444"; }

            if(player.ghostMeter >= 100) {
                document.getElementById('game-over-modal').style.display = 'flex';
            }
        }

        function checkGhost(force = false) {
            if(player.ghostCooldown > 0) { player.ghostCooldown--; return; }
            if(player.ghostMeter < 20 && !force) return; // Safer early game

            let chance = player.ghostMeter / 150; 
            if(force) chance += 0.25;

            if(Math.random() < chance && player.room !== 'dungeon' && player.room !== 'crypt') {
                spawnGhost();
            }
        }

        const riddles = [
            {q:"Ich habe St√§dte, aber keine H√§user. Was bin ich?", a:"KARTE", pen:"teleport"},
            {q:"Je mehr du von mir wegnimmst, desto gr√∂√üer werde ich.", a:"LOCH", pen:"steal"}
        ];
        let currentRiddle = null;

        function spawnGhost() {
            if(isModalOpen()) return;
            currentRiddle = riddles[Math.floor(Math.random()*riddles.length)];
            document.getElementById('ghost-riddle-text').innerText = currentRiddle.q;
            document.getElementById('ghost-modal').style.display = 'flex';
            document.getElementById('ghost-answer').value = '';
            document.getElementById('ghost-answer').focus();
        }

        function submitGhostAnswer() {
            const val = document.getElementById('ghost-answer').value.toUpperCase().trim();
            document.getElementById('ghost-modal').style.display = 'none';
            if(val === currentRiddle.a) {
                addToHistory("Geist vertrieben", "new");
                changeGhostMeter(-50);
                player.ghostCooldown = 5; 
            } else {
                if(currentRiddle.pen === 'teleport') {
                    player.room = 'dungeon';
                    player.visited.push('dungeon');
                    player.mapLevel = -1;
                    addToHistory("Verschleppt!", "danger");
                } else {
                    addToHistory("Geist greift an!", "danger");
                    changeGhostMeter(30);
                }
                player.ghostCooldown = 3;
            }
            updateUI();
        }

        function updateObjectives() {
            ['ruby','sapphire','emerald'].forEach(gem => {
                if(player.inventory.includes(gem)) document.getElementById('obj-'+gem).classList.add('done');
            });
            while (player.questStep < quest.length && quest[player.questStep].done()) {
                player.questStep++;
            }
            const h = document.getElementById('hint-display');
            h.innerText = (player.questStep >= quest.length) ? "Setze die Krone zusammen!" : "Tipp: " + quest[player.questStep].text;
        }

        function renderInventory() {
            const g = document.getElementById('inventory-grid');
            g.innerHTML = '';
            player.inventory.forEach(k => {
                let d = document.createElement('div');
                d.className = 'inv-item filled';
                d.innerHTML = `${items[k].icon}<span>${items[k].name}</span>`;
                d.onclick = () => showMsg(items[k].name, items[k].desc);
                g.appendChild(d);
            });
            for(let i=player.inventory.length; i<6; i++) {
                let d = document.createElement('div'); d.className = 'inv-item empty'; g.appendChild(d);
            }
        }

        function createSnow() {
            const c = document.getElementById('snow-container');
            for(let i=0; i<60; i++){
                let s = document.createElement('div');
                s.className = 'snowflake'; s.innerHTML = '‚ùÑ';
                s.style.left = Math.random()*100+'vw';
                s.style.fontSize = (10 + Math.random()*20) + 'px';
                s.style.animationDuration = (4+Math.random()*5)+'s';
                s.style.animationDelay = '-' + (Math.random()*5) + 's';
                c.appendChild(s);
            }
        }

        function openHelp() { document.getElementById('help-overlay').style.display = 'flex'; }
        function closeHelp() { document.getElementById('help-overlay').style.display = 'none'; }
        function showMsg(t, m) {
            document.getElementById('msg-title').innerText = t;
            document.getElementById('msg-text').innerText = m;
            document.getElementById('msg-modal').style.display = 'flex';
        }
        function closeMsg() { document.getElementById('msg-modal').style.display = 'none'; }

        init();
    </script>
</body>
</html>
