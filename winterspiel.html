<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Das R√§tsel der Winterkrone</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@400;600&display=swap');
        
        :root {
            /* Christmas / Winter Night Palette */
            --bg-dark: #0b1026; /* Deep Midnight Blue */
            --bg-panel: #1a0505; /* Deep Velvet Red */
            --text-main: #e0e6ed; /* Snowy White */
            
            --accent-red: #d42426; /* Holiday Red */
            --accent-green: #14452f; /* Deep Pine Green */
            --accent-gold: #ffd700; /* Shining Gold */
            
            --ghost-purple: #7b68ee; /* Mystical Purple */
            --border-color: #4a0e0e; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Cormorant Garamond', serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            background-image: linear-gradient(to bottom, #050a14 0%, #111936 100%);
            user-select: none;
        }

        /* --- LAYOUT --- */
        .game-wrapper {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            gap: 20px;
            max-width: 1600px;
            height: 95vh;
            margin: 2.5vh auto;
            padding: 0 20px;
            position: relative;
            z-index: 2;
        }

        .panel {
            background: var(--bg-panel);
            border: 3px double var(--accent-green);
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .panel-header {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .help-btn {
            background: none; border: 1px solid var(--accent-gold); color: var(--accent-gold);
            width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-size: 0.9em;
            transition: 0.3s;
        }
        .help-btn:hover { background: var(--accent-gold); color: var(--bg-panel); }

        /* --- MAP SYSTEM --- */
        .map-wrapper { position: relative; margin-bottom: 15px; }
        .map-controls { display: flex; gap: 5px; margin-bottom: 5px; justify-content: center; }
        .lvl-btn { 
            background: #2a1a1a; border: 1px solid var(--border-color); color: #8b949e; 
            padding: 2px 8px; font-size: 0.8em; cursor: pointer; font-family: 'Cinzel';
        }
        .lvl-btn.active { background: var(--accent-green); color: white; border-color: var(--accent-gold); }

        .map-container {
            height: 200px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 3px;
            padding: 5px;
        }
        
        .map-node {
            background: transparent;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #555;
            position: relative;
            transition: all 0.3s;
        }

        .map-node.visited { background: #3d1e1e; border: 1px solid #5c2b2b; cursor: pointer; } 
        .map-node.visited:hover { background: #5c2b2b; border-color: var(--accent-gold); }
        .map-node.fog { opacity: 0; pointer-events: none; }
        .map-node.seen { background: rgba(255,255,255,0.05); color: #666; font-size: 1em; border: 1px dashed #444; }
        .map-node.active { background: var(--accent-gold); color: #000; box-shadow: 0 0 15px var(--accent-gold); z-index: 2; border-color: white; cursor: default;}
        
        .lock-icon {
            position: absolute; bottom: -2px; right: -2px; font-size: 0.7em; 
            background: #000; border-radius: 50%; padding: 2px; color: var(--accent-red);
        }

        /* --- CONTROLS --- */
        .d-pad-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 15px;
        }

        .vert-controls {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 15px;
        }

        button {
            background: #2a1a1a; border: 1px solid var(--border-color); color: var(--text-main);
            padding: 10px; font-family: 'Cinzel', serif; cursor: pointer; transition: all 0.2s; font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        button:hover:not(:disabled) {
            background: var(--accent-green); border-color: var(--accent-gold); transform: translateY(-2px); color: white;
        }
        button:disabled { opacity: 0.4; cursor: not-allowed; border-color: #333; box-shadow: none; }
        .action-btn { width: 100%; margin-bottom: 10px; border-color: var(--accent-gold); padding: 12px; background: linear-gradient(45deg, #2a1a1a, #3d1e1e); }

        /* --- MAIN VIEW --- */
        .room-title { font-family: 'Cinzel', serif; font-size: 2.4em; color: var(--accent-red); text-align: center; margin-bottom: 5px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .room-coords { text-align: center; color: #888; font-size: 0.9em; margin-bottom: 15px; font-family: sans-serif; letter-spacing: 1px; }
        .room-visual {
            height: 180px; background: linear-gradient(180deg, rgba(0,0,0,0.5), rgba(20,69,47,0.2));
            border: 2px solid var(--accent-green); display: flex; align-items: center; justify-content: center;
            font-size: 5em; margin-bottom: 15px; box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            border-radius: 4px;
        }
        .room-desc { font-size: 1.2em; line-height: 1.6; margin-bottom: 15px; text-align: justify; color: #eee; }
        .exits-line { font-size: 0.95em; color: var(--accent-gold); margin-bottom: 20px; border-left: 3px solid var(--accent-red); padding-left: 10px; background: rgba(0,0,0,0.2); padding: 5px 10px; }

        /* --- METERS & TRACKERS --- */
        .meter-container { margin: 15px 0; }
        .meter-label { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px; }
        .meter-bar { height: 10px; background: #111; border-radius: 5px; overflow: hidden; border: 1px solid #444; }
        .meter-fill { height: 100%; transition: width 0.5s; }
        .ghost-fill { background: linear-gradient(90deg, #483d8b, #ff4444); width: 0%; box-shadow: 0 0 10px rgba(255, 68, 68, 0.5); }
        
        .objective-box {
            background: rgba(0,0,0,0.3); border: 1px solid var(--accent-gold); padding: 15px; margin-bottom: 15px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .obj-title { color: var(--accent-gold); font-weight: bold; font-family: 'Cinzel'; margin-bottom: 10px; font-size: 1.1em; text-align: center; border-bottom: 1px solid #444; padding-bottom: 5px;}
        .obj-list { list-style: none; font-size: 1em; }
        .obj-item { margin-bottom: 5px; }
        .obj-item::before { content: '‚ùå '; filter: grayscale(1); }
        .obj-item.done { color: #7ee787; text-decoration: line-through; opacity: 0.7; }
        .obj-item.done::before { content: '‚úÖ '; filter: none; }
        .hint-text { font-style: italic; color: #aaa; font-size: 0.9em; margin-top: 10px; border-top: 1px dashed #444; padding-top: 8px; text-align: center;}

        /* --- INVENTORY --- */
        .inventory-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .inv-item {
            aspect-ratio: 1; border: 1px dashed var(--accent-green);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: help; background: rgba(0,0,0,0.2); transition: 0.3s;
        }
        .inv-item.filled { border-style: solid; border-color: var(--accent-gold); background: radial-gradient(circle, #3d1e1e 0%, #1a0505 100%); }
        .inv-item.empty { opacity: 0.2; cursor: default; }
        .inv-item span { font-size: 0.7em; margin-top: 5px; text-align: center; color: #ddd;}

        /* --- MODALS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #1a0505; border: 3px solid var(--accent-gold); padding: 30px;
            max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;
            position: relative; animation: slideIn 0.4s ease;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
        }
        .modal-box.puzzle { border-color: #8b949e; }
        
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-close { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 1.5em; color: var(--accent-red); transition: 0.2s; }
        .modal-close:hover { transform: scale(1.2); }
        
        .howto-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .key-hint { background: #333; padding: 2px 6px; border-radius: 4px; font-family: monospace; border: 1px solid #555; color: var(--accent-gold); }
        
        .input-dark { width: 100%; padding: 15px; background: #000; color: white; border: 1px solid var(--accent-gold); font-family: 'Cinzel'; text-align: center; font-size: 1.2em; margin-top: 15px; }

        /* --- LOG AREA --- */
        .log-area {
            flex-grow: 1; overflow-y: auto; font-size: 0.95em; color: #ccc;
            border-top: 1px solid var(--border-color); padding-top: 10px;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px;}
        .log-entry.danger { color: #ff7b72; border-left: 2px solid #ff7b72; padding-left: 5px; }
        .log-entry.success { color: #7ee787; border-left: 2px solid #7ee787; padding-left: 5px; }
        .log-entry.info { color: #a5d6ff; }

        .snowflake { position: absolute; color: white; animation: fall linear infinite; pointer-events: none; text-shadow: 0 0 5px white;}
        @keyframes fall { to { transform: translateY(100vh); } }

        @media (max-width: 1000px) {
            .game-wrapper { grid-template-columns: 1fr; height: auto; overflow-y: auto; display: block; }
            .panel { margin-bottom: 20px; height: auto; }
            .map-container { height: 250px; }
        }
    </style>
</head>
<body>

    <div id="help-overlay" class="overlay" style="display: flex;">
        <div class="modal-box">
            <div class="modal-close" onclick="closeHelp()">√ó</div>
            <h2 style="color: var(--accent-gold); font-family: 'Cinzel'; text-align: center; font-size: 2.2em; margin-bottom: 10px;">Die Legende der Winterkrone</h2>
            <p style="text-align: center; margin-bottom: 30px; color: #ccc; font-style: italic;">
                "Wer die drei Edelsteine vereint, bringt das Licht zur√ºck in die l√§ngste Nacht."
            </p>
            
            <div class="howto-grid">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border: 1px solid var(--accent-green);">
                    <h3 style="color: var(--accent-red); margin-bottom: 10px;">üëë Deine Mission</h3>
                    <p>Finde den <strong>Rubin</strong>, <strong>Saphir</strong> und <strong>Smaragd</strong>. Bringe sie zum <strong>Thronsaal</strong>, um den Fluch zu brechen.</p>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border: 1px solid var(--ghost-purple);">
                    <h3 style="color: var(--ghost-purple); margin-bottom: 10px;">üëª Die Gefahr</h3>
                    <p>Der Geist des alten K√∂nigs Albrecht wandelt durch die Hallen. Je mehr du erkundest, desto zorniger wird er.</p>
                </div>
            </div>

            <h3 style="border-bottom: 1px solid #444; padding-bottom: 5px; color: var(--accent-gold);">Steuerung</h3>
            <ul style="list-style: none; line-height: 2; margin-top: 10px;">
                <li><span class="key-hint">W</span> <span class="key-hint">A</span> <span class="key-hint">S</span> <span class="key-hint">D</span> Bewegung (Achte auf HOCH/RUNTER)</li>
                <li><span class="key-hint">E</span> Untersuchen der Umgebung</li>
                <li>Klicke auf <strong>besuchte R√§ume</strong> auf der Karte f√ºr Schnellreise.</li>
            </ul>

            <button class="action-btn" onclick="closeHelp()" style="margin-top: 25px; background: var(--accent-green); color: white; font-size: 1.2em; border: 1px solid var(--accent-gold);">Das Abenteuer beginnen</button>
        </div>
    </div>

    <div id="msg-modal" class="overlay">
        <div class="modal-content modal-box" onclick="event.stopPropagation()" style="text-align: center;">
            <h3 id="msg-title" style="color: var(--accent-gold); margin-bottom: 15px; font-size: 1.8em; font-family: 'Cinzel';"></h3>
            <p id="msg-text" style="font-size: 1.3em; line-height: 1.6; margin-bottom: 20px;"></p>
            <button onclick="closeMsg()" class="action-btn" style="margin-top: 15px;">Weiter</button>
        </div>
    </div>

    <div id="puzzle-modal" class="overlay">
        <div class="modal-box puzzle">
            <div class="modal-close" onclick="closePuzzle()">√ó</div>
            <h2 style="color: #ccc; font-family: 'Cinzel'; text-align: center;">R√ÑTSEL</h2>
            <p id="puzzle-text" style="font-size: 1.3em; margin: 20px 0; text-align: center; color: #fff;">...</p>
            <input type="text" id="puzzle-answer" class="input-dark" placeholder="Deine Antwort..." autocomplete="off">
            <button onclick="submitPuzzleAnswer()" class="action-btn" style="margin-top: 15px;">L√∂sen</button>
        </div>
    </div>

    <div id="ghost-modal" class="overlay">
        <div class="modal-box" style="border-color: var(--ghost-purple); box-shadow: 0 0 40px var(--ghost-purple);">
            <h2 style="color: var(--ghost-purple); font-family: 'Cinzel'; text-align: center; font-size: 2em;">üëÅÔ∏è ALBRECHT ERSCHEINT</h2>
            <p style="text-align:center; color: #aaa; margin-bottom: 10px;">Die Temperatur f√§llt schlagartig...</p>
            <p id="ghost-riddle-text" style="font-size: 1.4em; margin: 20px 0; text-align: center; font-style: italic; color: #fff; text-shadow: 0 0 10px var(--ghost-purple);">...</p>
            <input type="text" id="ghost-answer" class="input-dark" style="border-color: var(--ghost-purple);" placeholder="Deine Antwort..." autocomplete="off">
            <button onclick="submitGhostAnswer()" class="action-btn" style="background: var(--ghost-purple); margin-top: 15px; color: white; border: none;">Antworten oder Leiden</button>
        </div>
    </div>

    <div class="game-wrapper">
        <div class="panel">
            <div class="panel-header">Karte des Schlosses</div>
            <div class="map-wrapper">
                <div class="map-controls">
                    <button class="lvl-btn" id="lvl-btn-m1" onclick="player.mapLevel=-1; updateUI()">Keller (-1)</button>
                    <button class="lvl-btn" id="lvl-btn-0" onclick="player.mapLevel=0; updateUI()">Erdgeschoss (0)</button>
                    <button class="lvl-btn" id="lvl-btn-1" onclick="player.mapLevel=1; updateUI()">Turm (1)</button>
                </div>
                <div class="map-container" id="mini-map"></div>
                <div style="text-align: center; font-size: 0.8em; color: #888; margin-top: 5px; font-style: italic;">Klicke auf besuchte R√§ume f√ºr Schnellreise (+8 Gefahr)</div>
            </div>
            
            <div class="panel-header" style="margin-top: 10px;">Chronik</div>
            <div class="log-area" id="game-log">
                <div class="log-entry info">Die Nacht ist kalt. Du stehst vor dem Tor...</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                Umgebung
                <button class="help-btn" onclick="openHelp()" title="Hilfe">?</button>
            </div>
            
            <h2 id="room-name" class="room-title">Schlosshof</h2>
            <div id="room-coords" class="room-coords">Ebene 0 | Sektor 2-2</div>
            <div id="room-visual" class="room-visual">üè∞</div>
            <div id="room-desc" class="room-desc">...</div>
            <div id="room-exits" class="exits-line">Ausg√§nge: ...</div>
            
            <div id="interaction-area" style="border-top: 1px solid var(--border-color); padding-top: 15px;"></div>
        </div>

        <div class="panel">
            <div class="objective-box">
                <div class="obj-title">Die Winterkrone</div>
                <ul class="obj-list">
                    <li id="obj-ruby" class="obj-item">Blutrubin (Feuer)</li>
                    <li id="obj-sapphire" class="obj-item">Eissaphir (Wasser)</li>
                    <li id="obj-emerald" class="obj-item">Waldsmaragd (Erde)</li>
                </ul>
                <div id="hint-display" class="hint-text">Tipp: Beginne im Schlosshof.</div>
            </div>

            <div class="meter-container">
                <div class="meter-label">
                    <span>Geister-Pr√§senz</span>
                    <span id="ghost-status">Ruhig</span>
                </div>
                <div class="meter-bar">
                    <div id="ghost-meter" class="meter-fill ghost-fill"></div>
                </div>
            </div>

            <div class="d-pad-grid">
                <div></div>
                <button id="btn-n" onclick="move('N')">N</button>
                <div></div>
                <button id="btn-w" onclick="move('W')">W</button>
                <button onclick="explore()" title="Untersuchen (E)" style="background: #3d1e1e; border-color: var(--accent-gold); font-size: 1.2em;">üëÅÔ∏è</button>
                <button id="btn-o" onclick="move('O')">O</button>
                <div></div>
                <button id="btn-s" onclick="move('S')">S</button>
                <div></div>
            </div>

            <div class="vert-controls">
                <button id="btn-u" onclick="move('U')">‚¨Ü HOCH</button>
                <button id="btn-d" onclick="move('D')">‚¨á RUNTER</button>
            </div>

            <div class="panel-header">Rucksack</div>
            <div class="inventory-grid" id="inventory-grid"></div>
        </div>
    </div>

    <div id="snow-container"></div>

    <script>
        /* --- GAME DATA --- */
        const player = {
            room: 'courtyard',
            inventory: [],
            flags: {},
            ghostMeter: 0,
            ghostCooldown: 0,
            visited: ['courtyard'],
            mapLevel: 0,
            questStep: 0
        };

        const items = {
            'rusty_key': { name: 'Rostiger Schl√ºssel', icon: 'üóùÔ∏è', desc: 'Ein schwerer Eisenschl√ºssel. Er riecht nach Moder und Erde.', type: 'key' },
            'silver_key': { name: 'Silberschl√ºssel', icon: 'üóùÔ∏è', desc: 'Filigran gearbeitet, verziert mit einem Turm-Symbol. Eiskalt.', type: 'key' },
            'crowbar': { name: 'Brecheisen', icon: 'üîß', desc: 'Massives Eisenwerkzeug. Perfekt, um vernagelte Kisten oder morsches Mauerwerk zu √∂ffnen.', type: 'tool' },
            'scroll': { name: 'Alte Notiz', icon: 'üìú', desc: 'Eine Warnung des Hofnarren. Rot13 verschl√ºsselt: "Vjre fbg nyyvrf orv anzra araara: Nyoerpug"', type: 'clue' },
            'ruby': { name: 'Blutrubin', icon: 'üíé', desc: 'Er pulsiert warm in deiner Hand wie ein schlagendes Herz.', type: 'gem' },
            'sapphire': { name: 'Eissaphir', icon: 'üíé', desc: 'Ein Stein so klar wie ein gefrorener See im Mondlicht.', type: 'gem' },
            'emerald': { name: 'Waldsmaragd', icon: 'üíé', desc: 'Er leuchtet tiefgr√ºn, als w√§re das Leben selbst darin gefangen.', type: 'gem' }
        };

        // QUEST LOGIC
        const quest = [
            { text: "Gehe in die Gro√üe Halle (N) und untersuche den Tisch (E), um den Kellerschl√ºssel zu finden.", done: () => player.inventory.includes('rusty_key') },
            { text: "Gehe in die K√ºche (O) und untersuche den alten Ofen (E), um ein Werkzeug zu finden.", done: () => player.inventory.includes('crowbar') },
            { text: "√ñffne die Kellert√ºr in der K√ºche (RUNTER). Nutze das Brecheisen beim Fass.", done: () => player.inventory.includes('ruby') },
            { text: "Gehe zur√ºck in den Schlosshof (E). Im Schnee gl√§nzt nun etwas (Silberschl√ºssel).", done: () => player.inventory.includes('silver_key') },
            { text: "√ñffne den Turmeingang (W) und l√∂se das Zahlenr√§tsel in der Bibliothek.", done: () => player.inventory.includes('sapphire') },
            { text: "Steige zur Turmspitze (HOCH) und nimm die Notiz vom Skelett.", done: () => player.inventory.includes('scroll') },
            { text: "Gehe zur√ºck in den Keller. Brich die Wand auf und betritt die Gruft. L√∂se das Namensr√§tsel.", done: () => player.inventory.includes('emerald') },
            { text: "Du hast alle Steine! Gehe zum Thronsaal (N von Halle) und setze die Krone zusammen.", done: () => ['ruby','sapphire','emerald'].every(i=>player.inventory.includes(i)) }
        ];

        const rooms = {
            'courtyard': {
                name: 'Schlosshof', visual: 'üè∞', coords: {x:2, y:2, z:0},
                desc: 'Der Wind heult leise durch die verschneiten Zinnen. Der Vollmond wirft lange, unheimliche Schatten √ºber den gefrorenen Brunnen. Im Norden ragt die Gro√üe Halle auf.',
                exits: { N: 'great_hall', O: 'kitchen', W: 'library_entrance' },
                actions: [
                    { label: "Am Brunnen lauschen", effect: () => {
                        log("Du h√∂rst ein Fl√ºstern: 'Drei Steine... ein Name...'", "info");
                        player.ghostMeter = Math.max(0, player.ghostMeter - 10);
                        showMsg("Der Brunnen", "Das Wasser ist gefroren. Doch das Fl√ºstern beruhigt dich seltsam. (-10 Geister-Pr√§senz)");
                    }}
                ]
            },
            'kitchen': {
                name: 'Alte K√ºche', visual: 'üç≥', coords: {x:3, y:2, z:0},
                desc: 'Ein bei√üender Geruch von kalter Asche und verrottetem Gem√ºse h√§ngt in der Luft. Kupferne T√∂pfe liegen verbeult am Boden.',
                exits: { W: 'courtyard', D: 'cellar' },
                lockedExits: { D: {key: 'rusty_key', msg: 'Die schwere Eichent√ºr zum Keller ist fest verschlossen.'} },
                search: [
                    { give: 'crowbar', msg: 'In einem erkalteten Ofen entdeckst du ein massives Brecheisen!' },
                    { msg: 'Du findest nur kalte Asche und Knochenreste. Ein unheimlicher Ort.' }
                ]
            },
            'cellar': {
                name: 'Weinkeller', visual: 'üç∑', coords: {x:3, y:2, z:-1},
                desc: 'Es ist stockfinster und feucht. Uralte Weinf√§sser stapeln sich. An der Nordwand sp√ºrst du einen Luftzug.',
                exits: { U: 'kitchen' },
                interact: [
                    { label: 'Hohles Fass √∂ffnen', req: 'crowbar', result: 'get_ruby', msg: 'Mit einem lauten Krachen zersplittert das Holz. Im Bodensatz funkelt der Blutrubin!' },
                    { label: 'Wand einrei√üen', req: 'crowbar', action: 'open_dungeon', msg: 'Du schl√§gst gegen die lockeren Steine. Die Wand st√ºrzt ein!' }
                ],
                search: [{ msg: 'Der Boden ist klebrig vom alten Wein. Nichts weiter zu finden.' }]
            },
            'great_hall': {
                name: 'Gro√üe Halle', visual: 'üïØÔ∏è', coords: {x:2, y:1, z:0},
                desc: 'Staub tanzt in den Mondstrahlen. Lange Tafeln sind gedeckt f√ºr G√§ste, die l√§ngst zerfallen sind.',
                exits: { S: 'courtyard', N: 'throne_room' },
                search: [
                    { give: 'rusty_key', msg: 'Unter einem verstaubten Zinnteller findest du einen rostigen Schl√ºssel.' },
                    { msg: 'Die Teller sind leer. Nur Staub und Spinnweben.' }
                ],
                actions: [
                    { label: "G√§stebuch lesen", effect: () => {
                        showMsg("G√§stebuch", "Letzter Eintrag: 'K√∂nig Albrecht schloss die Krone weg. Wer seinen Namen ausspricht, findet den letzten Stein.'");
                        log("Du lernst: Der Name ist der Schl√ºssel zur Gruft.", "info");
                    }}
                ]
            },
            'throne_room': {
                name: 'Thronsaal', visual: 'üëë', coords: {x:2, y:0, z:0},
                desc: 'Eine unnat√ºrliche K√§lte herrscht hier. Der goldene Thron ist leer, doch die Fassung f√ºr die Winterkrone wartet.',
                exits: { S: 'great_hall' },
                interact: [{ label: 'Krone zusammensetzen', action: 'win_check' }],
                actions: [
                    { label: "Thron untersuchen", effect: () => {
                        showMsg("Der Thron", "Eine leere Fassung. Drei Vertiefungen: rot, blau, gr√ºn. Endlich ergibt alles Sinn.");
                        log("Hier m√ºssen die drei Steine hin.", "info");
                    }}
                ]
            },
            'library_entrance': {
                name: 'Turmeingang', visual: 'üö™', coords: {x:1, y:2, z:0},
                desc: 'Der Vorraum zum Turm. Eine massive T√ºr mit Silberbeschl√§gen versperrt den Weg nach Westen.',
                exits: { O: 'courtyard', W: 'library' },
                lockedExits: { W: {key: 'silver_key', msg: 'Die T√ºr hat kein Schl√ºsselloch, nur eine silberne Vertiefung.'} }
            },
            'library': {
                name: 'Bibliothek', visual: 'üìö', coords: {x:0, y:2, z:0},
                desc: 'Der Geruch von altem Pergament erf√ºllt den Raum. Regale voller B√ºcher ragen bis zur Decke.',
                exits: { O: 'library_entrance', U: 'tower_top' },
                puzzle: { q: 'Ein Logik-R√§tsel versperrt eine Vitrine: 2, 4, 8, 16, ... Welche Zahl folgt?', a: '32', reward: 'sapphire' },
                actions: [
                    { label: "Buch 'Kryptographie' lesen", effect: () => {
                        showMsg("Kryptographie-Band", "Hinweis: Rot13 ist ein Verschiebechiffre. A wird zu N, B zu O... (+13 Buchstaben).");
                        log("Das hilft dir sicher bei der Notiz!", "success");
                    }}
                ]
            },
            'tower_top': {
                name: 'Turmspitze', visual: 'üåô', coords: {x:0, y:2, z:1},
                desc: 'Der eisige Wind rei√üt an dir. Ein Skelett sitzt an die Zinnen gelehnt.',
                exits: { D: 'library' },
                search: [
                    { give: 'scroll', msg: 'Du nimmst dem Skelett vorsichtig die verschl√ºsselte Notiz aus den Fingern.' },
                    { msg: 'Der Wind ist hier oben zu stark. Nichts weiter zu finden.' }
                ]
            },
            'dungeon': {
                name: 'Verlies', visual: '‚õìÔ∏è', coords: {x:3, y:1, z:-1},
                desc: 'Rostige Ketten, glitschiger Boden. Ein enger Tunnel f√ºhrt weiter nach Norden.',
                exits: { N: 'crypt', S: 'cellar' },
                search: [{ msg: 'Nur Ratten und alte Knochen.' }]
            },
            'crypt': {
                name: 'Familiengruft', visual: '‚ö∞Ô∏è', coords: {x:3, y:0, z:-1},
                desc: 'Die Luft ist schwer. Hier ruhen die Ahnen. Aus einem offenen Grab dringt ein gr√ºnes Leuchten.',
                exits: { S: 'dungeon' },
                puzzle: { q: 'Eine Stimme fl√ºstert: "Nenne meinen Namen!" (Hinweis: Notiz + Rot13)', a: 'ALBRECHT', reward: 'emerald' }
            }
        };

        /* --- ENGINE --- */
        function init() {
            createSnow();
            updateUI();
            
            // Global controls
            document.addEventListener('keydown', (e) => {
                if (isModalOpen()) return;
                const k = e.key.toLowerCase();
                if(k === 'w' || k === 'arrowup') move('N');
                if(k === 's' || k === 'arrowdown') move('S');
                if(k === 'a' || k === 'arrowleft') move('W');
                if(k === 'd' || k === 'arrowright') move('O');
                if(k === 'e') explore();
            });

            // Enter key inputs
            ['puzzle-answer', 'ghost-answer'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('keydown', (e) => {
                        if(e.key === 'Enter') {
                            if(id === 'puzzle-answer') submitPuzzleAnswer();
                            else submitGhostAnswer();
                        }
                    });
                }
            });
        }

        function isModalOpen() {
            return ['help-overlay', 'msg-modal', 'puzzle-modal', 'ghost-modal']
                .some(id => window.getComputedStyle(document.getElementById(id)).display === 'flex');
        }

        function createSnow() {
            const c = document.getElementById('snow-container');
            for(let i=0; i<60; i++){
                let s = document.createElement('div');
                s.className = 'snowflake'; s.innerHTML = '‚ùÑ';
                s.style.left = Math.random()*100+'vw';
                s.style.fontSize = (8 + Math.random()*14) + 'px';
                s.style.animationDuration = (4+Math.random()*5)+'s';
                s.style.animationDelay = '-' + (Math.random()*5) + 's';
                s.style.opacity = 0.2 + Math.random()*0.5;
                c.appendChild(s);
            }
        }

        function updateUI() {
            const r = rooms[player.room];
            
            // Header Info
            document.getElementById('room-name').innerText = r.name;
            document.getElementById('room-coords').innerText = `Ebene ${r.coords.z} | Sektor ${r.coords.x}-${r.coords.y}`;
            document.getElementById('room-visual').innerText = r.visual;
            document.getElementById('room-desc').innerText = r.desc;
            
            // Exits Line
            let exitText = [];
            const labels = {N:'Norden', S:'S√ºden', O:'Osten', W:'Westen', U:'Oben', D:'Unten'};
            ['N','S','O','W','U','D'].forEach(dir => {
                if(r.exits[dir]) exitText.push(labels[dir]);
                else if(r.lockedExits && r.lockedExits[dir]) exitText.push(`${labels[dir]} (Verschlossen)`);
            });
            document.getElementById('room-exits').innerText = "Ausg√§nge: " + (exitText.length ? exitText.join(', ') : 'Keine offensichtlichen.');

            // Buttons enable/disable
            ['n','s','o','w','u','d'].forEach(d => {
                const btn = document.getElementById(`btn-${d}`);
                const dir = d.toUpperCase();
                const hasExit = r.exits[dir] || (r.lockedExits && r.lockedExits[dir]);
                btn.disabled = !hasExit;
                btn.style.opacity = hasExit ? 1 : 0.3;
            });

            // Interaction Area
            const area = document.getElementById('interaction-area');
            area.innerHTML = '';
            
            // Puzzle?
            if(r.puzzle && !player.flags[r.puzzle.reward + '_got']) {
                let b = document.createElement('button');
                b.className = 'action-btn'; b.innerText = 'üß© R√§tsel untersuchen';
                b.onclick = () => openPuzzleModal(r.puzzle);
                area.appendChild(b);
            }

            // Specific Interactions
            if(r.interact) {
                r.interact.forEach(act => {
                    if(act.action === 'open_dungeon' && rooms['cellar'].exits['N']) return;
                    if(act.result === 'get_ruby' && player.inventory.includes('ruby')) return;
                    let b = document.createElement('button');
                    b.className = 'action-btn'; b.innerText = `‚öôÔ∏è ${act.label}`;
                    b.onclick = () => handleInteract(act);
                    area.appendChild(b);
                });
            }

            // Room Actions (Lore/Flavor)
            if(r.actions) {
                r.actions.forEach(a => {
                    let b = document.createElement('button');
                    b.className = 'action-btn'; b.innerText = `üìñ ${a.label}`;
                    b.onclick = () => { 
                        player.ghostMeter += 6;
                        a.effect();
                        updateGhostMeterUI();
                        updateUI();
                    };
                    area.appendChild(b);
                });
            }

            renderMap(player.mapLevel);
            updateObjectives();
            renderInventory();
        }

        function renderMap(level) {
            const map = document.getElementById('mini-map');
            const btnID = level === -1 ? 'lvl-btn-m1' : 'lvl-btn-' + level;
            document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(btnID);
            if(activeBtn) activeBtn.classList.add('active');

            map.innerHTML = '';
            
            for(let y=0; y<5; y++) {
                for(let x=0; x<5; x++) {
                    let node = document.createElement('div');
                    node.className = 'map-node fog';
                    
                    let roomKey = Object.keys(rooms).find(k => 
                        rooms[k].coords.x === x && rooms[k].coords.y === y && rooms[k].coords.z === level
                    );

                    if(roomKey) {
                        const r = rooms[roomKey];
                        const isVisited = player.visited.includes(roomKey);
                        const isCurrent = player.room === roomKey;

                        // Fog adjacency
                        let neighborVisited = false;
                        if (!isVisited) {
                             const neighbors = Object.keys(rooms).filter(k => {
                                 const nr = rooms[k];
                                 if (nr.coords.z !== level) return false;
                                 return (Math.abs(nr.coords.x - x) + Math.abs(nr.coords.y - y)) === 1;
                             });
                             neighborVisited = neighbors.some(nk => player.visited.includes(nk));
                        }

                        if (isCurrent) {
                            node.className = 'map-node active';
                            node.innerText = r.visual;
                        } else if (isVisited) {
                            node.className = 'map-node visited';
                            node.innerText = r.visual;
                            node.onclick = () => fastTravel(roomKey);
                            node.title = r.name + " (Schnellreise)";
                            
                            let hasLock = false;
                            if (r.lockedExits) {
                                hasLock = Object.values(r.lockedExits).some(lock => !player.inventory.includes(lock.key));
                            }
                            if (hasLock) {
                                let lock = document.createElement('span');
                                lock.className = 'lock-icon'; lock.innerText='üîí';
                                node.appendChild(lock);
                            }
                        } else if (neighborVisited) {
                            node.className = 'map-node seen';
                            node.innerText = '?';
                        }
                    }
                    map.appendChild(node);
                }
            }
        }

        function move(dir) {
            const r = rooms[player.room];
            
            if(r.lockedExits && r.lockedExits[dir]) {
                const lock = r.lockedExits[dir];
                if(player.inventory.includes(lock.key)) {
                    log('Der Schl√ºssel passt! Die T√ºr √∂ffnet sich knarrend.', 'success');
                    player.room = r.exits[dir];
                    visitRoom();
                } else {
                    log(lock.msg, 'danger');
                }
                return;
            }

            if(r.exits[dir]) {
                player.room = r.exits[dir];
                player.ghostMeter += 5; 
                visitRoom();
            }
        }

        function fastTravel(targetRoom) {
            if (targetRoom === player.room) return;
            log('Du eilst durch bekannte G√§nge...', 'info');
            player.ghostMeter += 8; 
            player.room = targetRoom;
            player.mapLevel = rooms[player.room].coords.z;
            checkGhost();
            updateUI();
        }

        function visitRoom() {
            if(!player.visited.includes(player.room)) {
                player.visited.push(player.room);
                player.ghostMeter += 10;
            }
            player.mapLevel = rooms[player.room].coords.z;
            checkGhost();
            updateUI();
        }

        function explore() {
            const r = rooms[player.room];
            player.ghostMeter += 12;
            updateGhostMeterUI();

            // 1. Check Search Array (Contextual)
            if (r.search) {
                for (const entry of r.search) {
                    if (entry.give) {
                        const already = player.inventory.includes(entry.give);
                        if (already) continue; // skip this entry if already got item
                        
                        player.inventory.push(entry.give);
                        log(entry.msg, 'success');
                        showMsg('Gefunden!', entry.msg);
                        updateUI();
                        return;
                    } else {
                        // flavor message (always shown if no item found/left)
                        log(entry.msg, 'info');
                        showMsg('Untersucht', entry.msg);
                        checkGhost(true);
                        return;
                    }
                }
            }

            // 2. Secret Key (Courtyard special)
            if(player.room === 'courtyard' && player.visited.includes('great_hall') && !player.inventory.includes('silver_key')) {
                player.inventory.push('silver_key');
                log('Im tiefen Schnee gl√§nzt etwas: Ein Silberschl√ºssel!', 'success');
                showMsg('Gefunden', 'Der Silberschl√ºssel lag im Schnee vergraben.');
                updateUI();
                return;
            }

            // Fallback
            log('Du findest nichts Auff√§lliges.', 'info');
            checkGhost(true);
        }

        function handleInteract(act) {
            if(act.req && !player.inventory.includes(act.req)) {
                log('Dir fehlt das passende Werkzeug: ' + items[act.req].name, 'danger');
                return;
            }

            if(act.action === 'open_dungeon') {
                rooms['cellar'].exits['N'] = 'dungeon';
                log('Die Wand st√ºrzt ein. Ein modriger Geruch str√∂mt dir entgegen.', 'success');
                updateUI();
            } 
            else if(act.result === 'get_ruby') {
                player.inventory.push('ruby');
                log('Du h√§ltst den Blutrubin in H√§nden!', 'success');
                showMsg('Edelstein', 'Der Blutrubin geh√∂rt dir.');
                updateUI();
            }
            else if(act.action === 'win_check') {
                if(['ruby','sapphire','emerald'].every(i => player.inventory.includes(i))) {
                    document.body.innerHTML = '<div style="display:flex;height:100vh;justify-content:center;align-items:center;background:#050a14;color:var(--accent-gold);flex-direction:column;text-align:center;"><h1 style="font-family:Cinzel;font-size:4em;color:var(--accent-gold);text-shadow:0 0 20px gold;">FLUCH GEBROCHEN</h1><p style="font-size:1.5em;color:#ccc;max-width:600px;margin:20px;">Das Schloss erstrahlt in neuem Glanz. Die Geister finden Frieden.</p><button onclick="location.reload()" style="padding:15px 30px;font-size:1.2em;cursor:pointer;background:var(--accent-green);color:white;border:2px solid gold;">Erneut spielen</button></div>';
                } else {
                    log('Die Krone ist noch unvollst√§ndig. Dir fehlen Edelsteine.', 'danger');
                }
            }
        }

        /* --- PUZZLE SYSTEM --- */
        let activePuzzle = null;
        function openPuzzleModal(puzzle) {
            activePuzzle = puzzle;
            document.getElementById('puzzle-text').innerText = puzzle.q;
            document.getElementById('puzzle-modal').style.display = 'flex';
            document.getElementById('puzzle-answer').value = '';
            document.getElementById('puzzle-answer').focus();
        }

        function closePuzzle() {
            document.getElementById('puzzle-modal').style.display = 'none';
            activePuzzle = null;
        }

        function submitPuzzleAnswer() {
            if(!activePuzzle) return;
            let ans = document.getElementById('puzzle-answer').value.toUpperCase().trim();
            closePuzzle();
            
            if(ans === activePuzzle.a) {
                player.inventory.push(activePuzzle.reward);
                player.flags[activePuzzle.reward + '_got'] = true;
                log('Richtig! Du erh√§ltst: ' + items[activePuzzle.reward].name, 'success');
                showMsg('Gel√∂st!', 'Ein geheimes Fach √∂ffnet sich.');
                updateUI();
            } else {
                log('Falsch. Ein kaltes Lachen hallt durch den Raum...', 'danger');
                player.ghostMeter += 25;
                checkGhost(true);
            }
        }

        /* --- GHOST SYSTEM --- */
        function checkGhost(force = false) {
            if(player.ghostCooldown > 0) {
                player.ghostCooldown--;
                updateGhostMeterUI();
                return;
            }

            if(player.ghostMeter > 100) player.ghostMeter = 100;
            updateGhostMeterUI();

            if(player.ghostMeter < 15 && !force) return;

            let chance = player.ghostMeter / 160; 
            if(force) chance += 0.2;

            if(Math.random() < chance && player.room !== 'dungeon' && player.room !== 'crypt') {
                spawnGhost();
            }
        }

        function updateGhostMeterUI() {
            const bar = document.getElementById('ghost-meter');
            const txt = document.getElementById('ghost-status');
            bar.style.width = player.ghostMeter + '%';
            
            if(player.ghostMeter < 30) txt.innerText = "Ruhig";
            else if(player.ghostMeter < 70) { txt.innerText = "Unheimlich"; txt.style.color="orange"; }
            else { txt.innerText = "GEFAHR"; txt.style.color="#ff4444"; }
        }

        const riddles = [
            {q:"Ich habe St√§dte, aber keine H√§user. Gebirge, aber keine B√§ume. Was bin ich?", a:"KARTE", pen:"teleport"},
            {q:"Je mehr du von mir wegnimmst, desto gr√∂√üer werde ich. Was bin ich?", a:"LOCH", pen:"steal"},
            {q:"Ich habe keine Stimme, doch ich heule. Ich habe keine Fl√ºgel, doch ich fliege. Was bin ich?", a:"WIND", pen:"steal"}
        ];
        let currentRiddle = null;

        function spawnGhost() {
            if(document.getElementById('ghost-modal').style.display === 'flex') return;
            currentRiddle = riddles[Math.floor(Math.random()*riddles.length)];
            document.getElementById('ghost-riddle-text').innerText = currentRiddle.q;
            document.getElementById('ghost-modal').style.display = 'flex';
            document.getElementById('ghost-answer').value = '';
            document.getElementById('ghost-answer').focus();
        }

        function submitGhostAnswer() {
            const val = document.getElementById('ghost-answer').value.toUpperCase().trim();
            document.getElementById('ghost-modal').style.display = 'none';
            
            if(val === currentRiddle.a) {
                log('Der Geist nickt respektvoll und verschwindet im Nebel.', 'success');
                player.ghostMeter = 0;
                player.ghostCooldown = 6; 
                showMsg("Albrecht", "Er fl√ºstert: 'Suche dort, wo Feuer ruht...' (Hinweis: Untersuche den Ofen oder den Kamin).");
            } else {
                log('FALSCHE ANTWORT! Albrecht ist erz√ºrnt!', 'danger');
                if(currentRiddle.pen === 'teleport') {
                    player.room = 'dungeon';
                    player.visited.push('dungeon');
                    player.mapLevel = -1;
                    log('Alles dreht sich... Du wachst im kalten Verlies auf.', 'danger');
                } else {
                    // Safe Steal
                    const stealable = player.inventory.filter(i => !i.includes('key') && items[i].type !== 'gem');
                    
                    if(stealable.length > 0) {
                        let itemID = stealable[Math.floor(Math.random()*stealable.length)];
                        player.inventory = player.inventory.filter(i => i !== itemID);
                        rooms['courtyard'].search = [{give:itemID, msg: `Du findest dein ${items[itemID].name} im Schnee wieder.`}]; 
                        log(`${items[itemID].name} wurde gestohlen! Der Geist hat es im Schlosshof versteckt.`, 'danger');
                    } else {
                         player.room = 'dungeon'; 
                         player.mapLevel = -1;
                         log('Der Geist findet nichts zu stehlen und schleudert dich ins Verlies!', 'danger');
                    }
                }
                player.ghostMeter = 50;
                player.ghostCooldown = 3;
            }
            updateUI();
        }

        /* --- HELPER UI --- */
        function log(msg, type) {
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = '> ' + msg;
            const area = document.getElementById('game-log');
            area.prepend(div);
            if(area.childElementCount > 50) area.lastChild.remove();
        }

        function updateObjectives() {
            // Mark gems done
            ['ruby','sapphire','emerald'].forEach(gem => {
                const el = document.getElementById('obj-'+gem);
                if(player.inventory.includes(gem)) el.classList.add('done');
            });

            // Advance Quest Step
            while (player.questStep < quest.length && quest[player.questStep].done()) {
                player.questStep++;
            }

            const h = document.getElementById('hint-display');
            if(player.questStep >= quest.length) {
                h.innerText = "Setze die Krone zusammen!";
            } else {
                h.innerText = "Tipp: " + quest[player.questStep].text;
            }
        }

        function renderInventory() {
            const g = document.getElementById('inventory-grid');
            g.innerHTML = '';
            player.inventory.forEach(k => {
                let d = document.createElement('div');
                d.className = 'inv-item filled';
                d.innerHTML = `${items[k].icon}<span>${items[k].name}</span>`;
                d.onclick = () => showMsg(items[k].name, items[k].desc);
                g.appendChild(d);
            });
            for(let i=player.inventory.length; i<8; i++) {
                let d = document.createElement('div');
                d.className = 'inv-item empty';
                g.appendChild(d);
            }
        }

        function openHelp() { document.getElementById('help-overlay').style.display = 'flex'; }
        function closeHelp() { document.getElementById('help-overlay').style.display = 'none'; }
        function showMsg(t, m) {
            document.getElementById('msg-title').innerText = t;
            document.getElementById('msg-text').innerText = m;
            document.getElementById('msg-modal').style.display = 'flex';
        }
        function closeMsg() { document.getElementById('msg-modal').style.display = 'none'; }

        init();
    </script>
</body>
</html>
