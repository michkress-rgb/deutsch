<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Das R√§tsel der Winterkrone ‚Äì Festive Edition</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@500;700&display=swap');

    :root{
      /* Festive / Winter Day Palette */
      --bg-sky-1:#eaf6ff;
      --bg-sky-2:#cfe9ff;
      --panel:#ffffffcc;
      --panel-strong:#ffffffee;
      --ink:#1f2a37;
      --muted:#5b728a;

      --red:#d13a3a;
      --green:#2a8c5a;
      --gold:#f2c94c;
      --blue:#2f80ed;
      --purple:#7b68ee;

      --border:#b8d7ee;
      --shadow: 0 10px 30px rgba(31,42,55,.12);
      --shadow-strong: 0 16px 50px rgba(31,42,55,.16);

      --btn:#f7fbff;
      --btn-border:#9fc9e6;

      --danger:#ff6b6b;
      --safe:#2a8c5a;
      --secret:#2f80ed;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Cormorant Garamond', serif;
      font-size:18px;
      color:var(--ink);
      height:100vh;
      overflow:hidden;
      background: radial-gradient(circle at 30% 20%, var(--bg-sky-1), var(--bg-sky-2));
      user-select:none;
    }

    .game-wrapper{
      display:grid;
      grid-template-columns: 330px 1fr 330px;
      gap:16px;
      max-width: 1700px;
      height: 96vh;
      margin: 2vh auto;
      padding: 0 16px;
      position:relative;
      z-index:2;
    }

    .panel{
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      backdrop-filter: blur(8px);
    }

    .panel-header{
      font-family:'Cinzel', serif;
      font-weight:700;
      letter-spacing:.5px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding-bottom:10px;
      margin-bottom:12px;
      border-bottom: 2px dashed rgba(159,201,230,.7);
      color: var(--red);
      text-shadow: 0 1px 0 rgba(255,255,255,.8);
    }

    .help-btn{
      background: var(--btn);
      border: 2px solid var(--btn-border);
      border-radius: 999px;
      width: 34px;
      height: 34px;
      cursor:pointer;
      font-family: 'Cinzel';
      font-weight:700;
      color: var(--ink);
      box-shadow: 0 4px 0 rgba(31,42,55,.08);
    }
    .help-btn:active{ transform: translateY(2px); box-shadow:none; }

    /* MAP */
    .map-controls{display:flex;gap:8px;justify-content:center;margin-bottom:8px;flex-wrap:wrap;}
    .lvl-btn{
      background: var(--btn);
      border: 2px solid var(--btn-border);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
      font-family:'Cinzel';
      cursor:pointer;
      box-shadow: 0 4px 0 rgba(31,42,55,.08);
      font-size:.95em;
    }
    .lvl-btn.active{
      border-color: var(--gold);
      color: var(--ink);
      background: #fff7db;
    }
    .lvl-btn:active{ transform: translateY(2px); box-shadow:none; }

    .map-container{
      height: 220px;
      background: #ffffffaa;
      border: 2px solid rgba(159,201,230,.9);
      border-radius: 14px;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap: 6px;
      padding: 10px;
    }
    .map-node{
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 1.35em;
      transition: .2s;
      border: 2px dashed transparent;
      background: transparent;
      color: rgba(31,42,55,.25);
      position:relative;
    }
    .map-node.fog{ opacity:0; pointer-events:none; }
    .map-node.seen{
      background: rgba(47,128,237,.08);
      border-color: rgba(47,128,237,.25);
      color: rgba(31,42,55,.5);
    }
    .map-node.visited{
      background: rgba(42,140,90,.12);
      border-color: rgba(42,140,90,.35);
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(31,42,55,.06);
    }
    .map-node.visited:hover{
      transform: translateY(-2px);
      border-color: rgba(242,201,76,.8);
    }
    .map-node.active{
      background: #fff7db;
      border: 2px solid rgba(242,201,76,.95);
      box-shadow: 0 10px 18px rgba(242,201,76,.25);
      color: var(--ink);
    }
    .lock-icon{
      position:absolute;
      bottom:-7px; right:-7px;
      background:#fff;
      border: 2px solid rgba(209,58,58,.55);
      border-radius:999px;
      width: 24px; height: 24px;
      display:flex; align-items:center; justify-content:center;
      font-size:.85em;
    }

    /* MAIN VIEW */
    .main-panel{ display:flex; flex-direction:column; }
    .room-title{
      font-family:'Cinzel', serif;
      font-size: 2.6em;
      text-align:center;
      margin-bottom:6px;
      color: var(--red);
    }
    .room-coords{
      text-align:center;
      color: var(--muted);
      margin-bottom:12px;
      letter-spacing: 1px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: .92em;
    }
    .room-visual{
      height: 210px;
      border-radius: 18px;
      border: 3px solid rgba(159,201,230,.9);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(234,246,255,.95));
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 6em;
      box-shadow: inset 0 0 40px rgba(47,128,237,.10);
      position:relative;
      overflow:hidden;
      margin-bottom: 14px;
    }
    .sparkle{
      position:absolute;
      top:-20px;
      left:-20px;
      width: 120%;
      height: 120%;
      background: radial-gradient(circle at 20% 30%, rgba(242,201,76,.25), transparent 40%),
                  radial-gradient(circle at 70% 60%, rgba(47,128,237,.18), transparent 45%),
                  radial-gradient(circle at 50% 80%, rgba(42,140,90,.15), transparent 45%);
      filter: blur(0px);
      pointer-events:none;
      opacity:.9;
      animation: floaty 6s ease-in-out infinite;
    }
    @keyframes floaty{ 0%{transform:translate(0,0)} 50%{transform:translate(10px,8px)} 100%{transform:translate(0,0)} }

    .room-desc{
      background: var(--panel-strong);
      border: 2px solid rgba(159,201,230,.55);
      border-radius: 14px;
      padding: 12px 14px;
      line-height: 1.55;
      margin-bottom: 12px;
    }
    .exits-line{
      background: #fff;
      border: 2px dashed rgba(209,58,58,.35);
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 14px;
      color: var(--ink);
    }

    /* CONTROLS */
    button{
      background: var(--btn);
      border: 2px solid var(--btn-border);
      border-radius: 14px;
      padding: 12px 12px;
      cursor:pointer;
      font-family:'Cinzel', serif;
      font-size: 1em;
      color: var(--ink);
      box-shadow: 0 6px 0 rgba(31,42,55,.08);
      transition:.15s;
    }
    button:hover:not(:disabled){ transform: translateY(-2px); }
    button:active{ transform: translateY(2px); box-shadow:none; }
    button:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .action-btn{
      width:100%;
      margin-bottom:10px;
      text-align:left;
      background: #ffffff;
    }

    .d-pad-grid{
      display:grid;
      grid-template-columns: repeat(3,1fr);
      gap:10px;
      margin-top: 10px;
      margin-bottom:10px;
    }
    .vert-controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .search-btn{
      border-color: rgba(242,201,76,.9);
      background: #fff7db;
      font-size: 1.25em;
    }

    /* RIGHT PANEL: QUEST + SCANNER + POWERS */
    .objective-box{
      background: #ffffff;
      border: 2px solid rgba(242,201,76,.7);
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 10px 18px rgba(242,201,76,.12);
    }
    .obj-title{
      font-family:'Cinzel';
      text-align:center;
      color: var(--ink);
      margin-bottom:10px;
    }
    .obj-list{ list-style:none; }
    .obj-item{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 7px 8px;
      border-radius: 12px;
      border: 2px solid rgba(159,201,230,.35);
      margin-bottom:8px;
      background: rgba(234,246,255,.7);
    }
    .obj-item.done{
      border-color: rgba(42,140,90,.35);
      background: rgba(42,140,90,.10);
      opacity:.95;
      text-decoration: line-through;
    }
    .hint-text{
      margin-top:10px;
      padding-top:10px;
      border-top: 2px dashed rgba(159,201,230,.6);
      color: var(--muted);
      font-style: italic;
      text-align:center;
    }

    .scanner-box{
      background:#fff;
      border: 2px solid rgba(159,201,230,.65);
      border-radius:16px;
      padding: 12px;
      margin-bottom:12px;
    }
    .scanner-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:center;
      margin-bottom:10px;
    }
    .seg label{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 12px;
      border: 2px solid rgba(159,201,230,.5);
      background: rgba(234,246,255,.55);
      font-family: 'Cinzel';
      font-size: .92em;
    }
    .seg input{ accent-color: var(--blue); }

    .meter-bar{
      height: 14px;
      background: rgba(31,42,55,.08);
      border-radius: 999px;
      overflow:hidden;
      border: 2px solid rgba(159,201,230,.5);
    }
    .meter-fill{
      height:100%;
      width:0%;
      transition: width .4s;
    }
    .meter-fill.danger{ background: linear-gradient(90deg, rgba(255,107,107,.55), rgba(255,107,107,.95)); }
    .meter-fill.secret{ background: linear-gradient(90deg, rgba(47,128,237,.45), rgba(47,128,237,.95)); }

    .powers{
      background:#fff;
      border: 2px solid rgba(159,201,230,.65);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .powers h3{
      font-family:'Cinzel';
      text-align:center;
      margin-bottom:10px;
      color: var(--purple);
    }
    .power-btn{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      background: #f6f3ff;
      border-color: rgba(123,104,238,.35);
    }
    .power-btn strong{ font-family:'Cinzel'; }

    /* INVENTORY */
    .inv-header{ margin-top: 10px; }
    .inventory-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .inv-item{
      aspect-ratio: 1;
      border-radius: 14px;
      border: 2px dashed rgba(159,201,230,.9);
      background: rgba(234,246,255,.55);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding: 8px;
      cursor: help;
      text-align:center;
    }
    .inv-item.filled{
      border-style: solid;
      border-color: rgba(242,201,76,.9);
      background: #fff7db;
      box-shadow: 0 10px 16px rgba(242,201,76,.12);
    }
    .inv-item.empty{ opacity:.35; cursor: default; }
    .inv-item span{ font-size:.85em; font-weight:700; margin-top:6px; }

    /* LOG */
    .log-area{
      margin-top: 10px;
      flex-grow: 1;
      overflow:auto;
      padding-right: 4px;
    }
    .log-entry{
      background: rgba(255,255,255,.75);
      border: 2px solid rgba(159,201,230,.45);
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      font-size: .95em;
    }
    .log-entry.good{ border-color: rgba(42,140,90,.35); }
    .log-entry.warn{ border-color: rgba(209,58,58,.35); }
    .log-entry.info{ border-color: rgba(47,128,237,.25); }

    /* MODALS */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
      padding: 18px;
    }
    .modal-box{
      width:min(760px, 96vw);
      max-height: 90vh;
      overflow:auto;
      background: #ffffffee;
      border: 3px solid rgba(242,201,76,.85);
      border-radius: 18px;
      box-shadow: var(--shadow-strong);
      padding: 18px 18px 16px;
      position:relative;
    }
    .modal-close{
      position:absolute;
      top: 10px; right: 12px;
      border: none;
      background: transparent;
      font-size: 28px;
      cursor:pointer;
      color: var(--red);
      box-shadow:none;
      padding: 6px 10px;
      border-radius: 12px;
    }
    .modal-close:hover{ background: rgba(209,58,58,.08); }

    .input-dark{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 2px solid rgba(159,201,230,.85);
      font-family: 'Cinzel';
      font-size: 1.1em;
      text-align:center;
      margin-top: 10px;
      background: #fff;
    }

    /* Snow */
    .snowflake{
      position:absolute;
      top:-20px;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 8px rgba(47,128,237,.25);
      pointer-events:none;
      animation: fall linear infinite;
    }
    @keyframes fall{ to{ transform: translateY(110vh); } }

    @media (max-width: 1100px){
      body{ overflow:auto; height:auto; }
      .game-wrapper{ grid-template-columns: 1fr; height:auto; }
    }
  </style>
</head>
<body>

  <!-- HELP MODAL -->
  <div id="help-overlay" class="overlay" style="display:flex;">
    <div class="modal-box">
      <button class="modal-close" onclick="closeHelp()" aria-label="Schlie√üen">√ó</button>
      <h2 style="font-family:'Cinzel'; color: var(--red); text-align:center; margin-bottom:8px;">
        Das R√§tsel der Winterkrone ‚Äì Festive Edition
      </h2>
      <p style="text-align:center; color: var(--muted); margin-bottom:14px;">
        Ein kurzes, leichtes Abschluss-Abenteuer f√ºr die letzte Stunde: sammeln, knobeln, lachen.
      </p>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
        <div style="background:#fff; border:2px solid rgba(42,140,90,.25); border-radius:14px; padding:12px;">
          <h3 style="font-family:'Cinzel'; color: var(--green); margin-bottom:6px;">Ziel</h3>
          <p>Finde <strong>Rubin</strong>, <strong>Saphir</strong>, <strong>Smaragd</strong> und setze im <strong>Thronsaal</strong> die Krone zusammen.</p>
        </div>
        <div style="background:#fff; border:2px solid rgba(47,128,237,.25); border-radius:14px; padding:12px;">
          <h3 style="font-family:'Cinzel'; color: var(--blue); margin-bottom:6px;">Scanner</h3>
          <p>W√§hle <strong>Gefahr</strong> oder <strong>Geheimnisse</strong> ‚Äì nur eins gleichzeitig. Geheimnisse zeigt dir, ob hier noch etwas zu entdecken ist.</p>
        </div>
      </div>

      <div style="background:#fff; border:2px solid rgba(123,104,238,.25); border-radius:14px; padding:12px; margin-bottom:12px;">
        <h3 style="font-family:'Cinzel'; color: var(--purple); margin-bottom:6px;">Superkr√§fte</h3>
        <ul style="margin-left: 18px; line-height:1.45;">
          <li><strong>üéÅ Geschenk-Sprung</strong>: Teleport zu jedem besuchten Raum. L√§dt sich im <strong>Schlosshof</strong> wieder auf.</li>
          <li><strong>‚ú® Schneekugel-Schutz</strong>: senkt Unfug-Meter & gibt extra Hinweise. L√§dt sich in der <strong>K√ºche</strong> auf.</li>
        </ul>
      </div>

      <p style="text-align:center; color: var(--muted);">
        Steuerung: <strong>W A S D</strong> bewegen, <strong>E</strong> suchen, oder Buttons klicken.
      </p>

      <button class="action-btn" onclick="closeHelp()" style="text-align:center; border-color: rgba(42,140,90,.6);">
        Los geht's
      </button>
    </div>
  </div>

  <!-- MESSAGE MODAL -->
  <div id="msg-modal" class="overlay" onclick="closeMsg()">
    <div class="modal-box" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeMsg()">√ó</button>
      <h3 id="msg-title" style="font-family:'Cinzel'; color: var(--red); text-align:center; margin-bottom:8px;"></h3>
      <p id="msg-text" style="line-height:1.6; text-align:center;"></p>
      <button class="action-btn" onclick="closeMsg()" style="text-align:center; margin-top:12px;">Weiter</button>
    </div>
  </div>

  <!-- PUZZLE MODAL -->
  <div id="puzzle-modal" class="overlay">
    <div class="modal-box" style="border-color: rgba(47,128,237,.55);">
      <button class="modal-close" onclick="closePuzzle()">√ó</button>
      <h2 style="font-family:'Cinzel'; color: var(--blue); text-align:center;">R√§tsel</h2>
      <p id="puzzle-text" style="margin-top:10px; text-align:center; font-size:1.15em;"></p>
      <input id="puzzle-answer" class="input-dark" type="text" placeholder="Antwort eingeben‚Ä¶" autocomplete="off"/>
      <button class="action-btn" onclick="submitPuzzleAnswer()" style="text-align:center; border-color: rgba(47,128,237,.5);">L√∂sen</button>
    </div>
  </div>

  <div class="game-wrapper">
    <!-- LEFT: MAP + LOG -->
    <div class="panel">
      <div class="panel-header">Karte</div>
      <div class="map-controls">
        <button class="lvl-btn" id="lvl-btn-m1" onclick="player.mapLevel=-1; updateUI()">Keller (-1)</button>
        <button class="lvl-btn" id="lvl-btn-0"  onclick="player.mapLevel=0;  updateUI()">Ebene 0</button>
        <button class="lvl-btn" id="lvl-btn-1"  onclick="player.mapLevel=1;  updateUI()">Turm (1)</button>
      </div>
      <div class="map-container" id="mini-map"></div>
      <div style="text-align:center; margin-top:8px; color:var(--muted); font-size:.9em;">
        Tipp: Auf <strong>besuchte</strong> R√§ume klicken = Schnellreise
      </div>

      <div class="panel-header" style="margin-top:14px;">Logbuch</div>
      <div class="log-area" id="game-log"></div>
    </div>

    <!-- CENTER: ROOM -->
    <div class="panel main-panel">
      <div class="panel-header">
        <span>Umgebung</span>
        <button class="help-btn" onclick="openHelp()">?</button>
      </div>

      <h2 id="room-name" class="room-title">Schlosshof</h2>
      <div id="room-coords" class="room-coords">Ebene 0</div>

      <div id="room-visual" class="room-visual">
        <div class="sparkle"></div>
        <span id="room-icon">üè∞</span>
      </div>

      <div id="room-desc" class="room-desc">‚Ä¶</div>
      <div id="room-exits" class="exits-line">Ausg√§nge: ‚Ä¶</div>

      <div id="interaction-area"></div>
    </div>

    <!-- RIGHT: QUEST + SCANNER + POWERS + INVENTORY -->
    <div class="panel">
      <div class="objective-box">
        <div class="obj-title">Quest: Winterkrone</div>
        <ul class="obj-list">
          <li id="obj-ruby" class="obj-item"><span>üíé</span><span>Rubin</span></li>
          <li id="obj-sapphire" class="obj-item"><span>üíé</span><span>Saphir</span></li>
          <li id="obj-emerald" class="obj-item"><span>üíé</span><span>Smaragd</span></li>
        </ul>
        <div id="hint-display" class="hint-text">Tipp: ‚Ä¶</div>
      </div>

      <div class="scanner-box">
        <div class="scanner-row">
          <strong style="font-family:'Cinzel'; color: var(--ink);">Scanner</strong>
          <span id="scanner-label" style="color:var(--muted); font-family:'Cinzel'; font-size:.95em;">Gefahr</span>
        </div>

        <div class="seg">
          <label><input type="radio" name="scan" value="danger" checked onchange="setScanner('danger')"> Gefahr</label>
          <label><input type="radio" name="scan" value="secrets" onchange="setScanner('secrets')"> Geheimnisse</label>
        </div>

        <div class="meter-bar" title="Scanner-Meter">
          <div id="scanner-fill" class="meter-fill danger"></div>
        </div>
        <div id="scanner-note" style="margin-top:8px; color:var(--muted); text-align:center; font-size:.95em;">
          ‚Ä¶
        </div>
      </div>

      <div class="powers">
        <h3>Superkr√§fte</h3>

        <button class="power-btn" id="power-jump" onclick="usePower('jump')">
          <span><strong>üéÅ Geschenk-Sprung</strong></span>
          <span id="jump-charge">0%</span>
        </button>

        <button class="power-btn" id="power-snowglobe" onclick="usePower('snowglobe')">
          <span><strong>‚ú® Schneekugel-Schutz</strong></span>
          <span id="snow-charge">0%</span>
        </button>

        <div style="color:var(--muted); text-align:center; font-size:.92em;">
          Aufladung: <strong>Sprung</strong> im Hof, <strong>Schneekugel</strong> in der K√ºche
        </div>
      </div>

      <div class="panel-header inv-header">Inventar</div>
      <div class="inventory-grid" id="inventory-grid"></div>
    </div>
  </div>

  <div id="snow-container"></div>

  <script>
    /* -----------------------------
       DATA
    ------------------------------*/

    const player = {
      room: 'courtyard',
      inventory: [],
      flags: {},
      visited: ['courtyard'],
      mapLevel: 0,

      // Mischief instead of death
      mischief: 10, // 0..100 (but no game over)
      mischiefCooldown: 0,

      // Scanner mode
      scannerMode: 'danger',

      // Powers
      powerJump: 30,      // 0..100
      powerSnowglobe: 30  // 0..100
    };

    const items = {
      rusty_key:  { name:'Rostiger Schl√ºssel', icon:'üóùÔ∏è', desc:'√ñffnet die Kellert√ºr. Sieht alt aus, funktioniert aber.', type:'key' },
      silver_key: { name:'Silberschl√ºssel',   icon:'üóùÔ∏è', desc:'√ñffnet die Turmt√ºr zur Bibliothek.', type:'key' },
      crowbar:    { name:'Brecheisen',        icon:'üîß', desc:'F√ºr Kisten, Bretter und lockere Steine.', type:'tool' },
      scroll:     { name:'Notiz',             icon:'üìú', desc:'Rot13: "Vjre fbg nyyvrf orv anzra araara: Nyoerpug"', type:'clue' },
      ruby:       { name:'Rubin',             icon:'üíé', desc:'Warm wie Kakao am Kamin.', type:'gem' },
      sapphire:   { name:'Saphir',            icon:'üíé', desc:'Klar wie Eis ‚Äì aber freundlich.', type:'gem' },
      emerald:    { name:'Smaragd',           icon:'üíé', desc:'Gr√ºn wie Tannen im Schnee.', type:'gem' },
    };

    const rooms = {
      courtyard: {
        name:'Schlosshof', visual:'üè∞', coords:{x:2,y:2,z:0},
        desc:'Schneeflocken glitzern. Der Brunnen ist gefroren ‚Äì und irgendwie wirkt der Hof erstaunlich gem√ºtlich. Hier l√§dst du deine Superkr√§fte am besten auf.',
        exits:{ N:'great_hall', O:'kitchen', W:'library_entrance' },
        actions:[
          { label:'Am Brunnen Wunschm√ºnze werfen', once:false, fn:() => {
            changeMischief(-10);
            chargePower('jump', 25);
            log('Du wirfst eine Wunschm√ºnze ‚Äì der Hof f√ºhlt sich sicherer an. (+Sprung)', 'good');
            showMsg('Wunschm√ºnze', 'Du f√ºhlst dich ermutigt. Der Geschenk-Sprung l√§dt sich schneller auf.');
          }}
        ]
      },

      great_hall: {
        name:'Gro√üe Halle', visual:'üïØÔ∏è', coords:{x:2,y:1,z:0},
        desc:'Eine lange Tafel mit festlichen Servietten (okay, leicht staubig). Ein Hofnarr-Geist winkt und kichert ‚Äì eher lustig als gruselig.',
        exits:{ S:'courtyard', N:'throne_room' },
        search: [{ give:'rusty_key', msg:'Unter einem Teller liegt ein rostiger Schl√ºssel. Klassiker!' }],
        character:{ name:'Hofnarr', dialog:'Pssst! Wenn du sp√§ter den Namen suchst: ROT13 dreht Buchstaben wie ein Karussell. A wird zu N. N wird zu A.' }
      },

      kitchen: {
        name:'Alte K√ºche', visual:'üç≥', coords:{x:3,y:2,z:0},
        desc:'Hier riecht es nach Zimt und‚Ä¶ na ja, auch nach altem Topf. Ein Koch-Geist r√ºhrt unsichtbar in einer Suppe. In der K√ºche l√§dt sich die Schneekugel-Kraft.',
        exits:{ W:'courtyard', D:'cellar' },
        lockedExits:{ D:{ key:'rusty_key', msg:'Die Kellert√ºr ist zu. Du brauchst einen Schl√ºssel.' } },
        search: [{ give:'crowbar', msg:'Im Ofen steckt ein Brecheisen. Praktisch ‚Äì und √ºberraschend sauber.' }],
        character:{ name:'Koch-Geist', dialog:'Wenn du h√∂flich "Bitte" sagst, geben dir Dinge manchmal schneller nach. Und ja: Brecheisen hilft!' },
        actions:[
          { label:'Hei√üen Kakao schl√ºrfen (l√§dt Schneekugel)', once:false, fn:() => {
            chargePower('snowglobe', 30);
            changeMischief(-8);
            log('Kakao! Das hilft immer. (+Schneekugel)', 'good');
            showMsg('Kakao', 'W√§rmend. Deine Schneekugel-Kraft l√§dt sich deutlich auf.');
          }}
        ]
      },

      cellar: {
        name:'Weinkeller', visual:'üç∑', coords:{x:3,y:2,z:-1},
        desc:'K√ºhl, aber nicht schlimm. F√§sser stehen herum wie dicke Schneem√§nner. An einer Wand wackeln Steine verd√§chtig.',
        exits:{ U:'kitchen' },
        interact:[
          { label:'Hohles Fass √∂ffnen', req:'crowbar', result:'get_ruby', msg:'Plopp! Im Fass liegt ein Rubin ‚Äì als h√§tte jemand ihn "versteckt-vergesse-ich" gespielt.' },
          { label:'Lockere Wand freilegen', req:'crowbar', action:'open_dungeon', msg:'Mit etwas Hebeln entsteht ein geheimer Durchgang ins Verlies!' }
        ]
      },

      dungeon: {
        name:'Verlies', visual:'‚õìÔ∏è', coords:{x:3,y:1,z:-1},
        desc:'Eher "Abstellkammer f√ºr alte Ketten" als Horror. Ein Gang f√ºhrt zur Gruft. Du h√∂rst‚Ä¶ leises Gl√∂ckchen-Klimpern?',
        exits:{ N:'crypt', S:'cellar' }
      },

      crypt: {
        name:'Familiengruft', visual:'‚ö∞Ô∏è', coords:{x:3,y:0,z:-1},
        desc:'Steinerne Sarkophage. Ein gr√ºnes Leuchten schimmert freundlich wie eine Weihnachtsbaumkugel. Hier wartet ein R√§tsel auf dich.',
        exits:{ S:'dungeon' },
        puzzle:{ q:'Eine Stimme fl√ºstert: "Nenne meinen Namen!" (Tipp: Notiz + Rot13)', a:'ALBRECHT', reward:'emerald' }
      },

      library_entrance: {
        name:'Turmeingang', visual:'üö™', coords:{x:1,y:2,z:0},
        desc:'Eine Silbert√ºr mit Turmsymbol. Dahinter wartet Wissen ‚Äì und vermutlich Staub.',
        exits:{ O:'courtyard', W:'library' },
        lockedExits:{ W:{ key:'silver_key', msg:'Die Silbert√ºr bleibt zu. Du brauchst den Silberschl√ºssel.' } }
      },

      library: {
        name:'Bibliothek', visual:'üìö', coords:{x:0,y:2,z:0},
        desc:'Regale voller B√ºcher. Ein Archivar-Geist liest und nickt dir freundlich zu. In einer Vitrine steckt ein Edelstein.',
        exits:{ O:'library_entrance', U:'tower_top' },
        puzzle:{ q:'Zahlenfolge: 2, 4, 8, 16, ‚Ä¶ ?', a:'32', reward:'sapphire' },
        character:{ name:'Archivar', dialog:'Wenn du unsicher bist: Verdoppeln ist hier das Motto. (Und bitte nicht die Seiten knicken.)' }
      },

      tower_top: {
        name:'Turmspitze', visual:'üåô', coords:{x:0,y:2,z:1},
        desc:'Du siehst Sterne. Ein Skelett h√§lt ein Pergament ‚Äì wirkt eher wie Deko. Du kannst es untersuchen.',
        exits:{ D:'library' },
        search: [{ give:'scroll', msg:'Du nimmst die Notiz. Sie ist verschl√ºsselt (Rot13) ‚Äì wie ein R√§tsel-Adventskalender!' }]
      },

      throne_room: {
        name:'Thronsaal', visual:'üëë', coords:{x:2,y:0,z:0},
        desc:'Ein leerer Thron. Eine Halterung wartet auf die Winterkrone. Wenn du alle Edelsteine hast: zusammensetzen!',
        exits:{ S:'great_hall' },
        interact:[ { label:'Krone zusammensetzen', action:'win_check' } ]
      }
    };

    const questSteps = [
      { text:'Gehe zur Gro√üen Halle und suche den Kellerschl√ºssel.', done: () => player.inventory.includes('rusty_key') },
      { text:'Gehe zur K√ºche und finde das Brecheisen.', done: () => player.inventory.includes('crowbar') },
      { text:'√ñffne im Keller das Fass und finde den Rubin.', done: () => player.inventory.includes('ruby') },
      { text:'Suche im Hof nach dem Silberschl√ºssel (nachdem du die Halle besucht hast).', done: () => player.inventory.includes('silver_key') },
      { text:'√ñffne die Bibliothek und l√∂se das Zahlenr√§tsel (Saphir).', done: () => player.inventory.includes('sapphire') },
      { text:'Gehe zur Turmspitze und nimm die Notiz.', done: () => player.inventory.includes('scroll') },
      { text:'Finde die Gruft und l√∂se das Namensr√§tsel (Smaragd).', done: () => player.inventory.includes('emerald') },
      { text:'Zur√ºck zum Thronsaal: Setze die Krone zusammen.', done: () => false }
    ];

    /* -----------------------------
       INIT + INPUT
    ------------------------------*/
    function init(){
      createSnow();
      seedLog();
      updateUI();

      document.addEventListener('keydown', (e)=>{
        if(isAnyModalOpen()) return;
        const k = e.key.toLowerCase();
        if(k==='w' || k==='arrowup') move('N');
        if(k==='s' || k==='arrowdown') move('S');
        if(k==='a' || k==='arrowleft') move('W');
        if(k==='d' || k==='arrowright') move('O');
        if(k==='e') explore();
        if(k==='escape') closeAllModals();
      });

      ['puzzle-answer'].forEach(id=>{
        const el = document.getElementById(id);
        if(el){
          el.addEventListener('keydown', (e)=>{
            if(e.key==='Enter') submitPuzzleAnswer();
          });
        }
      });
    }

    function isAnyModalOpen(){
      const overlays = document.querySelectorAll('.overlay');
      for(const o of overlays){
        if(getComputedStyle(o).display === 'flex') return true;
      }
      return false;
    }

    function closeAllModals(){
      ['help-overlay','msg-modal','puzzle-modal'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
      });
    }

    /* -----------------------------
       UI
    ------------------------------*/
    function updateUI(){
      const r = rooms[player.room];

      document.getElementById('room-name').innerText = r.name;
      document.getElementById('room-coords').innerText = `Ebene ${r.coords.z} | Sektor ${r.coords.x}-${r.coords.y}`;
      document.getElementById('room-icon').innerText = r.visual;
      document.getElementById('room-desc').innerText = r.desc;

      // exits line
      const labels = {N:'Norden',S:'S√ºden',O:'Osten',W:'Westen',U:'Oben',D:'Unten'};
      const out = [];
      for(const d of ['N','S','O','W','U','D']){
        if(r.exits && r.exits[d]) out.push(labels[d]);
        else if(r.lockedExits && r.lockedExits[d]) out.push(labels[d] + ' (üîí)');
      }
      document.getElementById('room-exits').innerText = 'Ausg√§nge: ' + (out.length? out.join(', ') : 'Keine');

      // move buttons
      ['n','s','o','w','u','d'].forEach(dd=>{
        const btn = document.getElementById('btn-'+dd);
        const dir = dd.toUpperCase();
        const has = (r.exits && r.exits[dir]) || (r.lockedExits && r.lockedExits[dir]);
        if(btn){
          btn.disabled = !has;
          btn.style.opacity = has ? 1 : .5;
        }
      });

      // interaction area
      const area = document.getElementById('interaction-area');
      area.innerHTML = '';

      // talk
      if(r.character){
        const b = mkBtn(`üó£Ô∏è Mit ${r.character.name} reden`, ()=>{
          log(`Du sprichst mit ${r.character.name}.`, 'info');
          showMsg(r.character.name, `"${r.character.dialog}"`);
          // talking reduces mischief a bit
          changeMischief(-6);
        });
        area.appendChild(b);
      }

      // search prompt
      const bSearch = mkBtn('üîé Umgebung durchsuchen (E)', explore);
      area.appendChild(bSearch);

      // puzzles
      if(r.puzzle && !player.flags[r.puzzle.reward + '_got']){
        const b = mkBtn('üß© R√§tsel anschauen', ()=>openPuzzleModal(r.puzzle));
        area.appendChild(b);
      }

      // interact
      if(r.interact){
        r.interact.forEach(act=>{
          if(act.action === 'open_dungeon' && rooms.cellar.exits.N) return;
          if(act.result === 'get_ruby' && player.inventory.includes('ruby')) return;
          area.appendChild(mkBtn(`‚öôÔ∏è ${act.label}`, ()=>handleInteract(act)));
        });
      }

      // room actions
      if(r.actions){
        r.actions.forEach(a=>{
          area.appendChild(mkBtn(`üéÑ ${a.label}`, ()=>{
            if(a.fn) a.fn();
            updateUI();
          }));
        });
      }

      // throne assemble
      if(r.interact){
        r.interact.forEach(act=>{
          if(act.action === 'win_check'){
            // already added above by interact loop
          }
        });
      }

      // map & inventory & quest
      renderMap(player.mapLevel);
      renderInventory();
      updateObjectives();

      // power UI
      updatePowersUI();

      // scanner UI
      updateScannerUI();
    }

    function mkBtn(text, fn){
      const b = document.createElement('button');
      b.className = 'action-btn';
      b.innerText = text;
      b.onclick = fn;
      return b;
    }

    function seedLog(){
      log('Willkommen! Das Schloss ist heute eher "Weihnachts-Escape-Room" als Grusel.', 'info');
      log('Tipp: Scanner auf "Geheimnisse" stellen, wenn du nicht wei√üt, ob hier noch etwas ist.', 'info');
    }

    function log(text, type='info'){
      const area = document.getElementById('game-log');
      const div = document.createElement('div');
      div.className = 'log-entry ' + type;
      div.innerText = '‚Ä¢ ' + text;
      area.prepend(div);
      if(area.children.length > 40) area.lastChild.remove();
    }

    function showMsg(title, text){
      document.getElementById('msg-title').innerText = title;
      document.getElementById('msg-text').innerText = text;
      document.getElementById('msg-modal').style.display = 'flex';
    }
    function closeMsg(){ document.getElementById('msg-modal').style.display = 'none'; }

    function openHelp(){ document.getElementById('help-overlay').style.display = 'flex'; }
    function closeHelp(){ document.getElementById('help-overlay').style.display = 'none'; }

    /* -----------------------------
       MAP
    ------------------------------*/
    function renderMap(level){
      const map = document.getElementById('mini-map');

      // active btn
      document.querySelectorAll('.lvl-btn').forEach(b=>b.classList.remove('active'));
      const btnId = (level===-1) ? 'lvl-btn-m1' : 'lvl-btn-' + level;
      const ab = document.getElementById(btnId);
      if(ab) ab.classList.add('active');

      map.innerHTML = '';

      for(let y=0;y<5;y++){
        for(let x=0;x<5;x++){
          const node = document.createElement('div');
          node.className = 'map-node fog';

          const roomKey = Object.keys(rooms).find(k=>{
            const c = rooms[k].coords;
            return c.x===x && c.y===y && c.z===level;
          });

          if(roomKey){
            const r = rooms[roomKey];
            const isVisited = player.visited.includes(roomKey);
            const isCurrent = player.room === roomKey;

            let neighborVisited = false;
            if(!isVisited){
              neighborVisited = Object.keys(rooms).some(k=>{
                const nr = rooms[k].coords;
                if(nr.z!==level) return false;
                const man = Math.abs(nr.x-x)+Math.abs(nr.y-y);
                return man===1 && player.visited.includes(k);
              });
            }

            if(isCurrent){
              node.className = 'map-node active';
              node.innerText = r.visual;
            }else if(isVisited){
              node.className = 'map-node visited';
              node.innerText = r.visual;
              node.title = r.name + ' (Schnellreise)';
              node.onclick = ()=>fastTravel(roomKey);

              // lock icon if any locked exits and missing key
              let hasLock = false;
              if(r.lockedExits){
                hasLock = Object.values(r.lockedExits).some(lock => !player.inventory.includes(lock.key));
              }
              if(hasLock){
                const lock = document.createElement('div');
                lock.className = 'lock-icon';
                lock.innerText = 'üîí';
                node.appendChild(lock);
              }
            }else if(neighborVisited){
              node.className = 'map-node seen';
              node.innerText = '?';
            }
          }

          map.appendChild(node);
        }
      }
    }

    function fastTravel(target){
      if(target === player.room) return;
      log('Schnellreise: Du huschst durch bekannte Flure.', 'info');
      // small mischief increase, but not scary
      changeMischief(+4);
      player.room = target;
      player.mapLevel = rooms[player.room].coords.z;
      visitRoom(false);
    }

    /* -----------------------------
       MOVEMENT + VISIT
    ------------------------------*/
    function move(dir){
      const r = rooms[player.room];

      // Check if locked first
      if(r.lockedExits && r.lockedExits[dir]){
        const lock = r.lockedExits[dir];
        if(player.inventory.includes(lock.key)){
          log('Du nutzt den Schl√ºssel ‚Äì klick! Auf geht's.', 'good');
          // Unlock permanently by moving the exit from lockedExits to exits
          if(!r.exits) r.exits = {};
          r.exits[dir] = r.lockedExits[dir].target || getExitTarget(player.room, dir);
          delete r.lockedExits[dir];
          player.room = r.exits[dir];
          visitRoom();
        }else{
          log(lock.msg, 'warn');
          showMsg('Verschlossen', lock.msg);
        }
        return;
      }

      // Normal movement
      if(r.exits && r.exits[dir]){
        player.room = r.exits[dir];
        // moving adds a tiny bit of mischief, but manageable
        changeMischief(+3);
        visitRoom();
      }
    }

    // Helper to get exit target from locked exits
    function getExitTarget(roomKey, dir){
      const locked = rooms[roomKey].lockedExits;
      if(locked && locked[dir]){
        // Find the target by direction logic
        if(dir === 'D') return 'cellar';
        if(dir === 'W') return 'library';
      }
      return null;
    }

    function visitRoom(isNewMove=true){
      const key = player.room;

      if(!player.visited.includes(key)){
        player.visited.push(key);
        log('Neuer Raum entdeckt: ' + rooms[key].name, 'good');
        // reward: small power charge
        chargePower('jump', 10);
        chargePower('snowglobe', 10);
      }else if(isNewMove){
        log('Du bist jetzt in: ' + rooms[key].name, 'info');
      }

      player.mapLevel = rooms[key].coords.z;

      // location-based recharge
      if(key === 'courtyard') chargePower('jump', 18);
      if(key === 'kitchen')   chargePower('snowglobe', 18);

      // occasional playful sprite event
      maybeSpritePrank();

      updateUI();
    }

    /* -----------------------------
       SEARCH / INTERACT / PUZZLES
    ------------------------------*/
    function explore(){
      const r = rooms[player.room];

      // searching increases mischief a bit
      changeMischief(+6);

      // room search entries
      if(r.search){
        for(const entry of r.search){
          if(entry.give){
            if(player.inventory.includes(entry.give)) continue;
            player.inventory.push(entry.give);
            log('Gefunden: ' + items[entry.give].name, 'good');
            showMsg('Gefunden!', entry.msg);
            // reward: secret-sense calming + power
            chargePower('snowglobe', 12);
            chargePower('jump', 12);
            updateUI();
            return;
          }
        }
      }

      // special: silver key in courtyard after visiting hall
      if(player.room === 'courtyard' && player.visited.includes('great_hall') && !player.inventory.includes('silver_key')){
        player.inventory.push('silver_key');
        log('Im Schnee blitzt etwas: Silberschl√ºssel!', 'good');
        showMsg('Silberschl√ºssel', 'Du findest den Silberschl√ºssel im Schnee. Die Turmt√ºr wartet.');
        updateUI();
        return;
      }

      log('Du suchst ‚Äì aber hier ist gerade nichts Neues.', 'info');
      updateUI();
    }

    function handleInteract(act){
      if(act.req && !player.inventory.includes(act.req)){
        showMsg('Hm‚Ä¶', 'Dir fehlt: ' + items[act.req].name);
        log('Fehlt: ' + items[act.req].name, 'warn');
        return;
      }

      if(act.action === 'open_dungeon'){
        rooms.cellar.exits.N = 'dungeon';
        log('Geheimgang freigelegt! (Keller ‚Üí Verlies)', 'good');
        showMsg('Geheimgang', 'Ein Durchgang ist offen. Du kannst nach Norden ins Verlies.');
        updateUI();
        return;
      }

      if(act.result === 'get_ruby'){
        if(!player.inventory.includes('ruby')){
          player.inventory.push('ruby');
          log('Rubin eingesammelt!', 'good');
          showMsg('Rubin', 'Der Rubin funkelt wie ein Weihnachtsstern.');
          // reward power
          chargePower('jump', 20);
          chargePower('snowglobe', 20);
          updateUI();
        }
        return;
      }

      if(act.action === 'win_check'){
        const ok = ['ruby','sapphire','emerald'].every(g=>player.inventory.includes(g));
        if(ok){
          winScreen();
        }else{
          showMsg('Fast!', 'Dir fehlen noch Edelsteine. Schau in die Quest-Box rechts.');
          log('Krone noch unvollst√§ndig.', 'warn');
        }
      }
    }

    let activePuzzle = null;
    function openPuzzleModal(puzzle){
      activePuzzle = puzzle;
      document.getElementById('puzzle-text').innerText = puzzle.q;
      document.getElementById('puzzle-answer').value = '';
      document.getElementById('puzzle-modal').style.display = 'flex';
      setTimeout(()=>document.getElementById('puzzle-answer').focus(), 50);
    }
    function closePuzzle(){
      document.getElementById('puzzle-modal').style.display = 'none';
      activePuzzle = null;
    }
    function submitPuzzleAnswer(){
      if(!activePuzzle) return;
      const ans = document.getElementById('puzzle-answer').value.toUpperCase().trim();
      
      if(ans === activePuzzle.a){
        // Add item to inventory
        if(!player.inventory.includes(activePuzzle.reward)){
          player.inventory.push(activePuzzle.reward);
        }
        // Mark puzzle as solved
        player.flags[activePuzzle.reward + '_got'] = true;

        log('R√§tsel gel√∂st! (' + items[activePuzzle.reward].name + ')', 'good');
        showMsg('Richtig!', 'Du bekommst: ' + items[activePuzzle.reward].name);
        // reward
        changeMischief(-10);
        chargePower('jump', 25);
        chargePower('snowglobe', 25);
        
        closePuzzle();
        updateUI();
      }else{
        log('Knapp daneben ‚Äì versuch's sp√§ter nochmal.', 'warn');
        showMsg('Nicht ganz', 'Das war\'s noch nicht. Tipp: Sprich mit den Geistern oder nutze "Geheimnisse"-Scanner.');
        // small mischief, no punishment spiral
        changeMischief(+8);
        closePuzzle();
        updateUI();
      }
    }

    /* -----------------------------
       QUEST / INVENTORY / POWERS
    ------------------------------*/
    function renderInventory(){
      const g = document.getElementById('inventory-grid');
      g.innerHTML = '';

      const slots = 8;
      for(let i=0;i<slots;i++){
        const d = document.createElement('div');
        if(i < player.inventory.length){
          const id = player.inventory[i];
          d.className = 'inv-item filled';
          d.innerHTML = `${items[id].icon}<span>${items[id].name}</span>`;
          d.onclick = ()=>showMsg(items[id].name, items[id].desc);
        }else{
          d.className = 'inv-item empty';
          d.innerHTML = `üéÅ<span>Leer</span>`;
        }
        g.appendChild(d);
      }
    }

    function updateObjectives(){
      ['ruby','sapphire','emerald'].forEach(g=>{
        const el = document.getElementById('obj-'+g);
        if(player.inventory.includes(g)) el.classList.add('done');
      });

      // compute quest step
      let step = 0;
      while(step < questSteps.length && questSteps[step].done()) step++;

      const hint = document.getElementById('hint-display');
      hint.innerText = (step >= questSteps.length)
        ? 'Setze die Krone zusammen!'
        : 'N√§chster Schritt: ' + questSteps[step].text;
    }

    function updatePowersUI(){
      // jump
      document.getElementById('jump-charge').innerText = player.powerJump + '%';
      document.getElementById('power-jump').disabled = (player.powerJump < 100);

      // snowglobe
      document.getElementById('snow-charge').innerText = player.powerSnowglobe + '%';
      document.getElementById('power-snowglobe').disabled = (player.powerSnowglobe < 100);
    }

    function chargePower(which, amount){
      if(which==='jump') player.powerJump = Math.min(100, player.powerJump + amount);
      if(which==='snowglobe') player.powerSnowglobe = Math.min(100, player.powerSnowglobe + amount);
    }

    function usePower(which){
      if(which==='jump'){
        if(player.powerJump < 100) return;

        // Pick a target (simple prompt list)
        const options = player.visited.map(k => rooms[k].name);
        const targetName = prompt(
          'Geschenk-Sprung: Wohin willst du?\n' +
          options.map((n,i)=>`${i+1}) ${n}`).join('\n') +
          '\n\nGib die Nummer ein:'
        );
        if(!targetName) return;

        const idx = parseInt(targetName, 10) - 1;
        if(Number.isNaN(idx) || idx < 0 || idx >= player.visited.length){
          showMsg('Ups', 'Bitte eine g√ºltige Nummer eingeben.');
          return;
        }

        player.powerJump = 0;
        const targetKey = player.visited[idx];
        log('üéÅ Geschenk-Sprung! Du teleportierst dich.', 'good');
        changeMischief(-6);
        player.room = targetKey;
        player.mapLevel = rooms[player.room].coords.z;
        visitRoom(false);
      }

      if(which==='snowglobe'){
        if(player.powerSnowglobe < 100) return;
        player.powerSnowglobe = 0;

        // effect: calm + reveal hint
        changeMischief(-18);

        const secret = computeSecretScore(player.room);
        const extra = secret > 0
          ? 'Hier ist definitiv noch etwas zu entdecken. Such nach einem R√§tsel/Objekt oder rede mit jemandem.'
          : 'Hier wirkt alles schon "leer". Vielleicht woanders weitermachen.';

        log('‚ú® Schneekugel-Schutz aktiviert.', 'good');
        showMsg('Schneekugel-Schutz', 'Eine glitzernde Kugel schwebt kurz vor dir ‚Äì alles wird ruhiger.\n\nExtra-Hinweis: ' + extra);
        updateUI();
      }
    }

    /* -----------------------------
       SCANNER
    ------------------------------*/
    function setScanner(mode){
      player.scannerMode = mode;
      updateScannerUI();
    }

    function updateScannerUI(){
      const fill = document.getElementById('scanner-fill');
      const label = document.getElementById('scanner-label');
      const note = document.getElementById('scanner-note');

      if(player.scannerMode === 'danger'){
        label.innerText = 'Gefahr';
        fill.classList.remove('secret');
        fill.classList.add('danger');

        // map mischief 0..100 to % (but it's just "mood")
        const pct = Math.max(0, Math.min(100, player.mischief));
        fill.style.width = pct + '%';

        const mood = (pct < 25) ? 'Sehr ruhig'
                  : (pct < 50) ? 'Kichert ein bisschen'
                  : (pct < 75) ? 'Frecher Unfug'
                  : 'Richtig albern';
        note.innerText = `Unfug-Level: ${mood} (${pct}%)`;
      }else{
        label.innerText = 'Geheimnisse';
        fill.classList.remove('danger');
        fill.classList.add('secret');

        const score = computeSecretScore(player.room); // 0..100ish
        fill.style.width = score + '%';
        note.innerText = score >= 60 ? 'Hier steckt noch viel!'
                      : score >= 30 ? 'Vielleicht ist noch etwas da‚Ä¶'
                      : score > 0   ? 'Nur noch Kleinkram.'
                      : 'Hier ist alles entdeckt.';
      }
    }

    function computeSecretScore(roomKey){
      const r = rooms[roomKey];
      let score = 0;

      // undiscovered search items
      if(r.search){
        for(const entry of r.search){
          if(entry.give && !player.inventory.includes(entry.give)) score += 40;
        }
      }

      // undiscovered puzzle reward
      if(r.puzzle && !player.flags[r.puzzle.reward + '_got']) score += 50;

      // undiscovered interact outcomes
      if(r.interact){
        for(const act of r.interact){
          if(act.result === 'get_ruby' && !player.inventory.includes('ruby')) score += 35;
          if(act.action === 'open_dungeon' && !rooms.cellar.exits.N) score += 25;
        }
      }

      // special silver key rule
      if(roomKey === 'courtyard' && player.visited.includes('great_hall') && !player.inventory.includes('silver_key')) score += 50;

      // cap
      return Math.max(0, Math.min(100, score));
    }

    /* -----------------------------
       MISCHIEF SPRITE (Playful)
    ------------------------------*/
    function changeMischief(delta){
      player.mischief = Math.max(0, Math.min(100, player.mischief + delta));
      updateScannerUI();
    }

    function maybeSpritePrank(){
      if(player.mischiefCooldown > 0){
        player.mischiefCooldown--;
        return;
      }

      // small chance, scaled by mischief
      const chance = (player.mischief / 220); // low
      if(Math.random() < chance){
        player.mischiefCooldown = 3;

        const pranks = [
          { t:'üéÄ Schleifen-Sturm', m:'Ein Schwung Geschenk-Schleifen fliegt vorbei. Du musst lachen.', eff:()=>changeMischief(-6) },
          { t:'‚õÑ Schneemann-Witz', m:'Ein Geist zeichnet dir einen Schneemann ins Logbuch. Albern, aber nett.', eff:()=>changeMischief(-8) },
          { t:'üîî Gl√∂ckchen-Echo', m:'Du h√∂rst Gl√∂ckchen. Es klingt wie "Sucht doch mal da oben‚Ä¶"', eff:()=>{ chargePower('jump', 8); } },
        ];
        const p = pranks[Math.floor(Math.random()*pranks.length)];
        log('Ein Schloss-Kobold macht Quatsch: ' + p.t, 'info');
        if(p.eff) p.eff();
      }
    }

    /* -----------------------------
       WIN
    ------------------------------*/
    function winScreen(){
      document.body.innerHTML = `
        <div style="min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
                    background: radial-gradient(circle at 30% 20%, #eaf6ff, #cfe9ff);">
          <div style="background:#ffffffee; border:3px solid rgba(242,201,76,.9); border-radius:20px;
                      padding:22px; box-shadow: 0 18px 60px rgba(31,42,55,.18); text-align:center; max-width:820px;">
            <h1 style="font-family:Cinzel; color:#d13a3a; font-size:3.2em; margin-bottom:10px;">Krone vollendet!</h1>
            <p style="font-size:1.35em; line-height:1.5; color:#1f2a37;">
              Die Edelsteine klicken ein ‚Äì und das Schloss leuchtet pl√∂tzlich wie ein riesiger Adventskalender.
              Der Kobold-Geist verbeugt sich ‚Ä¶ und wirft dir zum Abschied Konfetti-Schnee zu.
            </p>
            <div style="font-size:4.5em; margin:14px 0;">üëë‚ùÑÔ∏èüéÅ</div>
            <button onclick="location.reload()"
              style="padding:12px 18px; border-radius:14px; border:2px solid #9fc9e6; background:#fff; font-family:Cinzel; font-size:1.1em; cursor:pointer;">
              Nochmal spielen
            </button>
          </div>
        </div>
      `;
    }

    /* -----------------------------
       SNOW
    ------------------------------*/
    function createSnow(){
      const c = document.getElementById('snow-container');
      const count = 55;
      for(let i=0;i<count;i++){
        const s = document.createElement('div');
        s.className = 'snowflake';
        s.innerText = Math.random() < 0.15 ? '‚ú∂' : '‚ùÑ';
        s.style.left = (Math.random()*100) + 'vw';
        s.style.fontSize = (10 + Math.random()*18) + 'px';
        s.style.opacity = (0.25 + Math.random()*0.6).toFixed(2);
        s.style.animationDuration = (5 + Math.random()*7) + 's';
        s.style.animationDelay = (-Math.random()*7) + 's';
        c.appendChild(s);
      }
    }

    /* -----------------------------
       START
    ------------------------------*/
    init();
    // initial visit
    updateScannerUI();

    // Build movement controls dynamically into right panel? We already have in center interaction + WASD.
    // Add D-pad controls below interaction:
    // (Small injection so you don't need to scroll for buttons on laptops.)
    (function injectControls(){
      const area = document.getElementById('interaction-area');
      const wrap = document.createElement('div');
      wrap.style.marginTop = '10px';
      wrap.innerHTML = `
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px;">
          <div></div>
          <button id="btn-n" onclick="move('N')">N</button>
          <div></div>
          <button id="btn-w" onclick="move('W')">W</button>
          <button class="search-btn" onclick="explore()" title="Suchen (E)">üëÅÔ∏è</button>
          <button id="btn-o" onclick="move('O')">O</button>
          <div></div>
          <button id="btn-s" onclick="move('S')">S</button>
          <div></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <button id="btn-u" onclick="move('U')">‚¨Ü HOCH</button>
          <button id="btn-d" onclick="move('D')">‚¨á RUNTER</button>
        </div>
        <div style="text-align:center; margin-top:8px; color:var(--muted); font-size:.92em;">
          Tipp: <strong>E</strong> = suchen, <strong>WASD</strong> = bewegen
        </div>
      `;
      area.appendChild(wrap);
      updateUI();
    })();
  </script>
</body>
</html>
