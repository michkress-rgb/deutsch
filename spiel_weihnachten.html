<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Das R√§tsel der Winterkrone</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:wght@400;600&display=swap');
        
        :root {
            --bg-dark: #0a0f14;
            --bg-panel: #161b22;
            --text-main: #c9d1d9;
            --accent-red: #8b0000;
            --accent-green: #1a472a;
            --accent-gold: #b8860b;
            --ghost-purple: #483d8b;
            --border-color: #30363d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Cormorant Garamond', serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 50% 50%, #1a2332 0%, #0a0f14 100%);
        }

        /* Ambient Snow Effect */
        #snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .snowflake {
            position: absolute;
            color: rgba(255, 255, 255, 0.3);
            font-size: 1em;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to { transform: translateY(100vh); }
        }

        /* Layout */
        .game-wrapper {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 20px;
            max-width: 1600px;
            height: 95vh;
            margin: 2.5vh auto;
            padding: 0 20px;
            position: relative;
            z-index: 2;
        }

        /* Panels */
        .panel {
            background: var(--bg-panel);
            border: 2px solid var(--accent-green);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-radius: 4px;
        }

        .panel-header {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
            letter-spacing: 2px;
        }

        /* Main View */
        .main-view {
            grid-column: 2;
            border-color: var(--accent-gold);
            position: relative;
            overflow-y: auto;
        }

        .room-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5em;
            color: var(--accent-red);
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .room-visual {
            height: 200px;
            background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.2));
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5em;
            margin-bottom: 20px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        .room-desc {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 30px;
            text-align: justify;
        }

        /* Controls */
        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            max-width: 200px;
            margin: 0 auto 20px auto;
        }

        button {
            background: #21262d;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 12px;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        button:hover:not(:disabled) {
            background: var(--accent-green);
            border-color: var(--text-main);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: #30363d;
        }

        .action-btn {
            width: 100%;
            margin-bottom: 10px;
            border-color: var(--accent-gold);
        }

        /* Inventory */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .inv-item {
            aspect-ratio: 1;
            border: 1px dashed var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: help;
            transition: 0.3s;
            background: rgba(0,0,0,0.2);
        }

        .inv-item.filled {
            border-style: solid;
            border-color: var(--accent-gold);
            background: rgba(184, 134, 11, 0.1);
        }

        .inv-item span { font-size: 0.4em; margin-top: 5px; font-family: sans-serif; }

        /* Ghost Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            border: 2px solid var(--ghost-purple);
            padding: 40px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 50px var(--ghost-purple);
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .ghost-input {
            background: #000;
            border: 1px solid var(--ghost-purple);
            color: white;
            padding: 10px;
            width: 100%;
            margin: 20px 0;
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            text-align: center;
        }

        .log-area {
            height: 150px;
            overflow-y: auto;
            font-size: 0.9em;
            color: #8b949e;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
            margin-top: auto;
        }

        .log-entry { margin-bottom: 5px; }
        .log-entry.danger { color: #ff7b72; }
        .log-entry.success { color: #7ee787; }
        .log-entry.info { color: #a5d6ff; }

        /* Start Screen */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        /* Media Query */
        @media (max-width: 1000px) {
            .game-wrapper { grid-template-columns: 1fr; overflow-y: scroll; height: auto;}
            .main-view { order: -1; }
        }
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <div id="start-screen">
        <h1 style="font-family: 'Cinzel'; font-size: 4em; color: var(--accent-red); margin-bottom: 20px;">Das R√§tsel der Winterkrone</h1>
        <p style="font-size: 1.5em; max-width: 600px; margin-bottom: 40px; color: #8b949e;">
            Schwarzwald, 1347. Die Wintersonnenwende steht bevor. <br>
            Der Geist von Albrecht dem Grausamen bewacht die zerbrochene Krone.<br>
            Finde die drei Edelsteine. Setze die Krone zusammen. √úberlebe den Geist.
        </p>
        <button onclick="startGame()" style="font-size: 1.5em; padding: 15px 40px; border-color: var(--accent-red);">DAS TOR √ñFFNEN</button>
    </div>

    <div id="ghost-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color: var(--ghost-purple); font-family: 'Cinzel'; margin-bottom: 20px;">üëÅÔ∏è ALBRECHT BEOBACHTET DICH</h2>
            <p id="ghost-riddle-text" style="font-size: 1.2em; line-height: 1.6;">...</p>
            <input type="text" id="ghost-answer" class="ghost-input" placeholder="Deine Antwort..." autocomplete="off">
            <button onclick="submitGhostAnswer()" class="action-btn" style="background: var(--ghost-purple); color: white;">ANTWORTEN</button>
            <p style="font-size: 0.8em; color: #ff7b72; margin-top: 10px;">Falsche Antworten haben Konsequenzen.</p>
        </div>
    </div>

    <div id="msg-modal" class="modal-overlay" onclick="this.style.display='none'">
        <div class="modal-content" style="border-color: var(--accent-gold); box-shadow: none;" onclick="event.stopPropagation()">
            <h3 id="msg-title" style="color: var(--accent-gold); margin-bottom: 15px;"></h3>
            <p id="msg-text"></p>
            <button onclick="document.getElementById('msg-modal').style.display='none'" style="margin-top: 20px; width: 100%;">Weiter</button>
        </div>
    </div>

    <div class="game-wrapper" id="game-ui" style="filter: blur(5px); opacity: 0.5;">
        <div class="panel">
            <div class="panel-header">Navigation</div>
            <div class="d-pad">
                <div></div>
                <button id="btn-n" onclick="move('N')">N</button>
                <div></div>
                <button id="btn-w" onclick="move('W')">W</button>
                <div style="text-align:center; padding-top:10px;">‚öúÔ∏è</div>
                <button id="btn-o" onclick="move('O')">O</button>
                <div></div>
                <button id="btn-s" onclick="move('S')">S</button>
                <div></div>
            </div>
            
            <button class="action-btn" onclick="explore()">üîç Umgebung untersuchen</button>
            
            <div style="margin-top: 20px;">
                <div class="panel-header">Status</div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Geist-Zorn:</span>
                    <span id="ghost-anger" style="color: var(--ghost-purple)">Niedrig</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Edelsteine:</span>
                    <span id="gem-count" style="color: var(--accent-gold)">0/3</span>
                </div>
            </div>

            <div class="log-area" id="game-log">
                <div class="log-entry info">Willkommen in Schloss Winterkrone...</div>
            </div>
        </div>

        <div class="panel main-view">
            <h2 id="room-name" class="room-title">Schlosshof</h2>
            <div id="room-visual" class="room-visual">üè∞</div>
            <div id="room-desc" class="room-desc">
                Schnee bedeckt die alten Pflastersteine. Der Wind heult durch die leeren Torb√∂gen.
            </div>
            
            <div id="interaction-area" style="border-top: 1px solid var(--border-color); padding-top: 20px;">
                </div>
        </div>

        <div class="panel">
            <div class="panel-header">Inventar</div>
            <div class="inventory-grid" id="inventory-grid">
                </div>
            <div style="margin-top: auto; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--accent-red); color: #ff7b72; font-size: 0.9em; text-align: center;">
                Warnung: Der Geist kann Gegenst√§nde stehlen und verstecken.
            </div>
        </div>
    </div>

    <script>
        // --- GAME DATA ---

        const player = {
            currentRoom: 'courtyard',
            inventory: [], // Array of item IDs
            flags: {}, // For solved puzzles, opened doors
            ghostAnger: 0
        };

        const items = {
            'rusty_key': { name: 'Rostiger Schl√ºssel', icon: 'üóùÔ∏è', desc: '√ñffnet die alte T√ºr zum Weinkeller.' },
            'silver_key': { name: 'Silberschl√ºssel', icon: 'üóùÔ∏è', desc: 'Ein eleganter Schl√ºssel mit dem Wappen der Bibliothek.' },
            'crowbar': { name: 'Brecheisen', icon: 'üîß', desc: 'Grobes Werkzeug f√ºr vernagelte Kisten.' },
            'scroll': { name: 'Verschl√ºsselte Notiz', icon: 'üìú', desc: 'Ein Pergament mit seltsamen Buchstaben.' },
            'ruby': { name: 'Blutrubin', icon: 'üíé', desc: 'Der erste Stein der Krone. Er f√ºhlt sich warm an.', type: 'gem' },
            'sapphire': { name: 'Eissaphir', icon: 'üíé', desc: 'Der zweite Stein. Eiskalt.', type: 'gem' },
            'emerald': { name: 'Waldsmaragd', icon: 'üíé', desc: 'Der dritte Stein. Er leuchtet schwach.', type: 'gem' },
            'crown_frame': { name: 'Goldener Rahmen', icon: 'üëë', desc: 'Die leere Fassung der Winterkrone.' }
        };

        const rooms = {
            'courtyard': {
                name: 'Schlosshof',
                visual: 'üè∞',
                desc: 'Der zentrale Hof. Im Norden liegt die Gro√üe Halle. Im Osten riecht es nach kalter Asche (K√ºche). Im Westen ragt der Bibliotheksturm auf. Im S√ºden ist das verschlossene Haupttor.',
                exits: { N: 'great_hall', O: 'kitchen', W: 'library_entrance' },
                search: null
            },
            'kitchen': {
                name: 'Alte K√ºche',
                visual: 'üç≥',
                desc: 'Verrostete Kessel h√§ngen von der Decke. Ratten huschen durch die Schatten. Eine schwere Eichent√ºr f√ºhrt nach unten in den Keller.',
                exits: { W: 'courtyard', D: 'cellar' }, // D = Down
                lockedExits: { D: { key: 'rusty_key', msg: 'Die Kellert√ºr ist verschlossen.' } },
                search: { item: 'crowbar', chance: 1.0, msg: 'Du findest ein Brecheisen in einem alten Ofen.' }
            },
            'cellar': {
                name: 'Weinkeller',
                visual: 'üç∑',
                desc: 'Es ist stockdunkel und feucht. Alte Weinf√§sser stapeln sich hier. Eines klingt hohl.',
                exits: { U: 'kitchen' }, // U = Up
                interact: [{ label: 'Fass aufbrechen', req: 'crowbar', result: 'get_ruby', msg: 'Das Fass zerbricht. Darin liegt der Blutrubin!' }]
            },
            'great_hall': {
                name: 'Gro√üe Halle',
                visual: 'üïØÔ∏è',
                desc: 'Lange Tafeln sind gedeckt f√ºr G√§ste, die nie kamen. Spinnweben h√§ngen wie Vorh√§nge. Im Norden steht der Thron.',
                exits: { S: 'courtyard', N: 'throne_room' },
                search: { item: 'rusty_key', chance: 1.0, msg: 'Ein rostiger Schl√ºssel liegt unter einem Teller.' }
            },
            'throne_room': {
                name: 'Thronsaal',
                visual: 'üëë',
                desc: 'Hier herrscht eine unnat√ºrliche K√§lte. Auf dem Thron liegt der goldene Rahmen der Krone. Die Fassungen sind leer.',
                exits: { S: 'great_hall' },
                interact: [{ label: 'Krone zusammensetzen', action: 'win_check' }]
            },
            'library_entrance': {
                name: 'Turmeingang',
                visual: 'üö™',
                desc: 'Eine massive T√ºr mit silbernen Beschl√§gen versperrt den Weg in den Bibliotheksturm.',
                exits: { O: 'courtyard', W: 'library' },
                lockedExits: { W: { key: 'silver_key', msg: 'Die T√ºr hat ein komplexes silbernes Schloss.' } }
            },
            'library': {
                name: 'Bibliothek',
                visual: 'üìö',
                desc: 'Regale voller verrotteter B√ºcher. Ein Pult steht in der Mitte mit einer verschlossenen Glasvitrine. Darin: Der Eissaphir.',
                exits: { O: 'library_entrance', U: 'tower_top' },
                puzzle: { 
                    id: 'lib_puzzle', 
                    question: 'Logik-R√§tsel: Der Code ist eine Zahlenfolge. 2, 4, 8, 16, ... Was ist die n√§chste Zahl?', 
                    answer: '32', 
                    reward: 'sapphire',
                    solved: false
                }
            },
            'tower_top': {
                name: 'Turmspitze',
                visual: 'üåô',
                desc: 'Der Wind ist hier ohrenbet√§ubend. Du siehst √ºber den ganzen Schwarzwald. Ein Skelett h√§lt eine Notiz umklammert.',
                exits: { D: 'library' },
                search: { item: 'scroll', chance: 1.0, msg: 'Du nimmst die verschl√ºsselte Notiz.' }
            },
            'dungeon': {
                name: 'Verlies',
                visual: '‚õìÔ∏è',
                desc: 'Du wurdest hierher verschleppt! Gitterst√§be rosten vor sich hin. Es gibt einen losen Stein in der Wand.',
                exits: { N: 'crypt' }, // Secret exit logic needs finding
                interact: [{ label: 'Stein untersuchen', action: 'escape_dungeon', msg: 'Ein Geheimgang √∂ffnet sich zur K√ºche!' }]
            },
            'crypt': {
                name: 'Familiengruft',
                visual: '‚ö∞Ô∏è',
                desc: 'Hier ruhen die Ahnen. In einem offenen Sarkophag glitzert etwas Gr√ºnes. Um es zu nehmen, musst du ein R√§tsel l√∂sen.',
                exits: { S: 'dungeon' },
                puzzle: {
                    id: 'crypt_puzzle',
                    question: 'Caesar-Verschl√ºsselung: Wenn A=C und B=D ist... entschl√ºssle "KWTIG"', // KW TIG -> I AM HE (No, simple shift +2). K(10)-2=8(I), W(22)-2=20(T)... wait. Keep it simpler for game flow.
                    // Let's do simple ROT1: "HALLE" -> "IBMMF". 
                    // Let's do: "Das Passwort ist der Name des Gr√ºnders." (Info found in Scroll). Scroll says: "Vjre fbg nyyvrf orv anzra araara: Nyoerpug." (ROT13: Wer soll alles bei namen nennen: Albrecht).
                    question: 'Der Geist fl√ºstert: "Wie ist mein Name?" (Hinweis: Untersuche die Notiz von der Turmspitze. Nutze ROT13 - A wird zu N).',
                    answer: 'ALBRECHT',
                    reward: 'emerald',
                    solved: false
                }
            }
        };

        // --- ENGINE ---

        function init() {
            createSnow();
            // Initially items are not in inventory. Some are in rooms.
            // Silver key is missing? Let's hide it in the Great Hall but require a check.
            // Actually, let's put Silver Key in the Crypt puzzle? No, we need silver key to get to library.
            // Let's put Silver Key in a "Ghost Encounter" reward or hidden in Kitchen logic.
            // Let's put Silver Key in the Courtyard but only visible after visiting Great Hall.
            player.flags['saw_ghost'] = false;
        }

        function createSnow() {
            const container = document.getElementById('snow-container');
            for(let i=0; i<50; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.innerHTML = '‚ùÑ';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                flake.style.opacity = Math.random();
                container.appendChild(flake);
            }
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-ui').style.filter = 'none';
            document.getElementById('game-ui').style.opacity = '1';
            updateRoom();
            log("Das Abenteuer beginnt. Finde die drei Steine.", "info");
            
            // Give Crown Frame initially? No, find it.
            // Actually, finding the frame is step 1. Let's put it in throne room (static).
        }

        function log(msg, type='info') {
            const logArea = document.getElementById('game-log');
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerText = `> ${msg}`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateRoom() {
            const room = rooms[player.currentRoom];
            
            // Update Text
            document.getElementById('room-name').innerText = room.name;
            document.getElementById('room-visual').innerText = room.visual;
            document.getElementById('room-desc').innerText = room.desc;

            // Update Nav Buttons
            const dirs = { N:'n', S:'s', O:'o', W:'w' };
            for(let key in dirs) {
                const btn = document.getElementById(`btn-${dirs[key]}`);
                // Check if exit exists OR locked exit exists
                if(room.exits[key] || (room.lockedExits && room.lockedExits[key])) {
                    btn.disabled = false;
                } else {
                    btn.disabled = true;
                }
            }

            // Custom Interaction Buttons
            const actionArea = document.getElementById('interaction-area');
            actionArea.innerHTML = '';

            // Puzzle Button?
            if(room.puzzle && !room.puzzle.solved) {
                const btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.innerText = 'üß© R√§tsel l√∂sen';
                btn.onclick = () => triggerPuzzle(room.puzzle);
                actionArea.appendChild(btn);
            }

            // Specific Interactions
            if(room.interact) {
                room.interact.forEach(act => {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.innerText = `‚öôÔ∏è ${act.label}`;
                    btn.onclick = () => handleInteraction(act);
                    actionArea.appendChild(btn);
                });
            }

            renderInventory();
            checkGhostSpawn();
        }

        function move(dir) {
            const room = rooms[player.currentRoom];
            
            // Check locked exits first
            if (room.lockedExits && room.lockedExits[dir]) {
                const lock = room.lockedExits[dir];
                if (player.inventory.includes(lock.key)) {
                    log("Du schlie√üt die T√ºr auf.", "success");
                    player.currentRoom = room.exits[dir];
                    updateRoom();
                    return;
                } else {
                    log(lock.msg + " Dir fehlt der Schl√ºssel.", "danger");
                    return; // Stop movement
                }
            }

            if (room.exits[dir]) {
                player.currentRoom = room.exits[dir];
                updateRoom();
            } else if (dir === 'N' && room.exits['U']) { // Mapping U/D to N/S for dpad simplicity if needed, or stick to logic
                // For this UI, we only have N S E W. 
                // Let's map U (Up) to N logic contextually or add buttons? 
                // The D-PAD has 4 buttons. I should treat U/D as separate or map them.
                // Let's map U->N and D->S in tower/cellar contexts if standard exits don't exist?
                // Or better: Just check logic.
            }
            
            // Handle Up/Down mapping for the interface (hack for simple D-Pad)
            if (!room.exits[dir]) {
                if (dir === 'N' && room.exits['U']) { player.currentRoom = room.exits['U']; updateRoom(); return;}
                if (dir === 'S' && room.exits['D']) { player.currentRoom = room.exits['D']; updateRoom(); return;}
            }
        }

        function explore() {
            const room = rooms[player.currentRoom];
            
            // Ghost random trigger increase
            player.ghostAnger += 1;

            if (room.search) {
                if (!player.inventory.includes(room.search.item) && !player.flags[room.search.item + '_found']) {
                    player.inventory.push(room.search.item);
                    player.flags[room.search.item + '_found'] = true;
                    log(room.search.msg, "success");
                    showAlert("Gefunden!", room.search.msg);
                    renderInventory();
                } else {
                    log("Du findest nichts Neues.", "info");
                }
            } else {
                // Special case: Silver Key logic
                if (player.currentRoom === 'courtyard' && player.inventory.includes('rusty_key') && !player.inventory.includes('silver_key')) {
                    player.inventory.push('silver_key');
                    log("Im Schnee glitzert etwas: Der Silberschl√ºssel!", "success");
                    showAlert("Gefunden", "Der Silberschl√ºssel lag im tiefen Schnee.");
                    renderInventory();
                } else {
                    log("Nichts zu finden.", "info");
                }
            }
        }

        function handleInteraction(act) {
            if (act.action === 'escape_dungeon') {
                player.currentRoom = 'kitchen';
                log(act.msg, "success");
                updateRoom();
                return;
            }

            if (act.action === 'win_check') {
                const gems = ['ruby', 'sapphire', 'emerald'];
                const hasAll = gems.every(g => player.inventory.includes(g));
                if (hasAll) {
                    gameWin();
                } else {
                    showAlert("Die Krone ist unvollst√§ndig", "Du ben√∂tigst 3 Edelsteine: Rubin, Saphir und Smaragd.");
                }
                return;
            }

            if (act.req) {
                if (player.inventory.includes(act.req)) {
                    if (act.result === 'get_ruby' && !player.inventory.includes('ruby')) {
                        player.inventory.push('ruby');
                        log(act.msg, "success");
                        showAlert("Juwel erhalten", act.msg);
                        renderInventory();
                        updateGemCount();
                    }
                } else {
                    log("Dir fehlt das Werkzeug dazu.", "danger");
                }
            }
        }

        function triggerPuzzle(puzzle) {
            const answer = prompt(puzzle.question);
            if (answer && answer.toUpperCase().trim() === puzzle.answer) {
                puzzle.solved = true;
                player.inventory.push(puzzle.reward);
                log("R√§tsel gel√∂st! Du erh√§ltst: " + items[puzzle.reward].name, "success");
                showAlert("Richtig!", "Das Fach √∂ffnet sich. " + items[puzzle.reward].name + " geh√∂rt dir.");
                renderInventory();
                updateGemCount();
                updateRoom(); // hides button
            } else {
                log("Das war falsch. Ein kaltes Lachen ert√∂nt.", "danger");
                player.ghostAnger += 2;
                checkGhostSpawn(true); // force check
            }
        }

        // --- GHOST LOGIC ---

        let currentGhostRiddle = null;
        const ghostRiddles = [
            { q: "Je mehr du wegnimmst, desto gr√∂√üer werde ich. Was bin ich?", a: "LOCH", fail: "teleport" },
            { q: "Ich habe St√§dte, aber keine H√§user. Gebirge, aber keine B√§ume. Wasser, aber keine Fische. Was bin ich?", a: "LANDKARTE", fail: "steal" },
            { q: "Was geh√∂rt dir, aber andere benutzen es √∂fter als du?", a: "NAME", fail: "teleport" },
            { q: "1, 1, 2, 3, 5, 8... Welche Zahl folgt?", a: "13", fail: "steal" }
        ];

        function checkGhostSpawn(force = false) {
            const chance = (player.ghostAnger * 0.05) + (force ? 0.5 : 0);
            if (Math.random() < chance && player.currentRoom !== 'dungeon' && player.currentRoom !== 'crypt') {
                spawnGhost();
            }
        }

        function spawnGhost() {
            const riddle = ghostRiddles[Math.floor(Math.random() * ghostRiddles.length)];
            currentGhostRiddle = riddle;
            
            document.getElementById('ghost-riddle-text').innerText = riddle.q;
            document.getElementById('ghost-modal').style.display = 'flex';
            document.getElementById('ghost-answer').value = '';
            document.getElementById('ghost-answer').focus();
        }

        function submitGhostAnswer() {
            const input = document.getElementById('ghost-answer').value.toUpperCase().trim();
            document.getElementById('ghost-modal').style.display = 'none';
            
            if (input === currentGhostRiddle.a) {
                log("Der Geist nickt respektvoll und verschwindet.", "success");
                player.ghostAnger = 0;
            } else {
                log("FALSCH! Der Geist schreit auf!", "danger");
                applyGhostPenalty(currentGhostRiddle.fail);
            }
        }

        function applyGhostPenalty(type) {
            if (type === 'teleport') {
                log("Alles dreht sich... Du wachst im Verlies auf.", "danger");
                player.currentRoom = 'dungeon';
                updateRoom();
            } else if (type === 'steal') {
                if (player.inventory.length > 0) {
                    const stolenItem = player.inventory.pop();
                    log(`Der Geist hat dir ${items[stolenItem].name} gestohlen! Er hat es in der K√ºche versteckt.`, "danger");
                    // Hardcode simplified return logic: put it back in kitchen search or just reset flag?
                    // For simplicity in this demo: It goes to 'kitchen' specifically as a searchable.
                    rooms['kitchen'].search = { item: stolenItem, chance: 1.0, msg: `Du findest dein ${items[stolenItem].name} im M√ºll wieder.` };
                    player.flags[stolenItem + '_found'] = false; // allow finding it again
                    renderInventory();
                } else {
                    log("Du hast nichts zu stehlen, also wirft dich der Geist ins Verlies.", "danger");
                    player.currentRoom = 'dungeon';
                    updateRoom();
                }
            }
        }

        // --- UI HELPERS ---

        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '';
            player.inventory.forEach(itemId => {
                const item = items[itemId];
                const div = document.createElement('div');
                div.className = 'inv-item filled';
                div.innerHTML = `${item.icon}<span>${item.name}</span>`;
                div.title = item.desc;
                div.onclick = () => showAlert(item.name, item.desc);
                grid.appendChild(div);
            });
            
            // Fill empty slots
            const emptySlots = 8 - player.inventory.length;
            for(let i=0; i<Math.max(0, emptySlots); i++) {
                const div = document.createElement('div');
                div.className = 'inv-item';
                grid.appendChild(div);
            }
        }

        function updateGemCount() {
            const count = player.inventory.filter(i => items[i].type === 'gem').length;
            document.getElementById('gem-count').innerText = `${count}/3`;
        }

        function showAlert(title, text) {
            document.getElementById('msg-title').innerText = title;
            document.getElementById('msg-text').innerText = text;
            document.getElementById('msg-modal').style.display = 'flex';
        }

        function gameWin() {
            document.body.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; background:#000; color:#gold;">
                    <h1 style="color:#b8860b; font-family:'Cinzel'; font-size:4em;">FLUCH GEBROCHEN</h1>
                    <p style="color:white; font-size:1.5em; max-width:600px; text-align:center;">
                        Du hast die Winterkrone wiederhergestellt. Der Geist von Albrecht findet endlich Frieden.
                        Der Schnee drau√üen glitzert friedlich im Mondlicht.
                    </p>
                    <br>
                    <button onclick="location.reload()" style="padding:20px; font-size:1.2em;">Noch einmal spielen</button>
                </div>
            `;
        }

        // Initialize
        init();

    </script>
</body>
</html>
