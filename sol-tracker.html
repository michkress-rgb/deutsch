<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL Progress Tracker | A-Level German</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-screen {
            background: white;
            max-width: 500px;
            margin: 100px auto;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .login-screen h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-screen p {
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .error-message {
            color: #e74c3c;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        /* Main Dashboard */
        .main-dashboard {
            display: none;
        }

        .dashboard-header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .user-info p {
            color: #666;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* Progress Bar */
        .progress-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .progress-bar-bg {
            background: #ecf0f1;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Badges Section */
        .badges-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .badges-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .badge {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            transition: transform 0.3s;
        }

        .badge.earned {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            transform: scale(1.05);
        }

        .badge.locked {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .badge-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .badge-name {
            font-weight: bold;
            font-size: 0.9em;
            color: #333;
        }

        .badge-desc {
            font-size: 0.75em;
            color: #666;
            margin-top: 5px;
        }

        /* Time Tracker */
        .time-tracker {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .time-tracker h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .timer-display {
            text-align: center;
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            font-family: monospace;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn-timer {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-start {
            background: #27ae60;
            color: white;
        }

        .btn-start:hover {
            background: #229954;
        }

        .btn-pause {
            background: #f39c12;
            color: white;
        }

        .btn-pause:hover {
            background: #e67e22;
        }

        .btn-stop {
            background: #e74c3c;
            color: white;
        }

        .btn-stop:hover {
            background: #c0392b;
        }

        .session-log {
            margin-top: 20px;
        }

        .session-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Tasks Section */
        .tasks-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tasks-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .task-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .task-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .task-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            transition: all 0.3s;
        }

        .task-item.completed {
            opacity: 0.6;
            background: #d4edda;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .task-desc {
            color: #666;
            font-size: 0.9em;
        }

        .task-week {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            display: inline-block;
            margin-top: 5px;
        }

        /* Journal Section */
        .journal-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .journal-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .journal-input {
            margin-bottom: 20px;
        }

        .journal-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
        }

        .journal-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .journal-entries {
            margin-top: 20px;
        }

        .journal-entry {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .journal-date {
            color: #999;
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        .journal-text {
            color: #333;
            line-height: 1.6;
        }

        .journal-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .tag.success {
            background: #27ae60;
        }

        .tag.problem {
            background: #e74c3c;
        }

        .tag.help {
            background: #f39c12;
        }

        /* Charts */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        canvas {
            max-width: 100%;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <h1>üéØ SOL Progress Tracker</h1>
            <p>Track your journey to an A-grade</p>
            
            <div class="form-group">
                <label for="userSelect">Select Your Account</label>
                <select id="userSelect">
                    <option value="">Choose your account...</option>
                    <option value="user001">User 001</option>
                    <option value="user002">User 002</option>
                    <option value="user003">User 003</option>
                    <option value="user004">User 004</option>
                    <option value="user005">User 005</option>
                    <option value="user006">User 006</option>
                    <option value="teacher">Teacher View</option>
                </select>
            </div>

            <div class="form-group">
                <label for="passwordInput">Password</label>
                <input type="password" id="passwordInput" placeholder="Enter your password">
            </div>

            <button class="btn" onclick="login()">Login</button>

            <div id="loginError" class="error-message">
                Incorrect password. Please try again.
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="mainDashboard" class="main-dashboard">
            <!-- Header -->
            <div class="dashboard-header">
                <div class="user-info">
                    <h1 id="welcomeMessage">Welcome back!</h1>
                    <p id="userSubtitle">Let's continue your learning journey</p>
                </div>
                <div class="header-actions">
                    <button class="btn-secondary" onclick="exportData()">üìä Export Data</button>
                    <button class="btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="totalHours">0</div>
                    <div class="stat-label">Total Hours Studied</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="completedTasks">0</div>
                    <div class="stat-label">Tasks Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-value" id="currentStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéñÔ∏è</div>
                    <div class="stat-value" id="badgesEarned">0</div>
                    <div class="stat-label">Badges Earned</div>
                </div>
            </div>

            <!-- Progress to A-Grade -->
            <div class="progress-container">
                <div class="progress-header">
                    <h2>üìà Progress to A-Grade</h2>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%">
                        <span id="progressText"></span>
                    </div>
                </div>
            </div>

            <!-- Badges -->
            <div class="badges-section">
                <h2>üèÜ Achievement Badges</h2>
                <div class="badges-grid" id="badgesGrid"></div>
            </div>

            <!-- Time Tracker -->
            <div class="time-tracker">
                <h2>‚è±Ô∏è Study Session Timer</h2>
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="btn-timer btn-start" id="startBtn" onclick="startTimer()">Start</button>
                    <button class="btn-timer btn-pause" id="pauseBtn" onclick="pauseTimer()" style="display: none;">Pause</button>
                    <button class="btn-timer btn-stop" id="stopBtn" onclick="stopTimer()" style="display: none;">Save Session</button>
                </div>
                <div class="session-log" id="sessionLog"></div>
            </div>

            <!-- Tasks -->
            <div class="tasks-section">
                <h2>üìù Your Weekly Tasks</h2>
                <div class="task-tabs">
                    <button class="tab active" onclick="switchTab('daily')">Daily (25 min)</button>
                    <button class="tab" onclick="switchTab('weekly')">Weekly Tasks</button>
                    <button class="tab" onclick="switchTab('specimen')">Specimen Papers</button>
                </div>
                <div class="task-list" id="taskList"></div>
            </div>

            <!-- Journal -->
            <div class="journal-section">
                <h2>üìî Learning Journal</h2>
                <p style="color: #666; margin-bottom: 15px;">
                    Share your progress, challenges, and wins. Your teacher will see these updates.
                </p>
                <div class="journal-input">
                    <textarea 
                        id="journalText" 
                        class="journal-textarea" 
                        placeholder="What did you work on today? What went well? What do you need help with?"
                    ></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 10px;">
                            <label style="color: #666;">
                                <input type="checkbox" id="tagSuccess"> ‚úÖ Success
                            </label>
                            <label style="color: #666;">
                                <input type="checkbox" id="tagProblem"> ‚ùå Problem
                            </label>
                            <label style="color: #666;">
                                <input type="checkbox" id="tagHelp"> üÜò Need Help
                            </label>
                        </div>
                        <button class="btn" onclick="saveJournalEntry()">Save Entry</button>
                    </div>
                </div>
                <div class="journal-entries" id="journalEntries"></div>
            </div>

            <!-- Charts -->
            <div class="charts-section">
                <div class="chart-container">
                    <h3>üìä Weekly Study Time</h3>
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>üìà Task Completion Rate</h3>
                    <canvas id="taskChart"></canvas>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading your data...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // TODO: Replace with your Firebase config
        const firebaseConfig = {
    apiKey: "AIzaSyDXEMGKw3g24o0a-fkrD7ywk_MOuTtZJeY",
    authDomain: "isn-movember.firebaseapp.com",
    databaseURL: "https://isn-movember-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "isn-movember",
    storageBucket: "isn-movember.firebasestorage.app",
    messagingSenderId: "397597913187",
    appId: "1:397597913187:web:333e00f47ee6414f348856"
};

        // Initialize Firebase
        let database;
        let currentUser = null;
        let timerInterval = null;
        let timerSeconds = 0;
        let timerRunning = false;

        function startApp() {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('‚úÖ Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Error connecting to database. Please check your Firebase configuration.');
            }
        }

        // Start the app
        startApp();

        // ============================================
        // USER DATA & AUTHENTICATION
        // ============================================
        const USERS = {
            'user001': {
                password: 'finn2025',
                name: 'User 001',
                studentName: 'Finn',
                plan: 'structured'
            },
            'user002': {
                password: 'ayca2025',
                name: 'User 002',
                studentName: 'Ayca',
                plan: 'turkish-german'
            },
            'user003': {
                password: 'raffaele2025',
                name: 'User 003',
                studentName: 'Raffaele',
                plan: 'law-economics'
            },
            'user004': {
                password: 'max2025',
                name: 'User 004',
                studentName: 'Max',
                plan: 'accountability'
            },
            'user005': {
                password: 'moritz2025',
                name: 'User 005',
                studentName: 'Moritz',
                plan: 'native-speaker'
            },
            'user006': {
                password: 'emilia2025',
                name: 'User 006',
                studentName: 'Emilia',
                plan: 'philosophical'
            },
            'teacher': {
                password: 'teacher2025',
                name: 'Teacher',
                isTeacher: true
            }
        };

        // ============================================
        // BADGES SYSTEM
        // ============================================
        const BADGES = [
            {
                id: 'first-session',
                icon: 'üéØ',
                name: 'Getting Started',
                description: 'Complete your first study session',
                requirement: (stats) => stats.totalSessions >= 1
            },
            {
                id: 'five-hours',
                icon: '‚è∞',
                name: 'Time Master',
                description: 'Study for 5 hours total',
                requirement: (stats) => stats.totalMinutes >= 300
            },
            {
                id: 'week-streak',
                icon: 'üî•',
                name: 'Week Warrior',
                description: 'Study for 7 days in a row',
                requirement: (stats) => stats.currentStreak >= 7
            },
            {
                id: 'task-completionist',
                icon: '‚úÖ',
                name: 'Task Master',
                description: 'Complete 20 tasks',
                requirement: (stats) => stats.completedTasks >= 20
            },
            {
                id: 'daily-routine',
                icon: 'üìÖ',
                name: 'Daily Disciplin',
                description: 'Complete daily routine 10 times',
                requirement: (stats) => stats.dailyCompletions >= 10
            },
            {
                id: 'specimen-warrior',
                icon: 'üìù',
                name: 'Exam Ready',
                description: 'Complete 3 specimen papers',
                requirement: (stats) => stats.specimenPapers >= 3
            },
            {
                id: 'journal-keeper',
                icon: 'üìî',
                name: 'Reflective Learner',
                description: 'Write 15 journal entries',
                requirement: (stats) => stats.journalEntries >= 15
            },
            {
                id: 'marathon',
                icon: 'üèÉ',
                name: 'Marathon Runner',
                description: 'Study for 20 hours total',
                requirement: (stats) => stats.totalMinutes >= 1200
            },
            {
                id: 'perfectionist',
                icon: 'üíØ',
                name: 'Perfectionist',
                description: 'Complete all weekly tasks 3 weeks in a row',
                requirement: (stats) => stats.perfectWeeks >= 3
            },
            {
                id: 'a-grade-ready',
                icon: 'üéì',
                name: 'A-Grade Ready',
                description: 'Reach 80% overall progress',
                requirement: (stats) => stats.overallProgress >= 80
            }
        ];

        // ============================================
        // TASK TEMPLATES BY STUDENT TYPE
        // ============================================
        const TASK_TEMPLATES = {
            'structured': {
                daily: [
                    { title: 'Vocabulary Practice', desc: '15 minutes with flashcards', minutes: 15 },
                    { title: 'Grammar Exercise', desc: '10 minutes focused practice', minutes: 10 }
                ],
                weekly: [
                    { title: 'Essay Practice', desc: 'Paper 2 style essay (300-400 words)', week: 'Week 1-11' },
                    { title: 'Reading Comprehension', desc: 'Paper 1 text with questions', week: 'Week 1-11' },
                    { title: 'Listening Practice', desc: 'Paper 3 listening exercises', week: 'Week 1-11' }
                ],
                specimen: [
                    { title: 'Specimen Paper 1', desc: 'Complete under time conditions', week: 'Week 2' },
                    { title: 'Specimen Paper 2', desc: 'Complete under time conditions', week: 'Week 4' },
                    { title: 'Specimen Paper 3', desc: 'Complete under time conditions', week: 'Week 6' }
                ]
            },
            'turkish-german': {
                daily: [
                    { title: 'Turkish-German Vocabulary', desc: '10 minutes with translator', minutes: 10 },
                    { title: 'Grammar Focus', desc: '15-20 minutes practice', minutes: 15 }
                ],
                weekly: [
                    { title: 'Vocabulary Trainer', desc: 'Complete daily vocabulary sets', week: 'Week 1-11' },
                    { title: 'Essay Writing', desc: 'One essay per week (250-300 words)', week: 'Week 1-11' },
                    { title: 'Reading Practice', desc: 'Read and analyze German texts', week: 'Week 1-11' }
                ],
                specimen: [
                    { title: 'Mock Exam - Paper 1', desc: 'Reading comprehension', week: 'Week 3' },
                    { title: 'Mock Exam - Paper 2', desc: 'Essay writing', week: 'Week 5' },
                    { title: 'Mock Exam - Paper 3', desc: 'Listening', week: 'Week 7' }
                ]
            },
            'law-economics': {
                daily: [
                    { title: 'Specialized Vocabulary', desc: 'Law & Economics terms', minutes: 20 },
                    { title: 'Essay Planning', desc: 'Structure practice', minutes: 15 }
                ],
                weekly: [
                    { title: 'Thematic Essay', desc: 'Law, politics, or economics topic', week: 'Week 1-11' },
                    { title: 'Vocabulary Mastery', desc: 'Focus on specialized terminology', week: 'Week 1-11' },
                    { title: 'Literature Analysis', desc: 'Analyze texts with critical lens', week: 'Week 1-11' }
                ],
                specimen: [
                    { title: 'Specimen Paper - Full Set', desc: 'All papers under exam conditions', week: 'Week 4' },
                    { title: 'Second Mock Exam', desc: 'Complete all papers', week: 'Week 8' }
                ]
            },
            'accountability': {
                daily: [
                    { title: 'Grammar Review', desc: '15 minutes targeted practice', minutes: 15 },
                    { title: 'Vocabulary Building', desc: '10 minutes new words', minutes: 10 }
                ],
                weekly: [
                    { title: 'Intellectual Essay', desc: 'Controversial topic analysis', week: 'Week 1-11' },
                    { title: 'Text Analysis', desc: 'Critical reading and response', week: 'Week 1-11' },
                    { title: 'Debate Preparation', desc: 'Prepare arguments pro/contra', week: 'Week 1-11' }
                ],
                specimen: [
                    { title: 'Specimen Paper 1', desc: 'Monday deadline - no extensions', week: 'Week 2' },
                    { title: 'Specimen Paper 2', desc: 'Monday deadline - no extensions', week: 'Week 5' },
                    { title: 'Specimen Paper 3', desc: 'Monday deadline - no extensions', week: 'Week 8' }
                ]
            },
            'native-speaker': {
                daily: [
                    { title: 'Essay Structure Practice', desc: '15 minutes thesis & arguments', minutes: 15 }
                ],
                weekly: [
                    { title: 'Formal Essay', desc: 'Cambridge-style argumentative essay', week: 'Week 1-11' },
                    { title: 'Literature Analysis', desc: 'Analyze German literary texts', week: 'Week 1-11' },
                    { title: 'Writing Workshop', desc: 'Practice thesis statements', week: 'Week 1-11' }
                ],
                specimen: [
                    { title: 'Mock Paper 1', desc: 'Focus on formal writing', week: 'Week 3' },
                    { title: 'Mock Paper 2', desc: 'Essay under time pressure', week: 'Week 6' },
                    { title: 'Mock Paper 3', desc: 'Complete exam simulation', week: 'Week 9' }
                ]
            },
            'philosophical': {
                daily: [
                    { title: 'Philosophical Vocabulary', desc: '15 minutes key concepts', minutes: 15 },
                    { title: 'Critical Reading', desc: '20 minutes text analysis', minutes: 20 }
                ],
                weekly: [
                    { title: 'Philosophical Essay', desc: 'Deep analysis of themes', week: 'Week 1-11' },
                    { title: 'Literature Study', desc: 'Focus on Ansichten eines Clowns', week: 'Week 1-11' },
                    { title: 'Mind Mapping', desc: 'Connect ideas and themes', week: 'Week 1-11' }
                ],
                specimen: [
                    { title: 'Mock Exam Set 1', desc: 'All papers', week: 'Week 4' },
                    { title: 'Mock Exam Set 2', desc: 'All papers with feedback', week: 'Week 8' }
                ]
            }
        };

        // ============================================
        // LOGIN / LOGOUT
        // ============================================
        function login() {
            const userId = document.getElementById('userSelect').value;
            const password = document.getElementById('passwordInput').value;

            if (!userId) {
                alert('Please select an account');
                return;
            }

            const user = USERS[userId];
            if (user && user.password === password) {
                currentUser = { id: userId, ...user };
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainDashboard').style.display = 'block';
                
                if (user.isTeacher) {
                    loadTeacherView();
                } else {
                    loadStudentDashboard();
                }
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                stopTimer();
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainDashboard').style.display = 'none';
                document.getElementById('passwordInput').value = '';
                document.getElementById('userSelect').value = '';
                document.getElementById('loginError').style.display = 'none';
            }
        }

        // ============================================
        // LOAD STUDENT DASHBOARD
        // ============================================
        function loadStudentDashboard() {
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.name}!`;
            document.getElementById('userSubtitle').textContent = `Cambridge A Level German | ${currentUser.studentName}'s Progress`;

            loadUserStats();
            loadBadges();
            loadTasks();
            loadJournalEntries();
            loadCharts();
        }

        // ============================================
        // LOAD USER STATS
        // ============================================
        function loadUserStats() {
            const userId = currentUser.id;
            
            // Listen to real-time updates
            database.ref(`users/${userId}/stats`).on('value', (snapshot) => {
                const stats = snapshot.val() || {
                    totalMinutes: 0,
                    completedTasks: 0,
                    currentStreak: 0,
                    earnedBadges: []
                };

                const totalHours = Math.floor(stats.totalMinutes / 60);
                document.getElementById('totalHours').textContent = totalHours;
                document.getElementById('completedTasks').textContent = stats.completedTasks || 0;
                document.getElementById('currentStreak').textContent = stats.currentStreak || 0;
                document.getElementById('badgesEarned').textContent = (stats.earnedBadges || []).length;

                // Calculate progress
                const progress = calculateProgress(stats);
                updateProgressBar(progress);

                // Check for new badges
                checkBadges(stats);
            });

            // Load sessions
            loadSessions();
        }

        function calculateProgress(stats) {
            const targetHours = 40; // Target for A-grade
            const hoursCompleted = (stats.totalMinutes || 0) / 60;
            const percentTime = Math.min((hoursCompleted / targetHours) * 50, 50);
            
            const targetTasks = 50;
            const percentTasks = Math.min(((stats.completedTasks || 0) / targetTasks) * 30, 30);
            
            const targetStreak = 30;
            const percentStreak = Math.min(((stats.currentStreak || 0) / targetStreak) * 20, 20);
            
            return Math.round(percentTime + percentTasks + percentStreak);
        }

        function updateProgressBar(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
        }

        // ============================================
        // BADGES
        // ============================================
        function loadBadges() {
            const grid = document.getElementById('badgesGrid');
            grid.innerHTML = '';

            database.ref(`users/${currentUser.id}/stats`).once('value', (snapshot) => {
                const stats = snapshot.val() || {};
                const earnedBadges = stats.earnedBadges || [];

                BADGES.forEach(badge => {
                    const isEarned = earnedBadges.includes(badge.id);
                    const badgeEl = document.createElement('div');
                    badgeEl.className = `badge ${isEarned ? 'earned' : 'locked'}`;
                    badgeEl.innerHTML = `
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-desc">${badge.description}</div>
                    `;
                    grid.appendChild(badgeEl);
                });
            });
        }

        function checkBadges(stats) {
            const earnedBadges = stats.earnedBadges || [];
            const newBadges = [];

            BADGES.forEach(badge => {
                if (!earnedBadges.includes(badge.id) && badge.requirement(stats)) {
                    newBadges.push(badge.id);
                    showBadgeNotification(badge);
                }
            });

            if (newBadges.length > 0) {
                const updatedBadges = [...earnedBadges, ...newBadges];
                database.ref(`users/${currentUser.id}/stats/earnedBadges`).set(updatedBadges);
            }
        }

        function showBadgeNotification(badge) {
            alert(`üéâ New Badge Earned!\n\n${badge.icon} ${badge.name}\n${badge.description}`);
            loadBadges(); // Refresh badges display
        }

        // ============================================
        // TIMER
        // ============================================
        function startTimer() {
            timerRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'inline-block';

            timerInterval = setInterval(() => {
                timerSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
            document.getElementById('pauseBtn').textContent = 'Resume';
            document.getElementById('pauseBtn').onclick = resumeTimer;
        }

        function resumeTimer() {
            timerRunning = true;
            document.getElementById('pauseBtn').textContent = 'Pause';
            document.getElementById('pauseBtn').onclick = pauseTimer;
            
            timerInterval = setInterval(() => {
                timerSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            if (timerSeconds < 60) {
                alert('Session too short! Please study for at least 1 minute.');
                return;
            }

            clearInterval(timerInterval);
            
            const minutes = Math.floor(timerSeconds / 60);
            const sessionData = {
                date: new Date().toISOString(),
                minutes: minutes,
                timestamp: Date.now()
            };

            // Save to Firebase
            database.ref(`users/${currentUser.id}/sessions`).push(sessionData);

            // Update total minutes
            database.ref(`users/${currentUser.id}/stats/totalMinutes`).transaction((current) => {
                return (current || 0) + minutes;
            });

            // Update streak
            updateStreak();

            alert(`‚úÖ Session saved!\n${minutes} minutes logged.`);
            
            resetTimer();
        }

        function resetTimer() {
            timerSeconds = 0;
            timerRunning = false;
            clearInterval(timerInterval);
            updateTimerDisplay();
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('pauseBtn').textContent = 'Pause';
            document.getElementById('pauseBtn').onclick = pauseTimer;
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timerSeconds / 3600);
            const minutes = Math.floor((timerSeconds % 3600) / 60);
            const seconds = timerSeconds % 60;
            
            const display = 
                String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');
            
            document.getElementById('timerDisplay').textContent = display;
        }

        function loadSessions() {
            database.ref(`users/${currentUser.id}/sessions`).limitToLast(5).on('value', (snapshot) => {
                const sessions = [];
                snapshot.forEach((child) => {
                    sessions.push({ id: child.key, ...child.val() });
                });

                const logContainer = document.getElementById('sessionLog');
                if (sessions.length === 0) {
                    logContainer.innerHTML = '<p style="color: #999; text-align: center;">No study sessions yet. Start your first one!</p>';
                    return;
                }

                sessions.reverse();
                logContainer.innerHTML = '<h3 style="color: #667eea; margin-bottom: 15px;">Recent Sessions</h3>';
                sessions.forEach(session => {
                    const date = new Date(session.date);
                    const dateStr = date.toLocaleDateString('en-GB', { 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const item = document.createElement('div');
                    item.className = 'session-item';
                    item.innerHTML = `
                        <div>
                            <div style="font-weight: bold; color: #333;">${session.minutes} minutes</div>
                            <div style="font-size: 0.85em; color: #999;">${dateStr}</div>
                        </div>
                        <div style="font-size: 1.5em;">‚è±Ô∏è</div>
                    `;
                    logContainer.appendChild(item);
                });
            });
        }

        function updateStreak() {
            const today = new Date().toDateString();
            
            database.ref(`users/${currentUser.id}/lastStudyDate`).once('value', (snapshot) => {
                const lastDate = snapshot.val();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (!lastDate || lastDate === today) {
                    // Same day or first time
                    database.ref(`users/${currentUser.id}/lastStudyDate`).set(today);
                } else if (lastDate === yesterday.toDateString()) {
                    // Consecutive day
                    database.ref(`users/${currentUser.id}/stats/currentStreak`).transaction((current) => {
                        return (current || 0) + 1;
                    });
                    database.ref(`users/${currentUser.id}/lastStudyDate`).set(today);
                } else {
                    // Streak broken
                    database.ref(`users/${currentUser.id}/stats/currentStreak`).set(1);
                    database.ref(`users/${currentUser.id}/lastStudyDate`).set(today);
                }
            });
        }

        // ============================================
        // TASKS
        // ============================================
        let currentTaskTab = 'daily';

        function switchTab(tab) {
            currentTaskTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadTasks();
        }

        function loadTasks() {
            const planType = currentUser.plan;
            const tasks = TASK_TEMPLATES[planType][currentTaskTab];
            const taskList = document.getElementById('taskList');
            
            taskList.innerHTML = '';

            if (!tasks || tasks.length === 0) {
                taskList.innerHTML = '<p style="color: #999; text-align: center;">No tasks in this category.</p>';
                return;
            }

            database.ref(`users/${currentUser.id}/tasks/${currentTaskTab}`).once('value', (snapshot) => {
                const completedTasks = snapshot.val() || {};

                tasks.forEach((task, index) => {
                    const taskId = `${currentTaskTab}-${index}`;
                    const isCompleted = completedTasks[taskId] || false;

                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item ${isCompleted ? 'completed' : ''}`;
                    taskItem.innerHTML = `
                        <input 
                            type="checkbox" 
                            class="task-checkbox" 
                            ${isCompleted ? 'checked' : ''}
                            onchange="toggleTask('${currentTaskTab}', '${taskId}', this.checked)"
                        >
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                            <div class="task-desc">${task.desc}</div>
                            ${task.week ? `<span class="task-week">${task.week}</span>` : ''}
                            ${task.minutes ? `<span class="task-week">${task.minutes} min</span>` : ''}
                        </div>
                    `;
                    taskList.appendChild(taskItem);
                });
            });
        }

        function toggleTask(category, taskId, completed) {
            database.ref(`users/${currentUser.id}/tasks/${category}/${taskId}`).set(completed);

            if (completed) {
                database.ref(`users/${currentUser.id}/stats/completedTasks`).transaction((current) => {
                    return (current || 0) + 1;
                });
            } else {
                database.ref(`users/${currentUser.id}/stats/completedTasks`).transaction((current) => {
                    return Math.max((current || 0) - 1, 0);
                });
            }

            loadTasks();
        }

        // ============================================
        // JOURNAL
        // ============================================
        function saveJournalEntry() {
            const text = document.getElementById('journalText').value.trim();
            
            if (!text) {
                alert('Please write something in your journal.');
                return;
            }

            const tags = [];
            if (document.getElementById('tagSuccess').checked) tags.push('success');
            if (document.getElementById('tagProblem').checked) tags.push('problem');
            if (document.getElementById('tagHelp').checked) tags.push('help');

            const entry = {
                text: text,
                tags: tags,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };

            database.ref(`users/${currentUser.id}/journal`).push(entry);

            // Update journal count
            database.ref(`users/${currentUser.id}/stats/journalEntries`).transaction((current) => {
                return (current || 0) + 1;
            });

            // Clear form
            document.getElementById('journalText').value = '';
            document.getElementById('tagSuccess').checked = false;
            document.getElementById('tagProblem').checked = false;
            document.getElementById('tagHelp').checked = false;

            alert('‚úÖ Journal entry saved!');
            loadJournalEntries();
        }

        function loadJournalEntries() {
            database.ref(`users/${currentUser.id}/journal`).limitToLast(10).on('value', (snapshot) => {
                const entries = [];
                snapshot.forEach((child) => {
                    entries.push({ id: child.key, ...child.val() });
                });

                const container = document.getElementById('journalEntries');
                
                if (entries.length === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center;">No journal entries yet. Start reflecting on your learning!</p>';
                    return;
                }

                container.innerHTML = '<h3 style="color: #667eea; margin-bottom: 15px;">Recent Entries</h3>';
                
                entries.reverse().forEach(entry => {
                    const date = new Date(entry.date);
                    const dateStr = date.toLocaleDateString('en-GB', { 
                        weekday: 'short',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const entryEl = document.createElement('div');
                    entryEl.className = 'journal-entry';
                    
                    let tagsHTML = '';
                    if (entry.tags && entry.tags.length > 0) {
                        tagsHTML = '<div class="journal-tags">';
                        entry.tags.forEach(tag => {
                            tagsHTML += `<span class="tag ${tag}">${
                                tag === 'success' ? '‚úÖ Success' :
                                tag === 'problem' ? '‚ùå Problem' :
                                'üÜò Need Help'
                            }</span>`;
                        });
                        tagsHTML += '</div>';
                    }

                    entryEl.innerHTML = `
                        <div class="journal-date">${dateStr}</div>
                        <div class="journal-text">${entry.text}</div>
                        ${tagsHTML}
                    `;
                    container.appendChild(entryEl);
                });
            });
        }

        // ============================================
        // CHARTS
        // ============================================
        let weeklyChart = null;
        let taskChart = null;

        function loadCharts() {
            // Weekly Study Time Chart
            database.ref(`users/${currentUser.id}/sessions`).once('value', (snapshot) => {
                const sessions = [];
                snapshot.forEach((child) => {
                    sessions.push(child.val());
                });

                const last7Days = [];
                const today = new Date();
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toISOString().split('T')[0]);
                }

                const dailyMinutes = {};
                last7Days.forEach(day => dailyMinutes[day] = 0);

                sessions.forEach(session => {
                    const date = session.date.split('T')[0];
                    if (dailyMinutes.hasOwnProperty(date)) {
                        dailyMinutes[date] += session.minutes || 0;
                    }
                });

                const labels = last7Days.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
                });

                const data = last7Days.map(date => dailyMinutes[date]);

                if (weeklyChart) weeklyChart.destroy();
                
                const ctx = document.getElementById('weeklyChart').getContext('2d');
                weeklyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Minutes Studied',
                            data: data,
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' min';
                                    }
                                }
                            }
                        }
                    }
                });
            });

            // Task Completion Chart
            database.ref(`users/${currentUser.id}/tasks`).once('value', (snapshot) => {
                const tasks = snapshot.val() || {};
                
                let totalDaily = 0, completedDaily = 0;
                let totalWeekly = 0, completedWeekly = 0;
                let totalSpecimen = 0, completedSpecimen = 0;

                const planType = currentUser.plan;
                const templates = TASK_TEMPLATES[planType];

                if (templates.daily) totalDaily = templates.daily.length;
                if (templates.weekly) totalWeekly = templates.weekly.length;
                if (templates.specimen) totalSpecimen = templates.specimen.length;

                if (tasks.daily) {
                    completedDaily = Object.values(tasks.daily).filter(v => v).length;
                }
                if (tasks.weekly) {
                    completedWeekly = Object.values(tasks.weekly).filter(v => v).length;
                }
                if (tasks.specimen) {
                    completedSpecimen = Object.values(tasks.specimen).filter(v => v).length;
                }

                if (taskChart) taskChart.destroy();

                const ctx = document.getElementById('taskChart').getContext('2d');
                taskChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Daily', 'Weekly', 'Specimen'],
                        datasets: [{
                            label: 'Tasks Completed',
                            data: [
                                totalDaily > 0 ? (completedDaily / totalDaily * 100) : 0,
                                totalWeekly > 0 ? (completedWeekly / totalWeekly * 100) : 0,
                                totalSpecimen > 0 ? (completedSpecimen / totalSpecimen * 100) : 0
                            ],
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(39, 174, 96, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + Math.round(context.parsed) + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        // ============================================
        // DATA EXPORT
        // ============================================
        function exportData() {
            const userId = currentUser.id;
            
            database.ref(`users/${userId}`).once('value', (snapshot) => {
                const data = snapshot.val();
                
                const exportData = {
                    user: currentUser.name,
                    studentName: currentUser.studentName,
                    exportDate: new Date().toISOString(),
                    stats: data.stats || {},
                    sessions: data.sessions || {},
                    tasks: data.tasks || {},
                    journal: data.journal || {}
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `SOL_Progress_${currentUser.studentName}_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Data exported successfully!');
            });
        }

        // ============================================
        // TEACHER VIEW
        // ============================================
        function loadTeacherView() {
            document.getElementById('welcomeMessage').textContent = 'Teacher Dashboard';
            document.getElementById('userSubtitle').textContent = 'Overview of All Students';

            // This would load an overview of all students
            // Implementation would show all student stats, journals, etc.
            // For brevity, showing placeholder
            const dashboard = document.getElementById('mainDashboard');
            dashboard.innerHTML = `
                <div class="dashboard-header">
                    <div class="user-info">
                        <h1>Teacher Dashboard</h1>
                        <p>Monitor all student progress</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="logout()">Logout</button>
                    </div>
                </div>
                <div style="background: white; padding: 40px; border-radius: 20px; text-align: center;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">Student Overview</h2>
                    <p style="color: #666;">Teacher view showing all student progress, journal entries, and statistics.</p>
                    <p style="color: #666; margin-top: 20px;"><em>This section would display aggregated data from all students.</em></p>
                </div>
            `;
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter to save journal
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                if (document.getElementById('journalText') === document.activeElement) {
                    saveJournalEntry();
                }
            }
        });

        // Make functions global
        window.login = login;
        window.logout = logout;
        window.startTimer = startTimer;
        window.pauseTimer = pauseTimer;
        window.stopTimer = stopTimer;
        window.switchTab = switchTab;
        window.toggleTask = toggleTask;
        window.saveJournalEntry = saveJournalEntry;
        window.exportData = exportData;
    </script>
</body>
</html>
